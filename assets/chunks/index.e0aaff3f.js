import{i as gt,B as Xt,U as Hr,av as jr,N as zr,w as $r,E as Kr}from"./basePlugin.abae66f6.js";function Yr(n,s){var e=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(e!=null){var t,r,i,a,o=[],u=!0,l=!1;try{if(i=(e=e.call(n)).next,s===0){if(Object(e)!==e)return;u=!1}else for(;!(u=(t=i.call(e)).done)&&(o.push(t.value),o.length!==s);u=!0);}catch(c){l=!0,r=c}finally{try{if(!u&&e.return!=null&&(a=e.return(),Object(a)!==a))return}finally{if(l)throw r}}return o}}function Qt(n,s){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(n);s&&(t=t.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,t)}return e}function J(n){for(var s=1;s<arguments.length;s++){var e=arguments[s]!=null?arguments[s]:{};s%2?Qt(Object(e),!0).forEach(function(t){S(n,t,e[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Qt(Object(e)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(e,t))})}return n}function M(){M=function(){return n};var n={},s=Object.prototype,e=s.hasOwnProperty,t=Object.defineProperty||function(p,g,_){p[g]=_.value},r=typeof Symbol=="function"?Symbol:{},i=r.iterator||"@@iterator",a=r.asyncIterator||"@@asyncIterator",o=r.toStringTag||"@@toStringTag";function u(p,g,_){return Object.defineProperty(p,g,{value:_,enumerable:!0,configurable:!0,writable:!0}),p[g]}try{u({},"")}catch{u=function(g,_,D){return g[_]=D}}function l(p,g,_,D){var T=g&&g.prototype instanceof d?g:d,P=Object.create(T.prototype),x=new N(D||[]);return t(P,"_invoke",{value:E(p,_,x)}),P}function c(p,g,_){try{return{type:"normal",arg:p.call(g,_)}}catch(D){return{type:"throw",arg:D}}}n.wrap=l;var h={};function d(){}function f(){}function v(){}var b={};u(b,i,function(){return this});var m=Object.getPrototypeOf,y=m&&m(m(G([])));y&&y!==s&&e.call(y,i)&&(b=y);var A=v.prototype=d.prototype=Object.create(b);function k(p){["next","throw","return"].forEach(function(g){u(p,g,function(_){return this._invoke(g,_)})})}function w(p,g){function _(T,P,x,H){var W=c(p[T],p,P);if(W.type!=="throw"){var I=W.arg,oe=I.value;return oe&&typeof oe=="object"&&e.call(oe,"__await")?g.resolve(oe.__await).then(function($){_("next",$,x,H)},function($){_("throw",$,x,H)}):g.resolve(oe).then(function($){I.value=$,x(I)},function($){return _("throw",$,x,H)})}H(W.arg)}var D;t(this,"_invoke",{value:function(T,P){function x(){return new g(function(H,W){_(T,P,H,W)})}return D=D?D.then(x,x):x()}})}function E(p,g,_){var D="suspendedStart";return function(T,P){if(D==="executing")throw new Error("Generator is already running");if(D==="completed"){if(T==="throw")throw P;return z()}for(_.method=T,_.arg=P;;){var x=_.delegate;if(x){var H=B(x,_);if(H){if(H===h)continue;return H}}if(_.method==="next")_.sent=_._sent=_.arg;else if(_.method==="throw"){if(D==="suspendedStart")throw D="completed",_.arg;_.dispatchException(_.arg)}else _.method==="return"&&_.abrupt("return",_.arg);D="executing";var W=c(p,g,_);if(W.type==="normal"){if(D=_.done?"completed":"suspendedYield",W.arg===h)continue;return{value:W.arg,done:_.done}}W.type==="throw"&&(D="completed",_.method="throw",_.arg=W.arg)}}}function B(p,g){var _=g.method,D=p.iterator[_];if(D===void 0)return g.delegate=null,_==="throw"&&p.iterator.return&&(g.method="return",g.arg=void 0,B(p,g),g.method==="throw")||_!=="return"&&(g.method="throw",g.arg=new TypeError("The iterator does not provide a '"+_+"' method")),h;var T=c(D,p.iterator,g.arg);if(T.type==="throw")return g.method="throw",g.arg=T.arg,g.delegate=null,h;var P=T.arg;return P?P.done?(g[p.resultName]=P.value,g.next=p.nextLoc,g.method!=="return"&&(g.method="next",g.arg=void 0),g.delegate=null,h):P:(g.method="throw",g.arg=new TypeError("iterator result is not an object"),g.delegate=null,h)}function R(p){var g={tryLoc:p[0]};1 in p&&(g.catchLoc=p[1]),2 in p&&(g.finallyLoc=p[2],g.afterLoc=p[3]),this.tryEntries.push(g)}function U(p){var g=p.completion||{};g.type="normal",delete g.arg,p.completion=g}function N(p){this.tryEntries=[{tryLoc:"root"}],p.forEach(R,this),this.reset(!0)}function G(p){if(p){var g=p[i];if(g)return g.call(p);if(typeof p.next=="function")return p;if(!isNaN(p.length)){var _=-1,D=function T(){for(;++_<p.length;)if(e.call(p,_))return T.value=p[_],T.done=!1,T;return T.value=void 0,T.done=!0,T};return D.next=D}}return{next:z}}function z(){return{value:void 0,done:!0}}return f.prototype=v,t(A,"constructor",{value:v,configurable:!0}),t(v,"constructor",{value:f,configurable:!0}),f.displayName=u(v,o,"GeneratorFunction"),n.isGeneratorFunction=function(p){var g=typeof p=="function"&&p.constructor;return!!g&&(g===f||(g.displayName||g.name)==="GeneratorFunction")},n.mark=function(p){return Object.setPrototypeOf?Object.setPrototypeOf(p,v):(p.__proto__=v,u(p,o,"GeneratorFunction")),p.prototype=Object.create(A),p},n.awrap=function(p){return{__await:p}},k(w.prototype),u(w.prototype,a,function(){return this}),n.AsyncIterator=w,n.async=function(p,g,_,D,T){T===void 0&&(T=Promise);var P=new w(l(p,g,_,D),T);return n.isGeneratorFunction(g)?P:P.next().then(function(x){return x.done?x.value:P.next()})},k(A),u(A,o,"Generator"),u(A,i,function(){return this}),u(A,"toString",function(){return"[object Generator]"}),n.keys=function(p){var g=Object(p),_=[];for(var D in g)_.push(D);return _.reverse(),function T(){for(;_.length;){var P=_.pop();if(P in g)return T.value=P,T.done=!1,T}return T.done=!0,T}},n.values=G,N.prototype={constructor:N,reset:function(p){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(U),!p)for(var g in this)g.charAt(0)==="t"&&e.call(this,g)&&!isNaN(+g.slice(1))&&(this[g]=void 0)},stop:function(){this.done=!0;var p=this.tryEntries[0].completion;if(p.type==="throw")throw p.arg;return this.rval},dispatchException:function(p){if(this.done)throw p;var g=this;function _(W,I){return P.type="throw",P.arg=p,g.next=W,I&&(g.method="next",g.arg=void 0),!!I}for(var D=this.tryEntries.length-1;D>=0;--D){var T=this.tryEntries[D],P=T.completion;if(T.tryLoc==="root")return _("end");if(T.tryLoc<=this.prev){var x=e.call(T,"catchLoc"),H=e.call(T,"finallyLoc");if(x&&H){if(this.prev<T.catchLoc)return _(T.catchLoc,!0);if(this.prev<T.finallyLoc)return _(T.finallyLoc)}else if(x){if(this.prev<T.catchLoc)return _(T.catchLoc,!0)}else{if(!H)throw new Error("try statement without catch or finally");if(this.prev<T.finallyLoc)return _(T.finallyLoc)}}}},abrupt:function(p,g){for(var _=this.tryEntries.length-1;_>=0;--_){var D=this.tryEntries[_];if(D.tryLoc<=this.prev&&e.call(D,"finallyLoc")&&this.prev<D.finallyLoc){var T=D;break}}T&&(p==="break"||p==="continue")&&T.tryLoc<=g&&g<=T.finallyLoc&&(T=null);var P=T?T.completion:{};return P.type=p,P.arg=g,T?(this.method="next",this.next=T.finallyLoc,h):this.complete(P)},complete:function(p,g){if(p.type==="throw")throw p.arg;return p.type==="break"||p.type==="continue"?this.next=p.arg:p.type==="return"?(this.rval=this.arg=p.arg,this.method="return",this.next="end"):p.type==="normal"&&g&&(this.next=g),h},finish:function(p){for(var g=this.tryEntries.length-1;g>=0;--g){var _=this.tryEntries[g];if(_.finallyLoc===p)return this.complete(_.completion,_.afterLoc),U(_),h}},catch:function(p){for(var g=this.tryEntries.length-1;g>=0;--g){var _=this.tryEntries[g];if(_.tryLoc===p){var D=_.completion;if(D.type==="throw"){var T=D.arg;U(_)}return T}}throw new Error("illegal catch attempt")},delegateYield:function(p,g,_){return this.delegate={iterator:G(p),resultName:g,nextLoc:_},this.method==="next"&&(this.arg=void 0),h}},n}function Xe(n){"@babel/helpers - typeof";return Xe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},Xe(n)}function Jt(n,s,e,t,r,i,a){try{var o=n[i](a),u=o.value}catch(l){e(l);return}o.done?s(u):Promise.resolve(u).then(t,r)}function Q(n){return function(){var s=this,e=arguments;return new Promise(function(t,r){var i=n.apply(s,e);function a(u){Jt(i,t,r,a,o,"next",u)}function o(u){Jt(i,t,r,a,o,"throw",u)}a(void 0)})}}function ae(n,s){if(!(n instanceof s))throw new TypeError("Cannot call a class as a function")}function Zt(n,s){for(var e=0;e<s.length;e++){var t=s[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,Er(t.key),t)}}function se(n,s,e){return s&&Zt(n.prototype,s),e&&Zt(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n}function S(n,s,e){return s=Er(s),s in n?Object.defineProperty(n,s,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[s]=e,n}function yt(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),s&&Mt(n,s)}function dt(n){return dt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},dt(n)}function Mt(n,s){return Mt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},Mt(n,s)}function Wr(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function qr(n,s){if(n==null)return{};var e={},t=Object.keys(n),r,i;for(i=0;i<t.length;i++)r=t[i],!(s.indexOf(r)>=0)&&(e[r]=n[r]);return e}function Ut(n,s){if(n==null)return{};var e=qr(n,s),t,r;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(r=0;r<i.length;r++)t=i[r],!(s.indexOf(t)>=0)&&Object.prototype.propertyIsEnumerable.call(n,t)&&(e[t]=n[t])}return e}function K(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function Xr(n,s){if(s&&(typeof s=="object"||typeof s=="function"))return s;if(s!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return K(n)}function _t(n){var s=Wr();return function(){var t=dt(n),r;if(s){var i=dt(this).constructor;r=Reflect.construct(t,arguments,i)}else r=t.apply(this,arguments);return Xr(this,r)}}function Pe(n,s){return Zr(n)||Yr(n,s)||br(n,s)||ri()}function Qr(n){return Jr(n)||ei(n)||br(n)||ti()}function Jr(n){if(Array.isArray(n))return Bt(n)}function Zr(n){if(Array.isArray(n))return n}function ei(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function br(n,s){if(n){if(typeof n=="string")return Bt(n,s);var e=Object.prototype.toString.call(n).slice(8,-1);if(e==="Object"&&n.constructor&&(e=n.constructor.name),e==="Map"||e==="Set")return Array.from(n);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Bt(n,s)}}function Bt(n,s){(s==null||s>n.length)&&(s=n.length);for(var e=0,t=new Array(s);e<s;e++)t[e]=n[e];return t}function ti(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ri(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ii(n,s){if(typeof n!="object"||n===null)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var t=e.call(n,s||"default");if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(n)}function Er(n){var s=ii(n,"string");return typeof s=="symbol"?s:String(s)}function er(n,s){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(n);s&&(t=t.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,t)}return e}function Qe(n){for(var s=1;s<arguments.length;s++){var e=arguments[s]!=null?arguments[s]:{};s%2?er(Object(e),!0).forEach(function(t){L(n,t,e[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):er(Object(e)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(e,t))})}return n}function ue(){ue=function(){return n};var n={},s=Object.prototype,e=s.hasOwnProperty,t=Object.defineProperty||function(p,g,_){p[g]=_.value},r=typeof Symbol=="function"?Symbol:{},i=r.iterator||"@@iterator",a=r.asyncIterator||"@@asyncIterator",o=r.toStringTag||"@@toStringTag";function u(p,g,_){return Object.defineProperty(p,g,{value:_,enumerable:!0,configurable:!0,writable:!0}),p[g]}try{u({},"")}catch{u=function(g,_,D){return g[_]=D}}function l(p,g,_,D){var T=g&&g.prototype instanceof d?g:d,P=Object.create(T.prototype),x=new N(D||[]);return t(P,"_invoke",{value:E(p,_,x)}),P}function c(p,g,_){try{return{type:"normal",arg:p.call(g,_)}}catch(D){return{type:"throw",arg:D}}}n.wrap=l;var h={};function d(){}function f(){}function v(){}var b={};u(b,i,function(){return this});var m=Object.getPrototypeOf,y=m&&m(m(G([])));y&&y!==s&&e.call(y,i)&&(b=y);var A=v.prototype=d.prototype=Object.create(b);function k(p){["next","throw","return"].forEach(function(g){u(p,g,function(_){return this._invoke(g,_)})})}function w(p,g){function _(T,P,x,H){var W=c(p[T],p,P);if(W.type!=="throw"){var I=W.arg,oe=I.value;return oe&&typeof oe=="object"&&e.call(oe,"__await")?g.resolve(oe.__await).then(function($){_("next",$,x,H)},function($){_("throw",$,x,H)}):g.resolve(oe).then(function($){I.value=$,x(I)},function($){return _("throw",$,x,H)})}H(W.arg)}var D;t(this,"_invoke",{value:function(T,P){function x(){return new g(function(H,W){_(T,P,H,W)})}return D=D?D.then(x,x):x()}})}function E(p,g,_){var D="suspendedStart";return function(T,P){if(D==="executing")throw new Error("Generator is already running");if(D==="completed"){if(T==="throw")throw P;return z()}for(_.method=T,_.arg=P;;){var x=_.delegate;if(x){var H=B(x,_);if(H){if(H===h)continue;return H}}if(_.method==="next")_.sent=_._sent=_.arg;else if(_.method==="throw"){if(D==="suspendedStart")throw D="completed",_.arg;_.dispatchException(_.arg)}else _.method==="return"&&_.abrupt("return",_.arg);D="executing";var W=c(p,g,_);if(W.type==="normal"){if(D=_.done?"completed":"suspendedYield",W.arg===h)continue;return{value:W.arg,done:_.done}}W.type==="throw"&&(D="completed",_.method="throw",_.arg=W.arg)}}}function B(p,g){var _=g.method,D=p.iterator[_];if(D===void 0)return g.delegate=null,_==="throw"&&p.iterator.return&&(g.method="return",g.arg=void 0,B(p,g),g.method==="throw")||_!=="return"&&(g.method="throw",g.arg=new TypeError("The iterator does not provide a '"+_+"' method")),h;var T=c(D,p.iterator,g.arg);if(T.type==="throw")return g.method="throw",g.arg=T.arg,g.delegate=null,h;var P=T.arg;return P?P.done?(g[p.resultName]=P.value,g.next=p.nextLoc,g.method!=="return"&&(g.method="next",g.arg=void 0),g.delegate=null,h):P:(g.method="throw",g.arg=new TypeError("iterator result is not an object"),g.delegate=null,h)}function R(p){var g={tryLoc:p[0]};1 in p&&(g.catchLoc=p[1]),2 in p&&(g.finallyLoc=p[2],g.afterLoc=p[3]),this.tryEntries.push(g)}function U(p){var g=p.completion||{};g.type="normal",delete g.arg,p.completion=g}function N(p){this.tryEntries=[{tryLoc:"root"}],p.forEach(R,this),this.reset(!0)}function G(p){if(p){var g=p[i];if(g)return g.call(p);if(typeof p.next=="function")return p;if(!isNaN(p.length)){var _=-1,D=function T(){for(;++_<p.length;)if(e.call(p,_))return T.value=p[_],T.done=!1,T;return T.value=void 0,T.done=!0,T};return D.next=D}}return{next:z}}function z(){return{value:void 0,done:!0}}return f.prototype=v,t(A,"constructor",{value:v,configurable:!0}),t(v,"constructor",{value:f,configurable:!0}),f.displayName=u(v,o,"GeneratorFunction"),n.isGeneratorFunction=function(p){var g=typeof p=="function"&&p.constructor;return!!g&&(g===f||(g.displayName||g.name)==="GeneratorFunction")},n.mark=function(p){return Object.setPrototypeOf?Object.setPrototypeOf(p,v):(p.__proto__=v,u(p,o,"GeneratorFunction")),p.prototype=Object.create(A),p},n.awrap=function(p){return{__await:p}},k(w.prototype),u(w.prototype,a,function(){return this}),n.AsyncIterator=w,n.async=function(p,g,_,D,T){T===void 0&&(T=Promise);var P=new w(l(p,g,_,D),T);return n.isGeneratorFunction(g)?P:P.next().then(function(x){return x.done?x.value:P.next()})},k(A),u(A,o,"Generator"),u(A,i,function(){return this}),u(A,"toString",function(){return"[object Generator]"}),n.keys=function(p){var g=Object(p),_=[];for(var D in g)_.push(D);return _.reverse(),function T(){for(;_.length;){var P=_.pop();if(P in g)return T.value=P,T.done=!1,T}return T.done=!0,T}},n.values=G,N.prototype={constructor:N,reset:function(p){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(U),!p)for(var g in this)g.charAt(0)==="t"&&e.call(this,g)&&!isNaN(+g.slice(1))&&(this[g]=void 0)},stop:function(){this.done=!0;var p=this.tryEntries[0].completion;if(p.type==="throw")throw p.arg;return this.rval},dispatchException:function(p){if(this.done)throw p;var g=this;function _(W,I){return P.type="throw",P.arg=p,g.next=W,I&&(g.method="next",g.arg=void 0),!!I}for(var D=this.tryEntries.length-1;D>=0;--D){var T=this.tryEntries[D],P=T.completion;if(T.tryLoc==="root")return _("end");if(T.tryLoc<=this.prev){var x=e.call(T,"catchLoc"),H=e.call(T,"finallyLoc");if(x&&H){if(this.prev<T.catchLoc)return _(T.catchLoc,!0);if(this.prev<T.finallyLoc)return _(T.finallyLoc)}else if(x){if(this.prev<T.catchLoc)return _(T.catchLoc,!0)}else{if(!H)throw new Error("try statement without catch or finally");if(this.prev<T.finallyLoc)return _(T.finallyLoc)}}}},abrupt:function(p,g){for(var _=this.tryEntries.length-1;_>=0;--_){var D=this.tryEntries[_];if(D.tryLoc<=this.prev&&e.call(D,"finallyLoc")&&this.prev<D.finallyLoc){var T=D;break}}T&&(p==="break"||p==="continue")&&T.tryLoc<=g&&g<=T.finallyLoc&&(T=null);var P=T?T.completion:{};return P.type=p,P.arg=g,T?(this.method="next",this.next=T.finallyLoc,h):this.complete(P)},complete:function(p,g){if(p.type==="throw")throw p.arg;return p.type==="break"||p.type==="continue"?this.next=p.arg:p.type==="return"?(this.rval=this.arg=p.arg,this.method="return",this.next="end"):p.type==="normal"&&g&&(this.next=g),h},finish:function(p){for(var g=this.tryEntries.length-1;g>=0;--g){var _=this.tryEntries[g];if(_.finallyLoc===p)return this.complete(_.completion,_.afterLoc),U(_),h}},catch:function(p){for(var g=this.tryEntries.length-1;g>=0;--g){var _=this.tryEntries[g];if(_.tryLoc===p){var D=_.completion;if(D.type==="throw"){var T=D.arg;U(_)}return T}}throw new Error("illegal catch attempt")},delegateYield:function(p,g,_){return this.delegate={iterator:G(p),resultName:g,nextLoc:_},this.method==="next"&&(this.arg=void 0),h}},n}function Ve(n){"@babel/helpers - typeof";return Ve=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},Ve(n)}function tr(n,s,e,t,r,i,a){try{var o=n[i](a),u=o.value}catch(l){e(l);return}o.done?s(u):Promise.resolve(u).then(t,r)}function Oe(n){return function(){var s=this,e=arguments;return new Promise(function(t,r){var i=n.apply(s,e);function a(u){tr(i,t,r,a,o,"next",u)}function o(u){tr(i,t,r,a,o,"throw",u)}a(void 0)})}}function ge(n,s){if(!(n instanceof s))throw new TypeError("Cannot call a class as a function")}function rr(n,s){for(var e=0;e<s.length;e++){var t=s[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,Tr(t.key),t)}}function ye(n,s,e){return s&&rr(n.prototype,s),e&&rr(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n}function L(n,s,e){return s=Tr(s),s in n?Object.defineProperty(n,s,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[s]=e,n}function et(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),s&&Je(n,s)}function Ge(n){return Ge=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Ge(n)}function Je(n,s){return Je=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},Je(n,s)}function wr(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ct(n,s,e){return wr()?ct=Reflect.construct.bind():ct=function(r,i,a){var o=[null];o.push.apply(o,i);var u=Function.bind.apply(r,o),l=new u;return a&&Je(l,a.prototype),l},ct.apply(null,arguments)}function ni(n){return Function.toString.call(n).indexOf("[native code]")!==-1}function vt(n){var s=typeof Map=="function"?new Map:void 0;return vt=function(t){if(t===null||!ni(t))return t;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(typeof s<"u"){if(s.has(t))return s.get(t);s.set(t,r)}function r(){return ct(t,arguments,Ge(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),Je(r,t)},vt(n)}function ai(n,s){if(n==null)return{};var e={},t=Object.keys(n),r,i;for(i=0;i<t.length;i++)r=t[i],!(s.indexOf(r)>=0)&&(e[r]=n[r]);return e}function si(n,s){if(n==null)return{};var e=ai(n,s),t,r;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(r=0;r<i.length;r++)t=i[r],!(s.indexOf(t)>=0)&&Object.prototype.propertyIsEnumerable.call(n,t)&&(e[t]=n[t])}return e}function F(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function oi(n,s){if(s&&(typeof s=="object"||typeof s=="function"))return s;if(s!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return F(n)}function tt(n){var s=wr();return function(){var t=Ge(n),r;if(s){var i=Ge(this).constructor;r=Reflect.construct(t,arguments,i)}else r=t.apply(this,arguments);return oi(this,r)}}function ui(n,s){for(;!Object.prototype.hasOwnProperty.call(n,s)&&(n=Ge(n),n!==null););return n}function ht(){return typeof Reflect<"u"&&Reflect.get?ht=Reflect.get.bind():ht=function(s,e,t){var r=ui(s,e);if(r){var i=Object.getOwnPropertyDescriptor(r,e);return i.get?i.get.call(arguments.length<3?s:t):i.value}},ht.apply(this,arguments)}function li(n,s){if(n){if(typeof n=="string")return ir(n,s);var e=Object.prototype.toString.call(n).slice(8,-1);if(e==="Object"&&n.constructor&&(e=n.constructor.name),e==="Map"||e==="Set")return Array.from(n);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return ir(n,s)}}function ir(n,s){(s==null||s>n.length)&&(s=n.length);for(var e=0,t=new Array(s);e<s;e++)t[e]=n[e];return t}function ci(n,s){var e=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(!e){if(Array.isArray(n)||(e=li(n))||s&&n&&typeof n.length=="number"){e&&(n=e);var t=0,r=function(){};return{s:r,n:function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}},e:function(u){throw u},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,a=!1,o;return{s:function(){e=e.call(n)},n:function(){var u=e.next();return i=u.done,u},e:function(u){a=!0,o=u},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(a)throw o}}}}function hi(n,s){if(typeof n!="object"||n===null)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var t=e.call(n,s||"default");if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(n)}function Tr(n){var s=hi(n,"string");return typeof s=="symbol"?s:String(s)}var me=function(){function n(){ge(this,n)}return ye(n,null,[{key:"start",value:function(e){return!e||!e.length||e.length===1&&e.end(0)-e.start(0)<1e-6||e.length===1&&e.start(0)<0?0:e.start(0)}},{key:"end",value:function(e){return!e||!e.length||e.length===1&&e.end(0)-e.start(0)<1e-6?0:e.end(e.length-1)}},{key:"get",value:function(e){if(e)try{return e.buffered}catch{}}},{key:"buffers",value:function(e,t){if(!e||!e.length)return[];for(var r=[],i=0,a=e.length;i<a;i++){var o=r.length;if(!o||!t)r.push([e.start(i),e.end(i)]);else{var u=r[o-1],l=u[1],c=e.start(i);if(c-l<=t){var h=e.end(i);h>l&&(u[1]=h)}else r.push([e.start(i),e.end(i)])}}return r}},{key:"totalLength",value:function(e){return!e||!e.length?0:e.reduce(function(t,r){return t+=r[1]-r[0]},0)}},{key:"info",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;if(!e||!e.length)return{start:0,end:0,buffers:[]};for(var i=0,a=0,o=0,u=0,l=0,c=0,h=0,d=n.buffers(e,r),f=0,v=d.length;f<v;f++){var b=d[f];if(t+r>=b[0]&&t<=b[1])i=b[0],a=b[1],o=f;else if(t+r<b[0]){u=b[0],l=b[1];break}else t+r>b[1]&&(c=b[0],h=b[1])}return{start:i,end:a,index:o,buffers:d,nextStart:u,nextEnd:l,prevStart:c,prevEnd:h,currentTime:t,behind:t-i,remaining:a?a-t:0,length:n.totalLength&&n.totalLength(d)}}},{key:"isBuffered",value:function(e,t){if(e){var r=n.get(e);if(r!=null&&r.length){for(var i=0;i<r.length;i++)if(t>=r.start(i)&&t<=r.end(i))return!0}}return!1}}]),n}(),fi=typeof window<"u",ve,q={MANIFEST:"manifest",NETWORK:"network",NETWORK_TIMEOUT:"network_timeout",NETWORK_FORBIDDEN:"network_forbidden",NETWORK_NOTFOUND:"network_notfound",NETWROK_RANGE_NOT_SATISFIABLE:"network_range_not_satisfiable",DEMUX:"demux",REMUX:"remux",MEDIA:"media",DRM:"drm",OTHER:"other",RUNTIME:"runtime",SUB_TYPES:{FLV:"FLV",HLS:"HLS",MP4:"MP4",FMP4:"FMP4",MSE_ADD_SB:"MSE_ADD_SB",MSE_APPEND_BUFFER:"MSE_APPEND_BUFFER",MSE_OTHER:"MSE_OTHER",MSE_FULL:"MSE_FULL",MSE_CHANGE_TYPE:"MSE_CHANGE_TYPE",OPTION:"OPTION",DASH:"DASH",LICENSE:"LICENSE",CUSTOM_LICENSE:"CUSTOM_LICENSE",MSE_HIJACK:"MSE_HIJACK",EME_HIJACK:"EME_HIJACK",SIDX:"SIDX",NO_CANPLAY_ERROR:"NO_CANPLAY_ERROR",BUFFERBREAK_ERROR:"BUFFERBREAK_ERROR",WAITING_TIMEOUT_ERROR:"WAITING_TIMEOUT_ERROR",MEDIA_ERR_ABORTED:"MEDIA_ERR_ABORTED",MEDIA_ERR_NETWORK:"MEDIA_ERR_NETWORK",MEDIA_ERR_DECODE:"MEDIA_ERR_DECODE",MEDIA_ERR_SRC_NOT_SUPPORTED:"MEDIA_ERR_SRC_NOT_SUPPORTED",MEDIA_ERR_CODEC_NOT_SUPPORTED:"MEDIA_ERR_CODEC_NOT_SUPPORTED",MEDIA_ERR_URL_EMPTY:"MEDIA_ERR_URL_EMPTY"}},wt=(ve={},L(ve,q.MANIFEST,{HLS:1100,DASH:1200}),L(ve,q.NETWORK,2100),L(ve,q.NETWORK_TIMEOUT,2101),L(ve,q.NETWORK_FORBIDDEN,2103),L(ve,q.NETWORK_NOTFOUND,2104),L(ve,q.NETWROK_RANGE_NOT_SATISFIABLE,2116),L(ve,q.DEMUX,{FLV:3100,HLS:3200,MP4:3300,FMP4:3400,SIDX:3410}),L(ve,q.REMUX,{FMP4:4100,MP4:4200}),L(ve,q.MEDIA,{MEDIA_ERR_ABORTED:5101,MEDIA_ERR_NETWORK:5102,MEDIA_ERR_DECODE:5103,MEDIA_ERR_SRC_NOT_SUPPORTED:5104,MEDIA_ERR_CODEC_NOT_SUPPORTED:5105,MEDIA_ERR_URL_EMPTY:5106,MSE_ADD_SB:5200,MSE_APPEND_BUFFER:5201,MSE_OTHER:5202,MSE_FULL:5203,MSE_HIJACK:5204,MSE_CHANGE_TYPE:5205,EME_HIJACK:5301}),L(ve,q.DRM,{LICENSE:7100,CUSTOM_LICENSE:7200}),L(ve,q.OTHER,8e3),L(ve,q.RUNTIME,{NO_CANPLAY_ERROR:9001,BUFFERBREAK_ERROR:9002,WAITING_TIMEOUT_ERROR:9003}),ve),te=function(n){et(e,n);var s=tt(e);function e(t,r,i,a,o){var u;return ge(this,e),u=s.call(this,o||(i==null?void 0:i.message)),u.errorType=t===q.NETWORK_TIMEOUT?q.NETWORK:t,u.originError=i,u.ext=a,u.errorCode=wt[t][r]||wt[t],u.errorMessage=u.message,u.errorCode||(u.errorType=q.OTHER,u.errorCode=wt[u.errorType]),u}return ye(e,null,[{key:"create",value:function(r,i,a,o,u){return r instanceof e?r:(r instanceof Error&&(a=r,r=""),r||(r=q.OTHER),new e(r,i,a,o,u))}},{key:"network",value:function(r){var i;return new e(r!=null&&r.isTimeout?q.NETWORK_TIMEOUT:q.NETWORK,null,r instanceof Error?r:null,{url:r==null?void 0:r.url,response:r==null?void 0:r.response,httpCode:r==null||(i=r.response)===null||i===void 0?void 0:i.status})}}]),e}(vt(Error)),it={DEBUG:1,LOG:2,WARN:3,ERROR:4},di=200*1024,vi=["Boolean","Number","String","Undefined","Null","Date","Object"],De=function(){function n(s,e){ge(this,n),this.name=s||"",this._prefix="[".concat(this.name,"]"),this.logCacheLevel=(e==null?void 0:e.logCacheLevel)||3,this.logMaxSize=(e==null?void 0:e.logMaxSize)||di,this.logSize=0,this.logTextArray=[]}return ye(n,[{key:"debug",value:function(){for(var e,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];this.logCache.apply(this,[it.DEBUG].concat(r)),!n.disabled&&(e=console).debug.apply(e,["[".concat(We(),"]"),this._prefix].concat(r))}},{key:"log",value:function(){for(var e,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];this.logCache.apply(this,[it.LOG].concat(r)),!n.disabled&&(e=console).log.apply(e,["[".concat(We(),"]"),this._prefix].concat(r))}},{key:"warn",value:function(){for(var e,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];this.logCache.apply(this,[it.WARN].concat(r)),!n.disabled&&(e=console).warn.apply(e,["[".concat(We(),"]"),this._prefix].concat(r))}},{key:"error",value:function(){for(var e,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];this.logCache.apply(this,[it.ERROR].concat(r)),!n.disabled&&(e=console).error.apply(e,["[".concat(We(),"]"),this._prefix].concat(r))}},{key:"logCache",value:function(e){if(!(e<this.logCacheLevel)){var t="";try{for(var r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];var o=i.map(function(l){return kr(l)});t="[".concat(We(),"]")+this._prefix+JSON.stringify(o)}catch{return}if(e>=this.logCacheLevel&&(this.logSize+=t.length,this.logTextArray.push(t)),this.logSize>this.logMaxSize){var u=this.logTextArray.shift();this.logSize-=u.length}}}},{key:"getLogCache",value:function(){var e=this.logTextArray.join(`
`);return this.reset(),e}},{key:"reset",value:function(){this.logTextArray=[],this.logSize=0}},{key:"table",value:function(){var e;n.disabled||(console.group(this._prefix),(e=console).table.apply(e,arguments),console.groupEnd())}},{key:"setLogLevel",value:function(e){this.logCacheLevel=e}}],[{key:"enable",value:function(){n.disabled=!1}},{key:"disable",value:function(){n.disabled=!0}}]),n}();L(De,"disabled",!0);function We(){return new Date().toLocaleString()}function pi(n){if(Ve(n)!=="object")return n;var s=Object.prototype.toString.call(n).slice(8,-1);switch(s){case"Array":case"Uint8Array":case"ArrayBuffer":return s+"["+n.length+"]";case"Object":return"{}";default:return s}}function kr(n,s,e){e||(e=1),s||(s=2);var t={};if(!n||Ve(n)!=="object")return n;var r=Object.prototype.toString.call(n).slice(8,-1);if(!vi.includes(r))return r;if(!(e>s)){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e===s?t[i]=pi(n[i]):Ve(n[i])==="object"?t[i]=kr(n[i],s,e+1):t[i]=n[i]);return t}}function ze(){var n,s,e=new Promise(function(t,r){n=t,s=r});return e.used=!1,e.resolve=function(){return e.used=!0,n.apply(void 0,arguments)},e.reject=function(){return e.used=!0,s.apply(void 0,arguments)},e}function je(){try{return parseInt(performance.now(),10)}catch{return new Date().getTime()}}var mi={stringify:function(s){try{return JSON.stringify(s)}catch{return""}},parse:function(s){try{return JSON.parse(s)}catch{return}}};function nr(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;try{return fi?n&&typeof ManagedMediaSource<"u"?ManagedMediaSource:window.MediaSource:null}catch{}}function Tt(n){return/ManagedMediaSource/gi.test(Object.prototype.toString.call(n))}function gi(n){var s=[];if(n instanceof TimeRanges)for(var e=0;e<n.length;e++)s.push({start:n.start(e),end:n.end(e)});return s}var nt={APPEND:"appendBuffer",REMOVE:"removeBuffer",UPDATE_DURATION:"updateDuration"},de=function(){function n(s,e){var t=this;ge(this,n),L(this,"media",null),L(this,"mediaSource",null),L(this,"_openPromise",ze()),L(this,"_queue",Object.create(null)),L(this,"_sourceBuffer",Object.create(null)),L(this,"_mseFullFlag",{}),L(this,"_st",0),L(this,"_opst",0),L(this,"_logger",null),L(this,"_config",null),L(this,"_url",null),L(this,"_onStartStreaming",function(){t._logger.debug("startstreaming")}),L(this,"_onEndStreaming",function(){t._logger.debug("endstreaming")}),L(this,"_onSBUpdateEnd",function(r){var i=t._queue[r];if(i){var a=i[0];if((a==null?void 0:a.opName)!==nt.UPDATE_DURATION&&i.shift(),a){var o,u,l=je()-t._opst;t._logger.debug("UpdateEnd(".concat(r,"/").concat(a.opName,")"),mi.stringify(gi((o=t._sourceBuffer[r])===null||o===void 0?void 0:o.buffered)),l,a.context),a.promise.resolve({name:a.opName,context:a.context,costtime:l});var c=(u=a.context)===null||u===void 0?void 0:u.callback;c&&typeof c=="function"&&c(a.context),t._startQueue(r)}}}),L(this,"_onSBUpdateError",function(r,i){var a=t._queue[r];if(a){var o=a[0];o&&(t._logger.error("UpdateError",r,o.opName,o.context),o.promise.reject(new te(q.MEDIA,q.SUB_TYPES.MSE_APPEND_BUFFER,i)))}}),this._config=Object.assign(n.getDefaultConfig(),e),s&&this.bindMedia(s),this._logger=new De("MSE"),this._config.openLog&&De.enable()}return ye(n,[{key:"isOpened",get:function(){var e;return((e=this.mediaSource)===null||e===void 0?void 0:e.readyState)==="open"}},{key:"hasOpTasks",get:function(){var e=this,t=!1;return Object.keys(this._queue).forEach(function(r){var i=e._queue[r];Array.isArray(i)&&(t||(t=i.length>0))}),t}},{key:"url",get:function(){return this._url}},{key:"duration",get:function(){var e;return((e=this.mediaSource)===null||e===void 0?void 0:e.duration)||-1}},{key:"isEnded",get:function(){return this.mediaSource?this.mediaSource.readyState==="ended":!1}},{key:"streaming",get:function(){return Tt(this.mediaSource)?this.mediaSource.streaming:!0}},{key:"isFull",value:function(e){return e?this._mseFullFlag[e]:this._mseFullFlag[n.VIDEO]}},{key:"updateDuration",value:function(e){var t=this,r=this.mediaSource&&this.mediaSource.duration>e;if(this.mediaSource&&this.mediaSource.duration>e){var i=0;if(Object.keys(this._sourceBuffer).forEach(function(a){try{i=Math.max(t.bufferEnd(a)||0,i)}catch{}}),e<i)return Promise.resolve()}return this._enqueueBlockingOp(function(){if(t.isEnded){t._logger.debug("setDuration but ended");return}t.mediaSource&&(t.mediaSource.duration=e,t._logger.debug("setDuration",e))},nt.UPDATE_DURATION,{isReduceDuration:r})}},{key:"open",value:function(){var e=this;if(this._openPromise.used&&!this.isOpened&&this.mediaSource){var t=this.mediaSource,r=function i(){var a=je()-e._st;e._logger.debug("sourceopen",a),t.removeEventListener("sourceopen",i),e._openPromise.resolve({costtime:a})};t.addEventListener("sourceopen",r),this._openPromise=ze()}return this._openPromise}},{key:"bindMedia",value:function(){var s=Oe(ue().mark(function t(r){var i=this,a,o,u,l;return ue().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(!(this.mediaSource||this.media)){h.next=3;break}return h.next=3,this.unbindMedia();case 3:if(a=nr(this._config.preferMMS),!(!r||!a)){h.next=6;break}throw new Error("Param media or MediaSource does not exist");case 6:return this.media=r,o=this.mediaSource=new a,u=Tt(o),this._st=je(),l=function d(){var f=je()-i._st;i._logger.debug("sourceopen"),o.removeEventListener("sourceopen",d),URL.revokeObjectURL(r.src),i._openPromise.resolve({costtime:f})},o.addEventListener("sourceopen",l),u&&(o.addEventListener("startstreaming",this._onStartStreaming),o.addEventListener("endstreaming",this._onEndStreaming)),this._url=URL.createObjectURL(o),r.src=this._url,r.disableRemotePlayback=u,h.abrupt("return",this._openPromise);case 17:case"end":return h.stop()}},t,this)}));function e(t){return s.apply(this,arguments)}return e}()},{key:"unbindMedia",value:function(){var s=Oe(ue().mark(function t(){var r=this,i,a,o;return ue().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(this._openPromise.used||this._openPromise.resolve(),i=this.mediaSource,i){if(Object.keys(this._queue).forEach(function(c){var h=r._queue[c];h&&h.forEach(function(d){var f,v;return(f=d.promise)===null||f===void 0||(v=f.resolve)===null||v===void 0?void 0:v.call(f)})}),a=!!this.media&&this.media.readyState>=1,o=i.readyState==="open",a&&o)try{i.endOfStream()}catch{}Object.keys(this._sourceBuffer).forEach(function(c){try{i.removeSourceBuffer(r._sourceBuffer[c])}catch{}}),Tt(i)&&(i.removeEventListener("startstreaming",this._onStartStreaming),i.removeEventListener("endstreaming",this._onEndStreaming))}if(this.media){this.media.disableRemotePlayback=!1,this.media.removeAttribute("src");try{this.media.load()}catch{}this.media=null}this.mediaSource=null,this._openPromise=ze(),this._queue=Object.create(null),this._sourceBuffer=Object.create(null);case 8:case"end":return l.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()},{key:"createSource",value:function(e,t){if(!(this._sourceBuffer[e]||!this.mediaSource)){var r;try{r=this._sourceBuffer[e]=this.mediaSource.addSourceBuffer(t)}catch(i){throw new te(q.MEDIA,q.SUB_TYPES.MSE_ADD_SB,i)}r.mimeType=t,r.addEventListener("updateend",this._onSBUpdateEnd.bind(this,e)),r.addEventListener("error",this._onSBUpdateError.bind(this,e))}}},{key:"changeType",value:function(e,t){var r=this,i=this._sourceBuffer[e];return!this.mediaSource||!i||i.mimeType===t?Promise.resolve():typeof i.changeType!="function"?Promise.reject(new te(q.MEDIA,q.SUB_TYPES.MSE_CHANGE_TYPE,new Error("changeType is not a function"))):this._enqueueOp(e,function(){try{i.changeType(t)}catch(a){throw new te(q.MEDIA,q.SUB_TYPES.MSE_CHANGE_TYPE,a)}i.mimeType=t,r._onSBUpdateEnd(e)},"changeType",{mimeType:t})}},{key:"createOrChangeSource",value:function(e,t){return this.createSource(e,t),this.changeType(e,t)}},{key:"append",value:function(e,t,r){var i=this;return!t||!t.byteLength||!this._sourceBuffer[e]?Promise.resolve():this._enqueueOp(e,function(){var a;!i.mediaSource||i.media.error||(i._logger.debug("MSE APPEND START",r),i._opst=je(),(a=i._sourceBuffer[e])===null||a===void 0||a.appendBuffer(t))},nt.APPEND,r)}},{key:"remove",value:function(e,t,r,i){var a=this,o=!1;return this._mseFullFlag[e]&&(o=!0),this._enqueueOp(e,function(){if(!(!a.mediaSource||a.media.error)){var u=a._sourceBuffer[e];if(t>=r||!u){a._onSBUpdateEnd(e);return}a._opst=je(),a._logger.debug("MSE REMOVE START",e,t,r,i),u.remove(t,r)}},nt.REMOVE,i,o)}},{key:"clearBuffer",value:function(e,t){var r=this,i;return Object.keys(this._sourceBuffer).forEach(function(a){i=r.remove(a,e,t)}),i||Promise.resolve()}},{key:"clearAllBuffer",value:function(){var e=this,t;return Object.keys(this._sourceBuffer).forEach(function(r){var i=e._sourceBuffer[r];t=e.remove(r,0,me.end(me.get(i)))}),t}},{key:"clearOpQueues",value:function(e,t){var r;this._logger.debug("MSE clearOpQueue START");var i=this._queue[e];if(t&&i){this._queue[e]=[];return}if(!(!i||!i[e]||i.length<5)){var a=[];i.forEach(function(o){o.context&&o.context.isinit&&a.push(o)}),this._queue[e]=i.slice(0,2),a.length>0&&(r=this._queue[e]).push.apply(r,a)}}},{key:"endOfStream",value:function(e){var t=this;return!this.mediaSource||this.mediaSource.readyState!=="open"?Promise.resolve():this._enqueueBlockingOp(function(){var r=t.mediaSource;!r||r.readyState!=="open"||(t._logger.debug("MSE endOfStream START"),e?r.endOfStream(e):r.endOfStream())},"endOfStream")}},{key:"setLiveSeekableRange",value:function(e,t){var r=this.mediaSource;e<0||t<e||!(r!=null&&r.setLiveSeekableRange)||r.readyState!=="open"||r.setLiveSeekableRange(e,t)}},{key:"getSourceBuffer",value:function(e){return this._sourceBuffer[e]}},{key:"buffered",value:function(e){return me.get(this._sourceBuffer[e])}},{key:"bufferStart",value:function(e){return me.start(this.buffered(e))}},{key:"bufferEnd",value:function(e){return me.end(this.buffered(e))}},{key:"_enqueueOp",value:function(e,t,r,i,a){var o=this;if(!this.mediaSource)return Promise.resolve();var u=this._queue[e]=this._queue[e]||[],l={exec:t,promise:ze(),opName:r,context:i};return a?(u.splice(0,0,l),this._mseFullFlag[e]=!1,this._startQueue(e)):u.push(l),this.isOpened||this.isEnded?u.length===1&&this._startQueue(e):this._openPromise.then(function(){u.length===1&&o._startQueue(e)}),l.promise}},{key:"_enqueueBlockingOp",value:function(){var s=Oe(ue().mark(function t(r,i,a){var o=this,u,l;return ue().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(this.mediaSource){h.next=2;break}return h.abrupt("return",Promise.resolve());case 2:if(u=Object.keys(this._sourceBuffer),u.length){h.next=5;break}return h.abrupt("return",r());case 5:return l=[],u.forEach(function(d){var f=o._queue[d],v=ze();l.push(v),f.push({exec:function(){v.resolve()},promise:v,opName:i,context:a}),f.length===1&&o._startQueue(d)}),h.abrupt("return",Promise.all(l).then(function(){try{return r()}finally{u.forEach(function(d){var f=o._queue[d],v=o._sourceBuffer[d];f==null||f.shift(),(!v||!v.updating)&&o._startQueue(d)})}}));case 8:case"end":return h.stop()}},t,this)}));function e(t,r,i){return s.apply(this,arguments)}return e}()},{key:"_startQueue",value:function(e){var t=this._queue[e];if(t){var r=t[0];if(r&&!this._mseFullFlag[e])try{r.exec()}catch(o){if(o&&o.message&&o.message.indexOf("SourceBuffer is full")>=0){var i;this._mseFullFlag[e]=!0,r.context&&Ve(r.context)==="object"&&(r.context.isFull=!0),this._logger.error("[MSE error],  context,",r.context," ,name,",r.opName,",err,SourceBuffer is full"),r==null||(i=r.promise)===null||i===void 0||i.reject(new te(q.MEDIA,q.SUB_TYPES.MSE_FULL,o))}else{var a;this._logger.error(o),r==null||(a=r.promise)===null||a===void 0||a.reject(o.constructor===te?o:new te(q.MEDIA,q.SUB_TYPES.MSE_OTHER,o)),t.shift(),this._startQueue(e)}}}}},{key:"setTimeoffset",value:function(e,t,r){var i=this;return this._enqueueOp(e,function(){t<0&&(t+=.001),i._sourceBuffer[e].timestampOffset=t,i._onSBUpdateEnd(e)},"setTimeoffset",r)}},{key:"abort",value:function(e,t){var r=this;return this.isOpened?this._enqueueOp(e,function(){r._sourceBuffer[e].abort(),r._onSBUpdateEnd(e)},"abort",t):Promise.resolve()}}],[{key:"isSupported",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:'video/mp4; codecs="avc1.42E01E,mp4a.40.2"',t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,r=nr(t);if(!r)return!1;try{return r.isTypeSupported(e)}catch(i){return this._logger.error(e,i),!1}}},{key:"isMMSOnly",value:function(){return typeof ManagedMediaSource<"u"&&typeof MediaSource>"u"}},{key:"getDefaultConfig",value:function(){return{openLog:!1,preferMMS:!1}}}]),n}();L(de,"VIDEO","video");L(de,"AUDIO","audio");var Fe={FETCH:"fetch",XHR:"xhr"},Ze={ARRAY_BUFFER:"arraybuffer",TEXT:"text",JSON:"json"},Ae=function(n){et(e,n);var s=tt(e);function e(t,r,i,a){var o;return ge(this,e),o=s.call(this,a),L(F(o),"retryCount",0),L(F(o),"isTimeout",!1),L(F(o),"loaderType",Fe.FETCH),L(F(o),"startTime",0),L(F(o),"endTime",0),L(F(o),"options",{}),o.url=t,o.request=r,o.response=i,o}return ye(e)}(vt(Error)),Ar=Object.prototype.toString;function yi(n){return n!==null&&Ve(n)==="object"}function ar(n){if(Ar.call(n)!=="[object Object]")return!1;var s=Object.getPrototypeOf(n);return s===null||s===Object.prototype}function _i(n){return Ar.call(n)==="[object Date]"}function Dr(n){if(!(!n||n[0]===null||n[0]===void 0||n[0]===0&&(n[1]===null||n[1]===void 0))){var s="bytes="+n[0]+"-";return n[1]&&(s+=n[1]),s}}function sr(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Lr(n,s){if(n){if(!s)return n;var e,t=Object.keys(s).map(function(i){if(e=s[i],e!=null)return Array.isArray(e)?i=i+"[]":e=[e],e.map(function(a){return _i(a)?a=a.toISOString():yi(a)&&(a=JSON.stringify(a)),"".concat(sr(i),"=").concat(sr(a))}).join("&")}).filter(Boolean).join("&");if(t){var r=n.indexOf("#");r!==-1&&(n=n.slice(0,r)),n+=(n.indexOf("?")===-1?"?":"&")+t}return n}}function xt(n,s,e,t,r,i,a,o,u,l,c){r=r!=null?parseFloat(r):null,t=parseInt(t||"0",10),Number.isNaN(t)&&(t=0);var h={range:u,vid:l,index:o,contentLength:t,age:r,startTime:i,firstByteTime:a,endTime:Date.now(),priOptions:c};return{data:n,done:s,options:h,response:e}}function Nt(n,s){return Math.round(n*8*1e3/s/1024)}var V={ERROR:"error",TTFB:"core.ttfb",LOAD_START:"core.loadstart",LOAD_RESPONSE_HEADERS:"core.loadresponseheaders",LOAD_COMPLETE:"core.loadcomplete",LOAD_RETRY:"core.loadretry",SOURCEBUFFER_CREATED:"core.sourcebuffercreated",MEDIASOURCE_OPENED:"core.mediasourceopened",ANALYZE_DURATION_EXCEEDED:"core.analyzedurationexceeded",APPEND_BUFFER:"core.appendbuffer",REMOVE_BUFFER:"core.removebuffer",BUFFEREOS:"core.buffereos",KEYFRAME:"core.keyframe",CHASEFRAME:"core.chaseframe",METADATA_PARSED:"core.metadataparsed",SEI:"core.sei",SEI_IN_TIME:"core.seiintime",FLV_SCRIPT_DATA:"core.flvscriptdata",LOWDECODE:"core.lowdecode",SWITCH_URL_SUCCESS:"core.switchurlsuccess",SWITCH_URL_FAILED:"core.switchurlfailed",SPEED:"core.speed",HLS_MANIFEST_LOADED:"core.hlsmanifestloaded",HLS_LEVEL_LOADED:"core.hlslevelloaded",DEMUXED_TRACK:"core.demuxedtrack",STREAM_EXCEPTION:"core.streamexception",LARGE_AV_FIRST_FRAME_GAP_DETECT:"LARGE_AV_FIRST_FRAME_GAP_DETECT",LARGE_VIDEO_DTS_GAP_DETECT:"LARGE_VIDEO_DTS_GAP_DETECT",LARGE_AUDIO_DTS_GAP_DETECT:"LARGE_AUDIO_DTS_GAP_DETECT",AUDIO_GAP_DETECT:"AUDIO_GAP_DETECT",AUDIO_OVERLAP_DETECT:"AUDIO_OVERLAP_DETECT",MAX_DTS_DELTA_WITH_NEXT_SEGMENT_DETECT:"MAX_DTS_DELTA_WITH_NEXT_SEGMENT_DETECT",REAL_TIME_SPEED:"real_time_speed"},or=2*1024*1024,Ft=function(n){et(e,n);var s=tt(e);function e(){var t;return ge(this,e),t=s.call(this),L(F(t),"_abortController",null),L(F(t),"_timeoutTimer",null),L(F(t),"_reader",null),L(F(t),"_response",null),L(F(t),"_aborted",!1),L(F(t),"_index",-1),L(F(t),"_range",null),L(F(t),"_receivedLength",0),L(F(t),"_running",!1),L(F(t),"_logger",null),L(F(t),"_vid",""),L(F(t),"_firtstByte",0),L(F(t),"_onProcessMinLen",0),L(F(t),"_onCancel",null),L(F(t),"_priOptions",null),t}return ye(e,[{key:"load",value:function(r){var i,a=this,o=r.url,u=r.vid,l=r.timeout,c=r.responseType,h=r.onProgress,d=r.index,f=r.onTimeout,v=r.onCancel,b=r.range,m=r.transformResponse,y=r.request,A=r.params,k=r.logger,w=r.method,E=r.headers,B=r.body,R=r.mode,U=r.credentials,N=r.cache,G=r.redirect,z=r.referrer,p=r.referrerPolicy,g=r.onProcessMinLen,_=r.priOptions,D=r.streamRes,T=r.firstMaxChunkSize;this._logger=k,this._aborted=!1,this._onProcessMinLen=g,this._onCancel=v,this._abortController=typeof AbortController<"u"&&new AbortController,this._running=!0,this._index=d,this._range=b||[0,0],this._vid=u||o,this._priOptions=_||{},this._firstMaxChunkSize=T;var P={method:w,headers:E,body:B,mode:R,credentials:U,cache:N,redirect:G,referrer:z,referrerPolicy:p,signal:(i=this._abortController)===null||i===void 0?void 0:i.signal},x=!1;clearTimeout(this._timeoutTimer),o=Lr(o,A);var H=Dr(b);H&&(y?E=y.headers:E=P.headers=P.headers||(Headers?new Headers:{}),Headers&&E instanceof Headers?E.append("Range",H):E.Range=H),l&&(this._timeoutTimer=setTimeout(function(){if(x=!0,a.cancel(),f){var I=new Ae(o,P,null,"timeout");I.isTimeout=!0,f(I,{index:a._index,range:a._range,vid:a._vid,priOptions:a._priOptions})}},l));var W=Date.now();return this._logger.debug("[fetch load start], index,",d,",range,",b),new Promise(function(I,oe){var $=D?new Promise(function(le){le(D)}):fetch(y||o,y?void 0:P);$.then(function(){var le=Oe(ue().mark(function Te(ce){var Me,be,Ue,He;return ue().wrap(function(ne){for(;;)switch(ne.prev=ne.next){case 0:if(clearTimeout(a._timeoutTimer),a._response=ce,!(a._aborted||!a._running)){ne.next=4;break}return ne.abrupt("return");case 4:if(m&&(ce=m(ce,o)||ce),ce.ok){ne.next=7;break}throw new Ae(o,P,ce,"bad network response");case 7:if(Me=Date.now(),c!==Ze.TEXT){ne.next=15;break}return ne.next=11,ce.text();case 11:be=ne.sent,a._running=!1,ne.next=37;break;case 15:if(c!==Ze.JSON){ne.next=22;break}return ne.next=18,ce.json();case 18:be=ne.sent,a._running=!1,ne.next=37;break;case 22:if(!h){ne.next=29;break}return a.resolve=I,a.reject=oe,a._loadChunk(ce,h,W,Me),ne.abrupt("return");case 29:return ne.next=31,ce.arrayBuffer();case 31:be=ne.sent,be=new Uint8Array(be),a._running=!1,Ue=Date.now()-W,He=Nt(be.byteLength,Ue),a.emit(V.REAL_TIME_SPEED,{speed:He,len:be.byteLength,time:Ue,vid:a._vid,index:a._index,range:a._range,priOptions:a._priOptions});case 37:a._logger.debug("[fetch load end], index,",d,",range,",b),I(xt(be,!0,ce,ce.headers.get("Content-Length"),ce.headers.get("age"),W,Me,d,b,a._vid,a._priOptions));case 39:case"end":return ne.stop()}},Te)}));return function(Te){return le.apply(this,arguments)}}()).catch(function(le){var Te;clearTimeout(a._timeoutTimer),a._running=!1,!(a._aborted&&!x)&&(le=le instanceof Ae?le:new Ae(o,P,null,(Te=le)===null||Te===void 0?void 0:Te.message),le.startTime=W,le.endTime=Date.now(),le.isTimeout=x,le.options={index:a._index,range:a._range,vid:a._vid,priOptions:a._priOptions},oe(le))})})}},{key:"cancel",value:function(){var t=Oe(ue().mark(function i(){return ue().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!this._aborted){o.next=2;break}return o.abrupt("return");case 2:if(this._aborted=!0,this._running=!1,!this._response){o.next=14;break}if(o.prev=5,!this._reader){o.next=9;break}return o.next=9,this._reader.cancel();case 9:o.next=13;break;case 11:o.prev=11,o.t0=o.catch(5);case 13:this._response=this._reader=null;case 14:if(this._abortController){try{this._abortController.abort()}catch{}this._abortController=null}this._onCancel&&this._onCancel({index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions});case 16:case"end":return o.stop()}},i,this,[[5,11]])}));function r(){return t.apply(this,arguments)}return r}()},{key:"_loadChunk",value:function(r,i,a,o){var u=this;if(!r.body||!r.body.getReader){this._running=!1;var l=new Ae(r.url,"",r,"onProgress of bad response.body.getReader");l.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},this.reject(l);return}this._onProcessMinLen>0&&(this._cache=new Uint8Array(or),this._writeIdx=0);var c=this._reader=r.body.getReader(),h,d,f,v=function(){var b=Oe(ue().mark(function m(){var y,A,k,w,E,B,R,U,N,G;return ue().wrap(function(p){for(;;)switch(p.prev=p.next){case 0:return d=Date.now(),p.prev=1,p.next=4,c.read();case 4:h=p.sent,f=Date.now(),p.next=13;break;case 8:return p.prev=8,p.t0=p.catch(1),f=Date.now(),u._aborted||(u._running=!1,p.t0.options={index:u._index,range:u._range,vid:u._vid,priOptions:u._priOptions},u.reject(p.t0)),p.abrupt("return");case 13:if(A=((y=u._range)===null||y===void 0?void 0:y.length)>0?u._range[0]:0,k=A+u._receivedLength,!u._aborted){p.next=19;break}return u._running=!1,i(void 0,!1,{range:[k,k],vid:u._vid,index:u._index,startTime:d,endTime:f,st:a,firstByteTime:o,priOptions:u._priOptions},r),p.abrupt("return");case 19:w=h.value?h.value.byteLength:0,u._receivedLength+=w,u._logger.debug("fetchLoader,onProgress call,task,",u._range,", start,",k,", end,",A+u._receivedLength,", done,",h.done),u._onProcessMinLen>0?u._writeIdx+w>=u._onProcessMinLen||h.done?(E=new Uint8Array(u._writeIdx+w),E.set(u._cache.slice(0,u._writeIdx),0),w>0&&E.set(h.value,u._writeIdx),u._writeIdx=0,u._logger.debug("fetchLoader,onProgress enough,done,",h.done,",len,",E.byteLength,", writeIdx,",u._writeIdx)):w>0&&u._writeIdx+w<or?(u._cache.set(h.value,u._writeIdx),u._writeIdx+=w,u._logger.debug("fetchLoader,onProgress cache,len,",w,", writeIdx,",u._writeIdx)):w>0&&(B=new Uint8Array(u._writeIdx+w+2048),u._logger.debug("fetchLoader,onProgress extra start,size,",u._writeIdx+w+2048,", datalen,",w,", writeIdx,",u._writeIdx),B.set(u._cache.slice(0,u._writeIdx),0),w>0&&B.set(h.value,u._writeIdx),u._writeIdx+=w,delete u._cache,u._cache=B,u._logger.debug("fetchLoader,onProgress extra end,len,",w,", writeIdx,",u._writeIdx)):E=h.value,(E&&E.byteLength>0||h.done)&&(u._firstMaxChunkSize&&(u._firtstByte?u._cacheData&&(U=new Uint8Array(u._cacheData.byteLength+E.byteLength),U.set(u._cacheData,0),U.set(E,u._cacheData.byteLength),E=U,u._cacheData=null):(u._firtstByte++,R=E.slice(0,u._firstMaxChunkSize),u._cacheData=E.slice(u._firstMaxChunkSize),E=R)),i(E,h.done,{range:[u._range[0]+u._receivedLength-(E?E.byteLength:0),u._range[0]+u._receivedLength],vid:u._vid,index:u._index,startTime:d,endTime:f,st:a,firstByteTime:o,priOptions:u._priOptions},r)),h.done?(N=Date.now()-a,G=Nt(u._receivedLength,N),u.emit(V.REAL_TIME_SPEED,{speed:G,len:u._receivedLength,time:N,vid:u._vid,index:u._index,range:u._range,priOptions:u._priOptions}),u._running=!1,u._logger.debug("[fetchLoader onProgress end],task,",u._range,",done,",h.done),u.resolve(xt(h,!0,r,r.headers.get("Content-Length"),r.headers.get("age"),a,o,u._index,u._range,u._vid,u._priOptions))):u._firstMaxChunkSize?setTimeout(function(){v()},0):v();case 25:case"end":return p.stop()}},m,null,[[1,8]])}));return function(){return b.apply(this,arguments)}}();v()}},{key:"receiveLen",get:function(){return this._receivedLength}},{key:"running",get:function(){return this._running},set:function(r){this._running=r}}],[{key:"isSupported",value:function(){return typeof fetch<"u"}}]),e}(gt);function Si(n){return Qe({loaderType:Fe.FETCH,retry:0,retryDelay:0,timeout:0,request:null,onTimeout:void 0,onProgress:void 0,onRetryError:void 0,transformRequest:void 0,transformResponse:void 0,transformError:void 0,responseType:Ze.TEXT,range:void 0,url:"",params:void 0,method:"GET",headers:{},body:void 0,mode:void 0,credentials:void 0,cache:void 0,redirect:void 0,referrer:void 0,referrerPolicy:void 0,integrity:void 0,onProcessMinLen:0},n)}var bi=function(n){et(e,n);var s=tt(e);function e(){var t;return ge(this,e),t=s.call(this),L(F(t),"_xhr",null),L(F(t),"_aborted",!1),L(F(t),"_timeoutTimer",null),L(F(t),"_range",null),L(F(t),"_receivedLength",0),L(F(t),"_url",null),L(F(t),"_onProgress",null),L(F(t),"_index",-1),L(F(t),"_headers",null),L(F(t),"_currentChunkSizeKB",384),L(F(t),"_timeout",null),L(F(t),"_xhr",null),L(F(t),"_withCredentials",null),L(F(t),"_startTime",-1),L(F(t),"_loadCompleteResolve",null),L(F(t),"_loadCompleteReject",null),L(F(t),"_runing",!1),L(F(t),"_logger",!1),L(F(t),"_vid",""),L(F(t),"_responseType",void 0),L(F(t),"_credentials",void 0),L(F(t),"_method",void 0),L(F(t),"_transformResponse",void 0),L(F(t),"_firstRtt",void 0),L(F(t),"_onCancel",null),L(F(t),"_priOptions",null),t}return ye(e,[{key:"load",value:function(r){var i=this;clearTimeout(this._timeoutTimer),this._logger=r.logger,this._range=r.range,this._onProgress=r.onProgress,this._index=r.index,this._headers=r.headers,this._withCredentials=r.credentials==="include"||r.credentials==="same-origin",this._body=r.body||null,r.method&&(this._method=r.method),this._timeout=r.timeout||null,this._runing=!0,this._vid=r.vid||r.url,this._responseType=r.responseType,this._firstRtt=-1,this._onTimeout=r.onTimeout,this._onCancel=r.onCancel,this._request=r.request,this._priOptions=r.priOptions||{},this._logger.debug("xhrLoader task, range",this._range),this._url=Lr(r.url,r.params);var a=Date.now();return new Promise(function(o,u){i._loadCompleteResolve=o,i._loadCompleteReject=u,i._startLoad()}).catch(function(o){if(clearTimeout(i._timeoutTimer),i._runing=!1,!i._aborted)throw o=o instanceof Ae?o:new Ae(i._url,i._request),o.startTime=a,o.endTime=Date.now(),o.options={index:i._index,vid:i._vid,priOptions:i._priOptions},o})}},{key:"_startLoad",value:function(){var r=null;if(this._responseType===Ze.ARRAY_BUFFER&&this._range&&this._range.length>1)if(this._onProgress){this._firstRtt=-1;var i=this._currentChunkSizeKB*1024,a=this._range[0]+this._receivedLength,o=this._range[1];i<this._range[1]-a&&(o=a+i),r=[a,o],this._logger.debug("[xhr_loader->],tast :",this._range,", SubRange, ",r)}else r=this._range,this._logger.debug("[xhr_loader->],tast :",this._range,", allRange, ",r);this._internalOpen(r)}},{key:"_internalOpen",value:function(r){var i=this;try{this._startTime=Date.now();var a=this._xhr=new XMLHttpRequest;a.open(this._method||"GET",this._url,!0),a.responseType=this._responseType,this._timeout&&(a.timeout=this._timeout),a.withCredentials=this._withCredentials,a.onload=this._onLoad.bind(this),a.onreadystatechange=this._onReadyStatechange.bind(this),a.onerror=function(l){var c,h,d;i._running=!1;var f=new Ae(i._url,i._request,l==null||(c=l.currentTarget)===null||c===void 0?void 0:c.response,"xhr.onerror.status:"+(l==null||(h=l.currentTarget)===null||h===void 0?void 0:h.status)+",statusText,"+(l==null||(d=l.currentTarget)===null||d===void 0?void 0:d.statusText));f.options={index:i._index,range:i._range,vid:i._vid,priOptions:i._priOptions},i._loadCompleteReject(f)},a.ontimeout=function(l){i.cancel();var c=new Ae(i._url,i._request,{status:408},"timeout");i._onTimeout&&(c.isTimeout=!0,i._onTimeout(c,{index:i._index,range:i._range,vid:i._vid,priOptions:i._priOptions})),c.options={index:i._index,range:i._range,vid:i._vid,priOptions:i._priOptions},i._loadCompleteReject(c)};var o=this._headers||{},u=Dr(r);u&&(o.Range=u),o&&Object.keys(o).forEach(function(l){a.setRequestHeader(l,o[l])}),this._logger.debug("[xhr.send->] tast,",this._range,",load sub range, ",r),a.send(this._body)}catch(l){l.options={index:this._index,range:r,vid:this._vid,priOptions:this._priOptions},this._loadCompleteReject(l)}}},{key:"_onReadyStatechange",value:function(r){var i=r.target;i.readyState===2&&this._firstRtt<0&&(this._firstRtt=Date.now())}},{key:"_onLoad",value:function(r){var i,a=r.target.status;if(a<200||a>299){var o=new Ae(this._url,null,Qe(Qe({},r.target.response),{},{status:a}),"bad response,status:"+a);return o.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},this._loadCompleteReject(o)}var u=null,l=!1,c,h=((i=this._range)===null||i===void 0?void 0:i.length)>0?this._range[0]:0;if(this._responseType===Ze.ARRAY_BUFFER){var d,f=new Uint8Array(r.target.response);if(c=h+this._receivedLength,f&&f.byteLength>0){this._receivedLength+=f.byteLength;var v=Date.now()-this._startTime,b=Nt(this._receivedLength,v);this.emit(V.REAL_TIME_SPEED,{speed:b,len:this._receivedLength,time:v,vid:this._vid,index:this._index,range:[c,h+this._receivedLength],priOptions:this._priOptions})}u=f,((d=this._range)===null||d===void 0?void 0:d.length)>1&&this._range[1]&&this._receivedLength<this._range[1]-this._range[0]?l=!1:l=!0,this._logger.debug("[xhr load done->], tast :",this._range,", start",c,"end ",h+this._receivedLength,",dataLen,",f?f.byteLength:0,",receivedLength",this._receivedLength,",index,",this._index,", done,",l)}else l=!0,u=r.target.response;var m={ok:a>=200&&a<300,status:a,statusText:this._xhr.statusText,url:this._xhr.responseURL,headers:this._getHeaders(this._xhr),body:this._xhr.response};this._transformResponse&&(m=this._transformResponse(m,this._url)||m),this._onProgress&&this._onProgress(u,l,{index:this._index,vid:this._vid,range:[c,h+this._receivedLength],startTime:this._startTime,endTime:Date.now(),priOptions:this._priOptions},m),l?(this._runing=!1,this._loadCompleteResolve&&this._loadCompleteResolve(xt(this._onProgress?null:u,l,m,m.headers["content-length"],m.headers.age,this._startTime,this._firstRtt,this._index,this._range,this._vid,this._priOptions))):this._startLoad()}},{key:"cancel",value:function(){if(!this._aborted&&(this._aborted=!0,this._runing=!1,ht(Ge(e.prototype),"removeAllListeners",this).call(this),this._onCancel&&this._onCancel({index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions}),this._xhr))return this._xhr.abort()}},{key:"receiveLen",get:function(){return this._receivedLength}},{key:"running",get:function(){return this._running},set:function(r){this._running=r}},{key:"_getHeaders",value:function(r){var i=r.getAllResponseHeaders().trim().split(`\r
`),a={},o=ci(i),u;try{for(o.s();!(u=o.n()).done;){var l=u.value,c=l.split(": ");a[c[0].toLowerCase()]=c.slice(1).join(": ")}}catch(h){o.e(h)}finally{o.f()}return a}}],[{key:"isSupported",value:function(){return typeof XMLHttpRequest<"u"}}]),e}(gt),Ei=["retry","retryDelay","onRetryError","transformError"],wi=function(){function n(s,e){ge(this,n),this.promise=ze(),this.alive=!!e.onProgress,!e.logger&&(e.logger=new De("Loader")),this._loaderType=s,this._loader=s===Fe.FETCH&&typeof fetch<"u"?new Ft:new bi,this._config=e,this._retryCount=0,this._retryTimer=null,this._canceled=!1,this._retryCheckFunc=e.retryCheckFunc,this._logger=e.logger}return ye(n,[{key:"exec",value:function(){var e=this,t=this._config,r=t.retry,i=t.retryDelay,a=t.onRetryError,o=t.transformError,u=si(t,Ei),l=function(){var c=Oe(ue().mark(function h(){var d,f,v;return ue().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return m.prev=0,m.next=3,e._loader.load(u);case 3:d=m.sent,e.promise.resolve(d),m.next=27;break;case 7:if(m.prev=7,m.t0=m.catch(0),e._loader.running=!1,e._logger.debug("[task request catch err]",m.t0),!e._canceled){m.next=13;break}return m.abrupt("return");case 13:if(m.t0.loaderType=e._loaderType,m.t0.retryCount=e._retryCount,f=m.t0,o&&(f=o(f)||f),a&&e._retryCount>0&&a(f,e._retryCount,{index:u.index,vid:u.vid,range:u.range,priOptions:u.priOptions}),e._retryCount++,v=!0,e._retryCheckFunc&&(v=e._retryCheckFunc(m.t0)),!(v&&e._retryCount<=r)){m.next=26;break}return clearTimeout(e._retryTimer),e._logger.debug("[task request setTimeout],retry",e._retryCount,",retry range,",u.range),e._retryTimer=setTimeout(l,i),m.abrupt("return");case 26:e.promise.reject(f);case 27:case"end":return m.stop()}},h,null,[[0,7]])}));return function(){return c.apply(this,arguments)}}();return l(),this.promise}},{key:"cancel",value:function(){var s=Oe(ue().mark(function t(){return ue().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return clearTimeout(this._retryTimer),this._canceled=!0,this._loader.running=!1,i.abrupt("return",this._loader.cancel());case 4:case"end":return i.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()},{key:"running",get:function(){return this._loader&&this._loader.running}},{key:"loader",get:function(){return this._loader}}]),n}();function Ti(n){return n&&!n.paused&&!n.ended&&n.playbackRate!==0&&n.readyState!==0}function ki(n){if(!n)return{};if(typeof n.getVideoPlaybackQuality=="function"){var s=n.getVideoPlaybackQuality();return{droppedVideoFrames:s.droppedVideoFrames||s.corruptedVideoFrames,totalVideoFrames:s.totalVideoFrames,creationTime:s.creationTime}}return{droppedVideoFrames:n.webkitDroppedFrameCount,totalVideoFrames:n.webkitDecodedFrameCount,creationTime:performance.now()}}function ft(){for(var n=arguments.length,s=new Array(n),e=0;e<n;e++)s[e]=arguments[e];if(s=s.filter(Boolean),s.length<2)return s[0];var t=new Uint8Array(s.reduce(function(i,a){return i+a.byteLength},0)),r=0;return s.forEach(function(i){t.set(i,r),r+=i.byteLength}),t}function Ai(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return new Promise(function(s){return setTimeout(s,n)})}var Ke=function(n){et(e,n);var s=tt(e);function e(t){var r;return ge(this,e),r=s.call(this,t),L(F(r),"type",Fe.FETCH),L(F(r),"_queue",[]),L(F(r),"_alive",[]),L(F(r),"_currentTask",null),L(F(r),"_finnalUrl",""),L(F(r),"_config",void 0),r._config=Si(t),(r._config.loaderType===Fe.XHR||!Ft.isSupported())&&(r.type=Fe.XHR),r.log=t.logger,r}return ye(e,[{key:"isFetch",value:function(){return this.type===Fe.FETCH}},{key:"load",value:function(r){var i=this,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};typeof r=="string"||!r?a.url=r||a.url||this._config.url:a=r,a=Object.assign({},this._config,a),a.params&&(a.params=Object.assign({},a.params)),a.headers&&ar(a.headers)&&(a.headers=Object.assign({},a.headers)),a.body&&ar(a.body)&&(a.body=Object.assign({},a.body)),a.transformRequest&&(a=a.transformRequest(a)||a),a.logger=this.log;var o=new wi(this.type,a);return o.loader.on(V.REAL_TIME_SPEED,function(u){i.emit(V.REAL_TIME_SPEED,u)}),this._queue.push(o),this._queue.length===1&&(!this._currentTask||!this._currentTask.running)&&this._processTask(),o.promise}},{key:"cancel",value:function(){var t=Oe(ue().mark(function i(){var a;return ue().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return a=this._queue.map(function(l){return l.cancel()}).concat(this._alive.map(function(l){return l.cancel()})),this._currentTask&&a.push(this._currentTask.cancel()),this._queue=[],this._alive=[],u.next=6,Promise.all(a);case 6:return u.next=8,Ai();case 8:case"end":return u.stop()}},i,this)}));function r(){return t.apply(this,arguments)}return r}()},{key:"_processTask",value:function(){var r=this;if(this._currentTask=this._queue.shift(),!!this._currentTask){this._currentTask.alive&&this._alive.push(this._currentTask);var i=this._currentTask.exec().catch(function(a){});i&&typeof i.finally=="function"&&i.finally(function(){var a,o;(a=r._currentTask)!==null&&a!==void 0&&a.alive&&((o=r._alive)===null||o===void 0?void 0:o.length)>0&&(r._alive=r._alive.filter(function(u){return u&&u!==r._currentTask})),r._processTask()})}}}],[{key:"isFetchSupport",value:function(){return Ft.isSupported()}}]),e}(gt),Di=function(){function n(){ge(this,n),L(this,"_prevCurrentTime",0)}return ye(n,[{key:"do",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:3,r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;if(e){var a=e.currentTime,o=0;if(this._prevCurrentTime===a){var u=me.info(me.get(e),a);if(!u.buffers.length)return;r&&u.nextStart||u.nextStart&&u.nextStart-a<t?o=u.nextStart+.1:u.end&&u.end-a>i&&!e.seeking&&(o=a+.1)}this._prevCurrentTime=a,o&&a!==o&&(e.currentTime=o)}}}]),n}(),Li=function(){function n(s){var e=this;ge(this,n),L(this,"_seiSet",new Set),this.emitter=s,s.on(V.SEI,function(t){t&&e._seiSet.add(t)})}return ye(n,[{key:"throw",value:function(e,t){var r=this;if(!(e==null||!this._seiSet.size)){var i=e-.2,a=e+.2,o=[];this._seiSet.forEach(function(u){u.time>=i&&u.time<=a&&o.push(u)}),o.forEach(function(u){r._seiSet.delete(u),r.emitter.emit(V.SEI_IN_TIME,u)}),t&&this._seiSet.forEach(function(u){u.time<e-5&&r._seiSet.delete(u)})}}},{key:"reset",value:function(){this._seiSet.clear()}}]),n}(),Oi=1e3,Pi=50,Ri=3,Ii=3e3,Ci=function(){function n(s){ge(this,n),L(this,"_chunkSpeed",0),L(this,"_chunkCache",[]),L(this,"_speeds",[]),L(this,"_totalSize",0),L(this,"_totalCost",0),this._opts=s||{}}return ye(n,[{key:"addRecord",value:function(e,t){!e||!t||(this._speeds.push(8e3*e/t),this._speeds=this._speeds.slice(-Ri))}},{key:"addChunkRecord",value:function(e,t){var r,i;if(!(!e||!t||e<(((r=this._opts)===null||r===void 0?void 0:r.skipChunkSize)||Oi))){this._totalSize+=e,this._totalCost+=t,this._chunkSpeed=8e3*e/t,this._chunkCache.push({size:e,duration:t,timestamp:performance.now()});var a=((i=this._opts)===null||i===void 0?void 0:i.chunkCountForSpeed)||Pi;this._chunkCache.length>a&&(this._chunkCache=this._chunkCache.slice(-a))}}},{key:"getAvgSpeed",value:function(){var e;if(!this._chunkCache.length&&!this._speeds.length)return 0;if(this._speeds.length)return this._speeds.reduce(function(o,u){return o+=u})/this._speeds.length;var t=this._chunkCache[this._chunkCache.length-1],r=performance.now()-t.timestamp;r>(((e=this._opts)===null||e===void 0?void 0:e.longtimeNoReceived)||Ii)&&this._chunkCache.push({size:0,duration:r,timestamp:performance.now()});var i=this._chunkCache.reduce(function(o,u){return o+=u.size},0),a=this._chunkCache.reduce(function(o,u){return o+=u.duration},0);return 8e3*i/a}},{key:"getLatestSpeed",value:function(){return!this._chunkCache.length&&!this._speeds.length?0:this._speeds.length?this._speeds[this._speeds.length-1]:this._chunkSpeed}},{key:"getTotalSize",value:function(){return this._totalSize}},{key:"getTotalCost",value:function(){return this._totalCost}},{key:"reset",value:function(){this._chunkCache=[],this._speeds=[],this._totalSize=0,this._totalCost=0}}]),n}(),ur=function(){function n(s){ge(this,n),L(this,"encodeType",""),L(this,"audioCodec",""),L(this,"videoCodec",""),L(this,"domain",""),L(this,"fps",0),L(this,"bitrate",0),L(this,"width",0),L(this,"height",0),L(this,"samplerate",0),L(this,"channelCount",0),L(this,"gop",0),L(this,"_bitsAccumulateSize",0),L(this,"_bitsAccumulateDuration",0),L(this,"_startGopId",-1),this._timescale=s}return ye(n,[{key:"getStats",value:function(){return{encodeType:this.encodeType,audioCodec:this.audioCodec,videoCodec:this.videoCodec,domain:this.domain,fps:this.fps,bitrate:this.bitrate,width:this.width,height:this.height,samplerate:this.samplerate,channelCount:this.channelCount,gop:this.gop}}},{key:"setEncodeType",value:function(e){this.encodeType=e}},{key:"setFpsFromScriptData",value:function(e){var t,r=e.data,i=r==null||(t=r.onMetaData)===null||t===void 0?void 0:t.framerate;i&&i>0&&i<100&&(this.fps=i)}},{key:"setVideoMeta",value:function(e){if(this.width=e.width,this.height=e.height,this.videoCodec=e.codec,this.encodeType=e.codecType,e.fpsNum&&e.fpsDen){var t=e.fpsNum/e.fpsDen;t>0&&t<100&&(this.fps=t)}}},{key:"setAudioMeta",value:function(e){this.audioCodec=e.codec,this.samplerate=e.sampleRate,this.channelCount=e.channelCount}},{key:"setDomain",value:function(e){this.domain=e.split("/").slice(2,3)[0]}},{key:"updateBitrate",value:function(e){var t=this;if((!this.fps||this.fps>=100)&&e.length){var r=e.reduce(function(i,a){return i+=a.duration},0)/e.length;this.fps=Math.round(this._timescale/r)}e.forEach(function(i){t._startGopId===-1&&(t._startGopId=i.gopId),i.gopId===t._startGopId&&t.gop++,t._bitsAccumulateDuration+=i.duration/(t._timescale/1e3),t._bitsAccumulateSize+=i.units.reduce(function(a,o){return a+=o.length},0),t._bitsAccumulateDuration>=1e3&&(t.bitrate=t._bitsAccumulateSize*8,t._bitsAccumulateDuration=0,t._bitsAccumulateSize=0)})}}]),n}(),Mi=function(){function n(s){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1e3;ge(this,n),L(this,"_core",null),L(this,"_samples",[]),this._core=s,this._timescale=e,this._stats=new ur(e),this._bindEvents()}return ye(n,[{key:"getStats",value:function(){var e,t,r,i,a,o,u,l,c,h,d,f=((e=this._core)===null||e===void 0?void 0:e.media)||{},v=f.currentTime,b=v===void 0?0:v,m=f.decodeFps,y=m===void 0?0:m;return Qe(Qe({},this._stats.getStats()),{},{downloadSpeed:((t=this._core)===null||t===void 0||(r=t.speedInfo)===null||r===void 0?void 0:r.call(t).speed)||0,avgSpeed:((i=this._core)===null||i===void 0||(a=i.speedInfo)===null||a===void 0?void 0:a.call(i).avgSpeed)||0,totalReceivedByte:((o=this._core)===null||o===void 0||(u=o.speedInfo)===null||u===void 0?void 0:u.call(o).totalSize)||0,totalReceivedCost:((l=this._core)===null||l===void 0||(c=l.speedInfo)===null||c===void 0?void 0:c.call(l).totalCost)||0,currentTime:b,bufferEnd:((h=this._core)===null||h===void 0||(d=h.bufferInfo())===null||d===void 0?void 0:d.remaining)||0,decodeFps:y})}},{key:"_bindEvents",value:function(){var e=this;this._core.on(V.DEMUXED_TRACK,function(t){var r=t.videoTrack;return e._stats.updateBitrate(r.samples)}),this._core.on(V.FLV_SCRIPT_DATA,function(t){e._stats.setFpsFromScriptData(t)}),this._core.on(V.METADATA_PARSED,function(t){t.type==="video"?e._stats.setVideoMeta(t.track):e._stats.setAudioMeta(t.track)}),this._core.on(V.TTFB,function(t){e._stats.setDomain(t.responseUrl)})}},{key:"reset",value:function(){this._samples=[],this._stats=new ur(this._timescale)}}]),n}();function Ui(n,s){var e=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(e!=null){var t,r,i,a,o=[],u=!0,l=!1;try{if(i=(e=e.call(n)).next,s===0){if(Object(e)!==e)return;u=!1}else for(;!(u=(t=i.call(e)).done)&&(o.push(t.value),o.length!==s);u=!0);}catch(c){l=!0,r=c}finally{try{if(!u&&e.return!=null&&(a=e.return(),Object(a)!==a))return}finally{if(l)throw r}}return o}}function re(n,s){if(!(n instanceof s))throw new TypeError("Cannot call a class as a function")}function lr(n,s){for(var e=0;e<s.length;e++){var t=s[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,Or(t.key),t)}}function ie(n,s,e){return s&&lr(n.prototype,s),e&&lr(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n}function O(n,s,e){return s=Or(s),s in n?Object.defineProperty(n,s,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[s]=e,n}function Bi(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),s&&Vt(n,s)}function pt(n){return pt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},pt(n)}function Vt(n,s){return Vt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},Vt(n,s)}function xi(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Ni(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function Fi(n,s){if(s&&(typeof s=="object"||typeof s=="function"))return s;if(s!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Ni(n)}function Vi(n){var s=xi();return function(){var t=pt(n),r;if(s){var i=pt(this).constructor;r=Reflect.construct(t,arguments,i)}else r=t.apply(this,arguments);return Fi(this,r)}}function Gi(n,s){return ji(n)||Ui(n,s)||zt(n,s)||Ki()}function pe(n){return Hi(n)||zi(n)||zt(n)||$i()}function Hi(n){if(Array.isArray(n))return Gt(n)}function ji(n){if(Array.isArray(n))return n}function zi(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function zt(n,s){if(n){if(typeof n=="string")return Gt(n,s);var e=Object.prototype.toString.call(n).slice(8,-1);if(e==="Object"&&n.constructor&&(e=n.constructor.name),e==="Map"||e==="Set")return Array.from(n);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Gt(n,s)}}function Gt(n,s){(s==null||s>n.length)&&(s=n.length);for(var e=0,t=new Array(s);e<s;e++)t[e]=n[e];return t}function $i(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ki(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Yi(n,s){var e=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(!e){if(Array.isArray(n)||(e=zt(n))||s&&n&&typeof n.length=="number"){e&&(n=e);var t=0,r=function(){};return{s:r,n:function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}},e:function(u){throw u},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,a=!1,o;return{s:function(){e=e.call(n)},n:function(){var u=e.next();return i=u.done,u},e:function(u){a=!0,o=u},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(a)throw o}}}}function Wi(n,s){if(typeof n!="object"||n===null)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var t=e.call(n,s||"default");if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(n)}function Or(n){var s=Wi(n,"string");return typeof s=="symbol"?s:String(s)}var Ie={VIDEO:"video",AUDIO:"audio",METADATA:"metadata"},Ce={AV1:"av1",AVC:"avc",HEVC:"hevc"},Se={AAC:"aac",G711PCMA:"g7110a",G711PCMU:"g7110m",OPUS:"opus",MP3:"mp3"},we={LARGE_AV_SHIFT:"LARGE_AV_SHIFT",LARGE_VIDEO_GAP:"LARGE_VIDEO_GAP",LARGE_VIDEO_GAP_BETWEEN_CHUNK:"LARGE_VIDEO_GAP_BETWEEN_CHUNK",LARGE_AUDIO_GAP:"LARGE_AUDIO_GAP",AUDIO_FILLED:"AUDIO_FILLED",AUDIO_DROPPED:"AUDIO_DROPPED"},Pr=function(){function n(){re(this,n),O(this,"id",1),O(this,"type",Ie.VIDEO),O(this,"codecType",Ce.AVC),O(this,"pid",-1),O(this,"hvcC",void 0),O(this,"codec",""),O(this,"timescale",0),O(this,"formatTimescale",0),O(this,"sequenceNumber",0),O(this,"baseMediaDecodeTime",0),O(this,"baseDts",0),O(this,"duration",0),O(this,"warnings",[]),O(this,"samples",[]),O(this,"pps",[]),O(this,"sps",[]),O(this,"vps",[]),O(this,"fpsNum",0),O(this,"fpsDen",0),O(this,"sarRatio",[]),O(this,"width",0),O(this,"height",0),O(this,"nalUnitSize",4),O(this,"present",!1),O(this,"isVideoEncryption",!1),O(this,"isAudioEncryption",!1),O(this,"isVideo",!0),O(this,"lastKeyFrameDts",0),O(this,"kid",null),O(this,"pssh",null),O(this,"ext",void 0)}return ie(n,[{key:"reset",value:function(){this.sequenceNumber=this.width=this.height=this.fpsDen=this.fpsNum=this.duration=this.baseMediaDecodeTime=this.timescale=0,this.codec="",this.present=!1,this.pid=-1,this.pps=[],this.sps=[],this.vps=[],this.sarRatio=[],this.samples=[],this.warnings=[],this.hvcC=null}},{key:"firstDts",get:function(){return this.samples.length?this.samples[0].dts:null}},{key:"firstPts",get:function(){return this.samples.length?this.samples[0].pts:null}},{key:"samplesDuration",get:function(){if(this.samples.length>0){var e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}},{key:"exist",value:function(){return/av01/.test(this.codec)?!0:!!(this.pps.length&&this.sps.length&&this.codec)}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isVideoEncryption}}]),n}(),Rr=function(){function n(){re(this,n),O(this,"id",2),O(this,"type",Ie.AUDIO),O(this,"codecType",Se.AAC),O(this,"pid",-1),O(this,"codec",""),O(this,"container",""),O(this,"sequenceNumber",0),O(this,"sampleDuration",0),O(this,"timescale",0),O(this,"formatTimescale",0),O(this,"baseMediaDecodeTime",0),O(this,"duration",0),O(this,"warnings",[]),O(this,"samples",[]),O(this,"baseDts",0),O(this,"sampleSize",16),O(this,"sampleRate",0),O(this,"channelCount",0),O(this,"objectType",0),O(this,"sampleRateIndex",0),O(this,"config",[]),O(this,"present",!1),O(this,"isVideoEncryption",!1),O(this,"isAudioEncryption",!1),O(this,"kid",null),O(this,"ext",void 0)}return ie(n,[{key:"reset",value:function(){this.sequenceNumber=0,this.timescale=0,this.sampleDuration=0,this.sampleRate=0,this.channelCount=0,this.baseMediaDecodeTime=0,this.present=!1,this.pid=-1,this.codec="",this.samples=[],this.config=[],this.warnings=[]}},{key:"exist",value:function(){return!!(this.sampleRate&&this.channelCount&&(this.codec||this.container)&&(this.codecType===Se.AAC||this.codecType===Se.G711PCMA||this.codecType===Se.G711PCMU||this.codecType===Se.OPUS||this.codecType===Se.MP3))}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isAudioEncryption}},{key:"firstDts",get:function(){return this.samples.length?this.samples[0].dts:null}},{key:"firstPts",get:function(){return this.samples.length?this.samples[0].pts:null}},{key:"samplesDuration",get:function(){if(this.samples.length>0){var e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}}]),n}(),Ht=function(){function n(s,e,t){re(this,n),O(this,"flag",{}),O(this,"keyframe",!1),O(this,"gopId",0),O(this,"duration",0),O(this,"size",0),O(this,"units",[]),O(this,"chromaFormat",420),this.originPts=this.pts=s,this.originDts=this.dts=e,t&&(this.units=t)}return ie(n,[{key:"cts",get:function(){return this.pts-this.dts}},{key:"setToKeyframe",value:function(){this.keyframe=!0,this.flag.dependsOn=2,this.flag.isNonSyncSample=0}}]),n}(),qe=ie(function n(s,e,t,r){re(this,n),O(this,"duration",1024),O(this,"flag",{dependsOn:2,isNonSyncSample:0}),O(this,"keyframe",!0),this.originPts=this.pts=this.dts=s,this.data=e,this.size=e.byteLength,this.sampleOffset=r,t&&(this.duration=t)}),qi=ie(function n(s,e){re(this,n),O(this,"time",0),this.data=s,this.originPts=this.pts=e}),Xi=function(n){Bi(e,n);var s=Vi(e);function e(){return re(this,e),s.apply(this,arguments)}return ie(e)}(qi),Ir=function(){function n(){re(this,n),O(this,"id",3),O(this,"type",Ie.METADATA),O(this,"timescale",0),O(this,"flvScriptSamples",[]),O(this,"seiSamples",[])}return ie(n,[{key:"exist",value:function(){return!!((this.flvScriptSamples.length||this.seiSamples.length)&&this.timescale)}},{key:"reset",value:function(){this.timescale=0,this.flvScriptSamples=[],this.seiSamples=[]}},{key:"hasSample",value:function(){return!!(this.flvScriptSamples.length||this.seiSamples.length)}}]),n}(),mt=function(){function n(s){re(this,n),this.name=s||"",this._prefix="[".concat(this.name,"]")}return ie(n,[{key:"warn",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).warn.apply(e,[this._prefix].concat(r))}}}],[{key:"enable",value:function(){n.disabled=!1}},{key:"disable",value:function(){n.disabled=!0}}]),n}();O(mt,"disabled",!0);var St=typeof window<"u",$t=St&&navigator.userAgent.toLocaleLowerCase(),Qi=St&&/^((?!chrome|android).)*safari/.test($t),Cr=St&&$t.includes("firefox"),Ji=St&&$t.includes("android"),Le=function(){function n(){re(this,n)}return ie(n,null,[{key:"getRateIndexByRate",value:function(e){return n.FREQ.indexOf(e)}},{key:"parseADTS",value:function(e,t){for(var r=e.length,i=0;i+2<r&&!(e[i]===255&&(e[i+1]&246)===240);)i++;if(!(i>=r)){var a=i,o=[],u=(e[i+2]&60)>>>2,l=n.FREQ[u];if(!l)throw new Error("Invalid sampling index: ".concat(u));for(var c=((e[i+2]&192)>>>6)+1,h=(e[i+2]&1)<<2|(e[i+3]&192)>>>6,d=n._getConfig(u,h,c),f=d.config,v=d.codec,b,m,y=0,A=n.getFrameDuration(l);i+7<r;){if(e[i]!==255||(e[i+1]&246)!==240){i++;continue}if(m=(e[i+3]&3)<<11|e[i+4]<<3|(e[i+5]&224)>>5,!m||r-i<m)break;b=(~e[i+1]&1)*2,o.push({pts:t+y*A,data:e.subarray(i+7+b,i+m)}),y++,i+=m}return{skip:a,remaining:i>=r?void 0:e.subarray(i),frames:o,samplingFrequencyIndex:u,sampleRate:l,objectType:c,channelCount:h,codec:v,config:f,originCodec:"mp4a.40.".concat(c)}}}},{key:"parseAudioSpecificConfig",value:function(e){if(e.length){var t=e[0]>>>3,r=(e[0]&7)<<1|e[1]>>>7,i=(e[1]&120)>>>3,a=n.FREQ[r];if(a){var o=n._getConfig(r,i,t),u=o.config,l=o.codec;return{samplingFrequencyIndex:r,sampleRate:a,objectType:t,channelCount:i,config:u,codec:l,originCodec:"mp4a.40.".concat(t)}}}}},{key:"getFrameDuration",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4;return 1024*t/e}},{key:"_getConfig",value:function(e,t,r){var i=[],a,o;return Cr?e>=6?(a=5,o=e-3):(a=2,o=e):Ji?(a=2,o=e):(a=5,o=e,e>=6?o=e-3:t===1&&(a=2,o=e)),i[0]=a<<3,i[0]|=(e&14)>>1,i[1]=(e&1)<<7,i[1]|=t<<3,a===5&&(i[1]|=(o&14)>>1,i[2]=(o&1)<<7,i[2]|=8,i[3]=0),{config:i,codec:"mp4a.40.".concat(a)}}},{key:"getSilentFrame",value:function(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}]),n}();O(Le,"FREQ",[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]);function _e(){for(var n=arguments.length,s=new Array(n),e=0;e<n;e++)s[e]=arguments[e];s=s.filter(Boolean);var t=new Uint8Array(s.reduce(function(i,a){return i+a.byteLength},0)),r=0;return s.forEach(function(i){t.set(i,r),r+=i.byteLength}),t}var Zi=Math.pow(2,32);function ee(n){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[s]<<8)+(n[s+1]||0)}function en(n){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[s]<<16)+(n[s+1]<<8)+(n[s+2]||0)}function C(n){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[s]<<24>>>0)+(n[s+1]<<16)+(n[s+2]<<8)+(n[s+3]||0)}function Ne(n){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return C(n,s)*Zi+C(n,s+4)}function Mr(n){for(var s="avc1.",e,t=0;t<3;t++)e=n[t].toString(16),e.length<2&&(e="0".concat(e)),s+=e;return s}function cr(n){if(!Array.isArray(n)){for(var s=[],e="",t=0;t<n.length;t++)t%2&&(e=n[t-1]+n[t],s.push(parseInt(e,16)),e="");return s}return n.map(function(r){return parseInt(r,16)})}function kt(n,s){return+(n+"."+s)}function tn(n){if(n.length<5)return 0;var s=Math.hypot(n[0],n[3]),e=Math.hypot(n[1],n[4]);return s===0||e===0?0:180*Math.atan2(n[1]/e,n[0]/s)/Math.PI}var Re=function(){function n(){re(this,n)}return ie(n,null,[{key:"parseAnnexB",value:function(e){var t=e.byteLength-1,r=0;do{if(e[t]===0)r++;else break;t--}while(t>0);r>=3&&(e=e.subarray(0,t+1));for(var i=e.length,a=2,o=0;e[a]!==null&&e[a]!==void 0&&e[a]!==1;)a++;if(a++,o=a+2,o>=i)return[];for(var u=[];o<i;)switch(e[o]){case 0:if(e[o-1]!==0){o+=2;break}else if(e[o-2]!==0){o++;break}else if(o<i-1&&e[o+1]!==1){o++;break}a!==o-2&&u.push(e.subarray(a,o-2));do o++;while(e[o]!==1&&o<i);a=o+1,o=a+2;break;case 1:if(e[o-1]!==0||e[o-2]!==0){o+=3;break}a!==o-2&&u.push(e.subarray(a,o-2)),a=o+1,o=a+2;break;default:o+=3;break}return a<i&&u.push(e.subarray(a)),u}},{key:"parseAvcC",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4;if(!(e.length<4)){for(var r=e.length,i=[],a=0,o;a+t<r;)if(o=C(e,a),t===3&&(o>>>=8),a+=t,!!o){if(a+o>r)break;i.push(e.subarray(a,a+o)),a+=o}return i}}},{key:"parseSEI",value:function(e,t){for(var r=e.length,i=t?2:1,a=0,o=0,u="";e[i]===255;)a+=255,i++;for(a+=e[i++];e[i]===255;)o+=255,i++;if(o+=e[i++],a===5&&r>i+16)for(var l=0;l<16;l++)u+=e[i].toString(16),i++;return{payload:e.subarray(i,i+o),type:a,size:o,uuid:u}}},{key:"removeEPB",value:function(e){for(var t=e.byteLength,r=[],i=1;i<t-2;)e[i]===0&&e[i+1]===0&&e[i+2]===3?(r.push(i+2),i+=2):i++;if(!r.length)return e;var a=t-r.length,o=new Uint8Array(a),u=0;for(i=0;i<a;u++,i++)u===r[0]&&(u++,r.shift()),o[i]=e[u];return o}}]),n}(),jt=function(){function n(s){if(re(this,n),O(this,"_bytesAvailable",void 0),O(this,"_bitsAvailable",0),O(this,"_word",0),!s)throw new Error("ExpGolomb data params is required");this._data=s,this._bytesAvailable=s.byteLength,this._bytesAvailable&&this._loadWord()}return ie(n,[{key:"bitsAvailable",get:function(){return this._bitsAvailable}},{key:"_loadWord",value:function(){var e=this._data.byteLength-this._bytesAvailable,t=Math.min(4,this._bytesAvailable);if(t===0)throw new Error("No bytes available");var r=new Uint8Array(4);r.set(this._data.subarray(e,e+t)),this._word=new DataView(r.buffer).getUint32(0),this._bitsAvailable=t*8,this._bytesAvailable-=t}},{key:"skipBits",value:function(e){if(this._bitsAvailable>e)this._word<<=e,this._bitsAvailable-=e;else{e-=this._bitsAvailable;var t=Math.floor(e/8);e-=t*8,this._bytesAvailable-=t,this._loadWord(),this._word<<=e,this._bitsAvailable-=e}}},{key:"readBits",value:function(e){if(e>32)throw new Error("Cannot read more than 32 bits");var t=Math.min(this._bitsAvailable,e),r=this._word>>>32-t;return this._bitsAvailable-=t,this._bitsAvailable>0?this._word<<=t:this._bytesAvailable>0&&this._loadWord(),t=e-t,t>0&&this._bitsAvailable?r<<t|this.readBits(t):r}},{key:"skipLZ",value:function(){var e;for(e=0;e<this._bitsAvailable;++e)if(this._word&2147483648>>>e)return this._word<<=e,this._bitsAvailable-=e,e;return this._loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBool",value:function(){return this.readBits(1)===1}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"skipScalingList",value:function(e){for(var t=8,r=8,i,a=0;a<e;a++)r!==0&&(i=this.readEG(),r=(t+i+256)%256),t=r===0?t:r}}]),n}(),rn=function(){function n(){re(this,n)}return ie(n,null,[{key:"parseAVCDecoderConfigurationRecord",value:function(e){if(!(e.length<7)){for(var t=(e[4]&3)+1,r,i=[],a=[],o=6,u=e[5]&31,l,c=0;c<u;c++)if(l=e[o]<<8|e[o+1],o+=2,!!l){var h=e.subarray(o,o+l);o+=l,i.push(h),r||(r=n.parseSPS(Re.removeEPB(h)))}var d=e[o];o++;for(var f,v=0;v<d;v++)f=e[o]<<8|e[o+1],o+=2,f&&(a.push(e.subarray(o,o+f)),o+=f);return{sps:r,spsArr:i,ppsArr:a,nalUnitSize:t}}}},{key:"parseSPS",value:function(e){var t=new jt(e);t.readUByte();var r=t.readUByte(),i=t.readUByte(),a=t.readUByte();t.skipUEG();var o=420;if(r===100||r===110||r===122||r===244||r===44||r===83||r===86||r===118||r===128||r===138||r===144){var u=t.readUEG();if(u<=3&&(o=[0,420,422,444][u]),u===3&&t.skipBits(1),t.skipUEG(),t.skipUEG(),t.skipBits(1),t.readBool())for(var l=u!==3?8:12,c=0;c<l;c++)t.readBool()&&(c<6?t.skipScalingList(16):t.skipScalingList(64))}t.skipUEG();var h=t.readUEG();if(h===0)t.readUEG();else if(h===1){t.skipBits(1),t.skipUEG(),t.skipUEG();for(var d=t.readUEG(),f=0;f<d;f++)t.skipUEG()}t.skipUEG(),t.skipBits(1);var v=t.readUEG(),b=t.readUEG(),m=t.readBits(1);m===0&&t.skipBits(1),t.skipBits(1);var y=0,A=0,k=0,w=0;t.readBool()&&(y=t.readUEG(),A=t.readUEG(),k=t.readUEG(),w=t.readUEG());var E,B,R,U,N;if(t.readBool()){if(t.readBool()){var G=t.readUByte();switch(G){case 1:E=[1,1];break;case 2:E=[12,11];break;case 3:E=[10,11];break;case 4:E=[16,11];break;case 5:E=[40,33];break;case 6:E=[24,11];break;case 7:E=[20,11];break;case 8:E=[32,11];break;case 9:E=[80,33];break;case 10:E=[18,11];break;case 11:E=[15,11];break;case 12:E=[64,33];break;case 13:E=[160,99];break;case 14:E=[4,3];break;case 15:E=[3,2];break;case 16:E=[2,1];break;case 255:{E=[t.readUByte()<<8|t.readUByte(),t.readUByte()<<8|t.readUByte()];break}}}if(t.readBool()&&t.readBool(),t.readBool()&&(t.readBits(4),t.readBool()&&t.readBits(24)),t.readBool()&&(t.readUEG(),t.readUEG()),t.readBool()){var z=t.readBits(32),p=t.readBits(32);B=t.readBool(),R=p,U=z*2,N=R/U}}return{codec:Mr(e.subarray(1,4)),profileIdc:r,profileCompatibility:i,levelIdc:a,chromaFormat:o,width:Math.ceil((v+1)*16-2*(y+A)),height:(2-m)*(b+1)*16-(m?2:4)*(k+w),sarRatio:E,fpsNum:R,fpsDen:U,fps:N,fixedFrame:B}}}]),n}(),hr=function(){function n(){re(this,n)}return ie(n,null,[{key:"parseHEVCDecoderConfigurationRecord",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!(e.length<23)){t=t||{};for(var r=(e[21]&3)+1,i,a,o=[],u=[],l=[],c=23,h=e[22],d,f,v,b=0;b<h;b++){d=e[c]&63,f=e[c+1]<<8|e[c+2],c+=3;for(var m=0;m<f;m++)if(v=e[c]<<8|e[c+1],c+=2,!!v){switch(d){case 32:{var y=e.subarray(c,c+v);i||(i=n.parseVPS(Re.removeEPB(y),t)),l.push(y)}break;case 33:{var A=e.subarray(c,c+v);a||(a=n.parseSPS(Re.removeEPB(A),t)),o.push(A)}break;case 34:u.push(e.subarray(c,c+v));break}c+=v}}return{hvcC:t,sps:a,spsArr:o,ppsArr:u,vpsArr:l,nalUnitSize:r}}}},{key:"parseVPS",value:function(e,t){t=t||{};var r=new jt(e);r.readUByte(),r.readUByte(),r.readBits(12);var i=r.readBits(3);return t.numTemporalLayers=Math.max(t.numTemporalLayers||0,i+1),r.readBits(17),n._parseProfileTierLevel(r,i,t),t}},{key:"parseSPS",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};t=t||{};var r=new jt(e);r.readUByte(),r.readUByte(),r.readBits(4);var i=r.readBits(3);t.numTemporalLayers=Math.max(i+1,t.numTemporalLayers||0),t.temporalIdNested=r.readBits(1),n._parseProfileTierLevel(r,i,t),r.readUEG();var a=t.chromaFormatIdc=r.readUEG(),o=420;a<=3&&(o=[0,420,422,444][a]);var u=0;a===3&&(u=r.readBits(1));var l=r.readUEG(),c=r.readUEG(),h=r.readBits(1),d,f,v,b;if(h===1&&(d=r.readUEG(),f=r.readUEG(),v=r.readUEG(),b=r.readUEG()),t.bitDepthLumaMinus8=r.readUEG(),t.bitDepthChromaMinus8=r.readUEG(),h===1){var m=(a===1||a===2)&&u===0?2:1,y=a===1&&u===0?2:1;l-=m*(f+d),c-=y*(b+v)}return{codec:"hev1.1.6.L93.B0",width:l,height:c,chromaFormat:o,hvcC:t}}},{key:"_parseProfileTierLevel",value:function(e,t,r){var i=r.generalTierFlag||0;r.generalProfileSpace=e.readBits(2),r.generalTierFlag=Math.max(e.readBits(1),i),r.generalProfileIdc=Math.max(e.readBits(5),r.generalProfileIdc||0),r.generalProfileCompatibilityFlags=e.readBits(32),r.generalConstraintIndicatorFlags=[e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8)];var a=e.readBits(8);i<r.generalTierFlag?r.generalLevelIdc=a:r.generalLevelIdc=Math.max(a,r.generalLevelIdc||0);var o=[],u=[];if(t>e.bitsAvailable)throw new Error("maxSubLayersMinus inavlid size ".concat(t));for(var l=0;l<t;l++)o[l]=e.readBits(1),u[l]=e.readBits(1);t>0&&e.readBits((8-t)*2);for(var c=0;c<t;c++)o[c]!==0&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),u[c]!==0&&e.readBits(8)}}]),n}(),nn=9e4/2,fr=3,at=9e4,At=5*9e4,Dt=9e4,an=9e4/2,sn=9e4*5,on=function(){function n(s,e,t,r){re(this,n),this.videoTrack=s,this.audioTrack=e,this.metadataTrack=t,this._baseDts=-1,this._baseVideoDts=-1,this._baseAudioDts=-1,this._baseDtsInited=!1,this._audioNextPts=void 0,this._videoNextDts=void 0,this._audioTimestampBreak=!1,this._videoTimestampBreak=!1,this._lastAudioExceptionGapDot=0,this._lastAudioExceptionOverlapDot=0,this._lastAudioExceptionLargeGapDot=0,this._needForceFixLargeGap=r==null?void 0:r.forceFixLargeGap,this._largeGapThreshold=(r==null?void 0:r.largeGapThreshold)||sn}return ie(n,[{key:"fix",value:function(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;t=Math.round(t*9e4);var a=this.videoTrack,o=this.audioTrack,u=a.samples,l=o.samples;if(!(!u.length&&!l.length)){var c=u[0],h=l[0],d=0;if(u.length&&l.length&&(d=c.dts-h.pts),this._baseDtsInited||this._calculateBaseDts(this.audioTrack,this.videoTrack),r&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=t,this._baseAudioDts-=t,this._baseVideoDts-=t),!i){this._videoNextDts=d>0?t+d:t,this._audioNextPts=d>0?t:t-d,this._needForceFixLargeGap&&(this._videoNextDts=0,this._audioNextPts=0);var f=c?c.dts-this._baseDts-this._videoNextDts:0,v=h?h.pts-this._baseDts-this._audioNextPts:0;Math.abs(f||v)>Dt&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=t)}if(this._resetBaseDtsWhenStreamBreaked(),this._fixAudio(o),this._fixVideo(a),this.metadataTrack.exist()){var b=this.metadataTrack.timescale;this.metadataTrack.seiSamples.forEach(function(m){m.pts=m.originPts-e._baseDts,m.time=Math.max(0,m.pts)/b})}a.samples.length&&(a.baseMediaDecodeTime=a.samples[0].dts),o.samples.length&&(o.baseMediaDecodeTime=o.samples[0].pts*o.timescale/9e4)}}},{key:"_fixVideo",value:function(e){var t=this,r=e.samples;if(r.length){if(r.forEach(function(R){R.dts-=t._needForceFixLargeGap?t._baseVideoDts:t._baseDts,R.pts-=t._needForceFixLargeGap?t._baseVideoDts:t._baseDts}),this._videoNextDts===void 0){var i=r[0];this._videoNextDts=i.dts}var a=r.length,o=0,u=r[0],l=r[1],c=this._videoNextDts-u.dts;if(Math.abs(c)>an){var h;if(e.warnings.push({type:we.LARGE_VIDEO_GAP_BETWEEN_CHUNK,nextDts:this._videoNextDts/90,firstSampleDts:u.dts/90,nextSampleDts:(((h=r[1])===null||h===void 0?void 0:h.dts)||0)/90,sampleDuration:c/90}),u.dts+=c,u.pts+=c,l&&Math.abs(l.dts-u.dts)>Dt)this._videoTimestampBreak=!0,r.forEach(function(R,U){U!==0&&(R.dts+=c,R.pts+=c)});else for(var d=1;d<=a-1;d++){var f,v=(f=r[d])===null||f===void 0?void 0:f.dts,b=r[d-1].dts;v&&v-b<0&&(r[d].dts+=c,r[d].pts+=c)}}var m;if(e.fpsNum&&e.fpsDen&&(m=e.timescale*(e.fpsDen/e.fpsNum)),m<90*10&&(m=0),!m){var y=e.samples[0],A=e.samples[1];m=a===1?9e3:Math.floor(A.dts-y.dts)}for(var k=0;k<a;k++){var w=r[k].dts,E=r[k+1];if(k<a-1?o=E.dts-w:r[k-1]?o=Math.min(w-r[k-1].dts,m):o=m,o>Dt||o<0){this._videoTimestampBreak=!0,o=this._audioTimestampBreak?m:Math.max(o,30*90);var B=this._audioNextPts||0;E&&E.dts>B&&(o=m),e.warnings.push({type:we.LARGE_VIDEO_GAP,time:w/e.timescale,dts:w,originDts:r[k].originDts,nextDts:this._videoNextDts,sampleDuration:o,refSampleDuration:m})}r[k].duration=o,this._videoNextDts+=o}}}},{key:"_fixAudio",value:function(e){var t=this,r=e.samples;if(r.length){if(e.codecType===Se.MP3){this.lastAudioSample&&r.unshift(this.lastAudioSample);for(var i=0;i<r.length;i++){var a=r[i];if(r[i+1])a.duration=r[i+1].pts-a.pts;else break;a.pts-=this._baseDts,a.dts=a.pts}this.lastAudioSample=r.pop();return}r.forEach(function(o){o.pts-=t._needForceFixLargeGap?t._baseAudioDts:t._baseDts,o.dts=o.pts}),this._doFixAudioInternal(e,r,9e4)}}},{key:"_calculateBaseDts",value:function(e,t){var r=e.samples,i=t.samples;if(!r.length&&!i.length)return!1;var a=1/0,o=1/0;r.length&&(e.baseDts=a=r[0].pts,this._baseAudioDts=a),i.length&&(t.baseDts=o=i[0].dts,this._baseVideoDts=o),this._baseDts=Math.min(a,o);var u=o-a,l=!1;return Number.isFinite(u)&&Math.abs(u)>nn&&t.warnings.push({type:we.LARGE_AV_SHIFT,videoBaseDts:o,audioBasePts:a,baseDts:this._baseDts,delta:u}),Number.isFinite(u)&&Math.abs(u)>this._largeGapThreshold*at&&(l=!0),this._baseDtsInited||(l&&this._needForceFixLargeGap?this._needForceFixLargeGap=!0:this._needForceFixLargeGap=!1),this._baseDtsInited=!0,!0}},{key:"_resetBaseDtsWhenStreamBreaked",value:function(){if(this._baseDtsInited&&this._videoTimestampBreak&&this._audioTimestampBreak){var e=this._calculateBaseDts(this.audioTrack,this.videoTrack);if(!e)return;this._baseDts-=Math.min(this._audioNextPts,this._videoNextDts),this._audioLastSample=null,this._videoLastSample=null,this._videoTimestampBreak=!1,this._audioTimestampBreak=!1}}},{key:"_doFixAudioInternal",value:function(e,t,r){e.sampleDuration||(e.sampleDuration=Le.getFrameDuration(e.timescale,r));var i=e.sampleDuration;if(this._audioNextPts===void 0){var a=t[0];this._audioNextPts=a.pts}for(var o=0;o<t.length;o++){var u=this._audioNextPts,l=t[o],c=l.pts-u;if(!this._audioTimestampBreak&&c>=fr*i&&c<=at&&!Qi){var h=Le.getSilentFrame(e.codec,e.channelCount)||t[0].data.subarray(),d=Math.floor(c/i);Math.abs(l.pts-this._lastAudioExceptionGapDot)>At&&(this._lastAudioExceptionGapDot=l.pts),e.warnings.push({type:we.AUDIO_FILLED,pts:l.pts/90,originPts:l.originPts,count:d,nextPts:u/90,refSampleDuration:i});for(var f=0;f<d;f++){var v=new qe(Math.floor(u),h);v.originPts=Math.floor(this._baseDts+u),t.splice(o,0,v),this._audioNextPts+=i,o++}o--}else c<=-fr*i&&c>=-1*at?(Math.abs(l.pts-this._lastAudioExceptionOverlapDot)>At&&(this._lastAudioExceptionOverlapDot=l.pts,e.warnings.push({type:we.AUDIO_DROPPED,pts:l.pts/90,originPts:l.originPts,nextPts:u/90,refSampleDuration:i})),t.splice(o,1),o--):(Math.abs(c)>=at&&(this._audioTimestampBreak=!0,Math.abs(l.pts-this._lastAudioExceptionLargeGapDot)>At&&(this._lastAudioExceptionLargeGapDot=l.pts,e.warnings.push({type:we.LARGE_AUDIO_GAP,time:l.pts/1e3,pts:l.pts/90,originPts:l.originPts,nextPts:u/90,sampleDuration:c,refSampleDuration:i}))),l.dts=l.pts=u,this._audioNextPts+=i)}}}]),n}(),un=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],ln=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],cn=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],hn=[0,1,1,4],st=null,dr=function(){function n(){re(this,n)}return ie(n,null,[{key:"isHeader",value:function(e,t){return t+1<e.length&&e[t]===255&&(e[t+1]&224)===224&&(e[t+1]&6)!==0}},{key:"appendFrame",value:function(e,t,r,i,a){if(!(r+24>t.length)){var o=n.parseHeader(t,r);if(o&&r+o.frameLength<=t.length){var u=o.samplesPerFrame*9e4/o.sampleRate,l=i+a*u,c={data:t.subarray(r,r+o.frameLength),pts:l,dts:l};return c.size=c.data.byteLength,e.config=[],e.channelCount=o.channelCount,e.sampleRate=o.sampleRate,Cr?e.codec="mp3":e.container="audio/mpeg",e.samples.push(c),{length:o.frameLength}}}}},{key:"parseHeader",value:function(e,t){var r=e[t+1]>>3&3,i=e[t+1]>>1&3,a=e[t+2]>>4&15,o=e[t+2]>>2&3;if(r!==1&&a!==0&&a!==15&&o!==3){var u=e[t+2]>>1&1,l=e[t+3]>>6,c=r===3?3-i:i===3?3:4,h=un[c*14+a-1]*1e3,d=r===3?0:r===2?1:2,f=ln[d*3+o],v=l===3?1:2,b=cn[r][i],m=hn[i],y=b*8*m,A=Math.floor(b*h/f+u)*m;if(st===null){var k=navigator.userAgent||"",w=k.match(/Chrome\/(\d+)/i);st=w?parseInt(w[1]):0}var E=!!st&&st<=87;return E&&i===2&&h>=224e3&&l===0&&(e[t+3]=e[t+3]|128),{sampleRate:f,channelCount:v,frameLength:A,samplesPerFrame:y}}}}]),n}(),Ee=new mt("TsDemuxer"),Ur=function(){function n(s,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};re(this,n),O(this,"_pmtId",-1),O(this,"_remainingPacketData",null),O(this,"_videoPesData",[]),O(this,"_audioPesData",[]),O(this,"_gopId",0),this.videoTrack=s||new Pr,this.audioTrack=e||new Rr,this.metadataTrack=t||new Ir,this._fixer=new on(this.videoTrack,this.audioTrack,this.metadataTrack,r)}return ie(n,[{key:"demux",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=this.audioTrack,a=this.videoTrack,o=this.metadataTrack;t&&(this._pmtId=-1,a.reset(),i.reset(),o.reset()),!r||t?(this._remainingPacketData=null,this._videoPesData=[],this._audioPesData=[]):(a.samples=[],i.samples=[],o.seiSamples=[],a.warnings=[],i.warnings=[],this._remainingPacketData&&(e=_e(this._remainingPacketData,e),this._remainingPacketData=null));var u=e.length,l=u%188;l&&(this._remainingPacketData=e.subarray(u-l),u-=l);for(var c=a.pid,h=i.pid,d=0;d<u;d+=188){if(e[d]!==71)throw new Error("TS packet did not start with 0x47");var f=!!(e[d+1]&64),v=((e[d+1]&31)<<8)+e[d+2],b=(e[d+3]&48)>>4,m=void 0;if(b>1){if(m=d+5+e[d+4],m===d+188)continue}else m=d+4;switch(v){case 0:f&&(m+=e[m]+1),this._pmtId=(e[m+10]&31)<<8|e[m+11];break;case this._pmtId:{f&&(m+=e[m]+1);var y=m+3+((e[m+1]&15)<<8|e[m+2])-4,A=(e[m+10]&15)<<8|e[m+11];for(m+=12+A;m<y;){var k=(e[m+1]&31)<<8|e[m+2];switch(e[m]){case 15:i.pid=h=k;break;case 3:case 4:i.pid===-1&&(i.pid=h=k,i.codecType=Se.MP3);break;case 27:if(c!==-1)break;a.codecType=Ce.AVC,a.pid=c=k;break;case 36:if(c!==-1)break;a.codecType=Ce.HEVC,a.pid=c=k;break;default:Ee.warn("Unsupported stream. type: ".concat(e[m],", pid: ").concat(k))}m+=((e[m+3]&15)<<8|e[m+4])+5}}break;case c:f&&this._videoPesData.length&&this._parseVideoData(),this._videoPesData.push(e.subarray(m,d+188));break;case h:f&&this._audioPesData.length&&this._parseAudioData(),this._audioPesData.push(e.subarray(m,d+188));break;case 17:case 8191:break;default:Ee.warn("Unknown pid: ".concat(v))}}return this._parseVideoData(),this._parseAudioData(),i.formatTimescale=a.formatTimescale=a.timescale=o.timescale=9e4,i.timescale=i.sampleRate||0,{videoTrack:a,audioTrack:i,metadataTrack:o}}},{key:"fix",value:function(e,t,r){return this._fixer.fix(e,t,r),{videoTrack:this.videoTrack,audioTrack:this.audioTrack,metadataTrack:this.metadataTrack}}},{key:"demuxAndFix",value:function(e,t,r,i){return this.demux(e,t,r),this.fix(i,t,r)}},{key:"_parseVideoData",value:function(){if(this._videoPesData.length){var e=n._parsePES(_e.apply(void 0,pe(this._videoPesData)));if(!e){Ee.warn("Cannot parse video pes",this._videoPesData);return}var t=Re.parseAnnexB(e.data);t?this._createVideoSample(t,e.pts,e.dts):Ee.warn("Cannot parse avc units",e),this._videoPesData=[]}}},{key:"_createVideoSample",value:function(e,t,r){var i=this;if(e.length){var a=this.videoTrack,o=a.codecType===Ce.HEVC,u=new Ht(t,r);e.forEach(function(l){var c=o?l[0]>>>1&63:l[0]&31;switch(c){case 5:case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:if(!o&&c!==5||o&&c===5)break;u.setToKeyframe(),i._gopId++;break;case 6:case 39:case 40:if(!o&&c!==6||o&&c===6)break;i.metadataTrack.seiSamples.push(new Xi(Re.parseSEI(Re.removeEPB(l),o),t));return;case 32:if(!o)break;if(!a.vps.length){var h=hr.parseVPS(Re.removeEPB(l),a.hvcC);a.hvcC=a.hvcC||h,a.vps=[l]}break;case 7:case 33:if(!o&&c!==7||o&&c===7)break;if(!a.sps.length){var d=Re.removeEPB(l),f=o?hr.parseSPS(d,a.hvcC):rn.parseSPS(d);a.sps=[l],a.hvcC=a.hvcC||f.hvcC,a.codec=f.codec,a.width=f.width,a.height=f.height,a.sarRatio=f.sarRatio,a.fpsNum=f.fpsNum,a.fpsDen=f.fpsDen}break;case 8:case 34:if(!o&&c!==8||o&&c===8)break;a.pps.length||(a.pps=[l]);break;case 9:case 35:break;case 38:if(o){for(var v=!1,b=2;b<l.byteLength;b++)if(l[b]===255){v=!0;break}if(!v)return}break}u.units.push(l)}),u.gopId=this._gopId,this._pushVideoSample(a,u)}}},{key:"_pushVideoSample",value:function(e,t){if(t.units.length)if(t.pts===null||t.pts===void 0){Ee.warn("Video sample no pts",t);var r=e.samples[e.samples.length-1];r?(t.pts=r.pts,t.dts=r.dts):Ee.warn("Drop video sample",t)}else e.samples.push(t)}},{key:"_parseAudioData",value:function(){if(this._audioPesData.length){var e=n._parsePES(_e.apply(void 0,pe(this._audioPesData)));if(!e){Ee.warn("Cannot parse audio pes",this._audioPesData);return}switch(this.audioTrack.codecType){case Se.AAC:this._parseAacData(e);break;case Se.MP3:this._parseMPEG(e);break}this._audioPesData=[]}}},{key:"_parseAacData",value:function(e){var t=this.audioTrack,r=e.pts;if(r==null){if(Ee.warn("AAC pes not pts",t),!t.samples.length||!t.sampleRate)return;r=t.samples[t.samples.length-1].pts+Le.getFrameDuration(t.sampleRate)}var i=Le.parseADTS(e.data,r);if(i){var a;t.codec=i.codec,t.channelCount=i.channelCount,t.sampleRate=i.sampleRate,t.objectType=i.objectType,t.sampleRateIndex=i.samplingFrequencyIndex,t.config=i.config,(a=t.samples).push.apply(a,pe(i.frames.map(function(o){return new qe(o.pts,o.data)}))),i.skip&&Ee.warn("Skip aac adts ".concat(i.skip," bits")),i.remaining&&Ee.warn("Remaining aac adts ".concat(i.remaining," bits"))}else Ee.warn("Cannot parse aac adts",e)}},{key:"_parseMPEG",value:function(e){var t=e.data,r=t.length,i=0,a=0,o=e.pts;if(o===void 0){Ee.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<r;)if(dr.isHeader(t,a)){var u=dr.appendFrame(this.audioTrack,t,a,o,i);if(u)a+=u.length,i++;else break}else a++}}],[{key:"probe",value:function(e){return e.length?e[0]===71&&e[188]===71&&e[376]===71:!1}},{key:"_parsePES",value:function(e){var t=e[8];if(!(t==null||e.length<t+9)){var r=e[0]<<16|e[1]<<8|e[2];if(r===1){var i=(e[4]<<8)+e[5];if(!(i&&i>e.length-6)){var a,o,u=e[7];return u&192&&(a=(e[9]&14)*536870912+(e[10]&255)*4194304+(e[11]&254)*16384+(e[12]&255)*128+(e[13]&254)/2,u&64?(o=(e[14]&14)*536870912+(e[15]&255)*4194304+(e[16]&254)*16384+(e[17]&255)*128+(e[18]&254)/2,a-o>60*9e4&&(a=o)):o=a),{data:e.subarray(9+t),pts:a,dts:o}}}}}}]),n}(),Lt=function(){function n(s,e,t){re(this,n),this.dv=new DataView(s),this.start=this.offset=e||this.dv.byteOffset,this.end=t?this.start+t:this.start+this.dv.byteLength}return ie(n,[{key:"buffer",get:function(){return this.dv.buffer}},{key:"unreadLength",get:function(){return Math.max(this.end-this.offset,0)}},{key:"size",get:function(){return this.end-this.start}},{key:"readFloat",value:function(e){var t=0;switch(e){case 4:t=this.dv.getFloat32(this.offset);break;case 8:t=this.dv.getFloat64(this.offset);break;default:throw new Error("read ".concat(e,"-byte float is not supported"))}return this.offset+=e,t}},{key:"back",value:function(e){this.offset-=e}},{key:"skip",value:function(e){this.offset+=e}},{key:"readInt",value:function(e){var t=this.offset;switch(this.offset+=e,e){case 1:return this.dv.getInt8(t);case 2:return this.dv.getInt16(t);case 4:return this.dv.getInt32(t);default:throw new Error("read ".concat(e,"-byte integers is not supported"))}}},{key:"read",value:function(e){var t=this.offset;switch(this.offset+=e,e){case 1:return this.dv.getUint8(t);case 2:return this.dv.getUint16(t);case 3:return(this.dv.getUint16(t)<<8)+this.dv.getUint8(t+2);case 4:return this.dv.getUint32(t);default:return this.back(e-4),this.read(e-4)+this.dv.getUint32(t)*Math.pow(256,e-4)}}},{key:"write",value:function(e,t){var r=this.offset;switch(this.offset+=e,e){case 1:return this.dv.setUint8(r,t);case 2:return this.dv.setUint16(r,t);case 3:return this.dv.setUint8(r,t>>>16),this.dv.setUint16(r+1,65535&t);case 4:return this.dv.setUint32(r,t);default:throw new Error("write ".concat(e,"-byte integers is not supported"))}}},{key:"readToBuffer",value:function(e){var t;return this.offset||e?t=this.dv.buffer.slice(this.offset,e?this.offset+e:this.end):t=this.dv.buffer,this.offset+=t.byteLength,t}},{key:"readToUint8",value:function(e){var t=new Uint8Array(this.dv.buffer,this.offset,e||this.unreadLength);return this.offset+=t.byteLength,t}},{key:"readString",value:function(e){for(var t=0,r="";t<e;t++)r+=String.fromCharCode(this.dv.getUint8(this.offset)),this.offset++;return r}}],[{key:"fromUint8",value:function(e){return new n(e.buffer,e.byteOffset,e.byteLength)}},{key:"concatUint8s",value:function(e){var t=new Uint8Array(e.reduce(function(i,a){return i+a.byteLength},0)),r=0;return e.forEach(function(i){t.set(i,r),r+=i.byteLength}),t}},{key:"concatUint8",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.concatUint8s(t)}}]),n}(),fn=function(){function n(s,e){re(this,n),this.offset=0,this.val=s,this.size=e}return ie(n,[{key:"skip",value:function(e){this.offset+=e}},{key:"read",value:function(e){var t=this.size-this.offset-e;if(t>=0){var r=0,i=0;if(this.offset+=e,this.size>31){for(;i<e;i++)r+=Math.pow(2,i);return this.val/Math.pow(2,t)&r}else{for(;i<e;i++)r+=1<<i;return this.val>>>t&r}}throw new Error("the number of the read operation exceeds the total length limit of bits")}}],[{key:"fromByte",value:function(e,t){return new n(e.read(t),t<<3)}}]),n}(),Z=function(){function n(){re(this,n)}return ie(n,null,[{key:"findBox",value:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=[];if(!e)return i;for(var a=0,o="",u=0;e.length>7;){if(a=C(e),o=String.fromCharCode.apply(null,e.subarray(4,8)),u=8,a===1?(a=Ne(e,8),u+=8):a||(a=e.length),!t[0]||o===t[0]){var l=e.subarray(0,a);if(t.length<2)i.push({start:r,size:a,headerSize:u,type:o,data:l});else return n.findBox(l.subarray(u),t.slice(1),r+u)}r+=a,e=e.subarray(a)}return i}},{key:"tfhd",value:function(e){return j(e,!0,function(t,r){t.trackId=C(r);var i=4,a=t.flags&255&1,o=t.flags&255&2,u=t.flags&255&8,l=t.flags&255&16,c=t.flags&255&32;a&&(i+=4,t.baseDataOffset=C(r,i),i+=4),o&&(t.sampleDescriptionIndex=C(r,i),i+=4),u&&(t.defaultSampleDuration=C(r,i),i+=4),l&&(t.defaultSampleSize=C(r,i),i+=4),c&&(t.defaultSampleFlags=C(r,i))})}},{key:"sidx",value:function(e){return j(e,!0,function(t,r){var i=0;t.reference_ID=C(r,i),i+=4,t.timescale=C(r,i),i+=4,t.version===0?(t.earliest_presentation_time=C(r,i),i+=4,t.first_offset=C(r,i),i+=4):(t.earliest_presentation_time=Ne(r,i),i+=8,t.first_offset=Ne(r,i),i+=8),i+=2,t.references=[];var a=ee(r,i);i+=2;for(var o=0;o<a;o++){var u={};t.references.push(u);var l=C(r,i);i+=4,u.reference_type=l>>31&1,u.referenced_size=l&2147483647,u.subsegment_duration=C(r,i),i+=4,l=C(r,i),i+=4,u.starts_with_SAP=l>>31&1,u.SAP_type=l>>28&7,u.SAP_delta_time=l&268435455}})}},{key:"moov",value:function(e){return j(e,!1,function(t,r,i){t.mvhd=n.mvhd(n.findBox(r,["mvhd"],i)[0]),t.trak=n.findBox(r,["trak"],i).map(function(a){return n.trak(a)}),t.pssh=n.pssh(n.findBox(r,["pssh"],i)[0])})}},{key:"mvhd",value:function(e){return j(e,!0,function(t,r){var i=0;t.version===1?(t.timescale=C(r,16),t.duration=Ne(r,20),i+=28):(t.timescale=C(r,8),t.duration=C(r,12),i+=16),t.nextTrackId=C(r,i+76)})}},{key:"trak",value:function(e){return j(e,!1,function(t,r,i){t.tkhd=n.tkhd(n.findBox(r,["tkhd"],i)[0]),t.mdia=n.mdia(n.findBox(r,["mdia"],i)[0])})}},{key:"tkhd",value:function(e){return j(e,!0,function(t,r){var i=Lt.fromUint8(r);t.version===1?(i.read(8),i.read(8),t.trackId=i.read(4),i.read(4),t.duration=i.read(8)):(i.read(4),i.read(4),t.trackId=i.read(4),i.read(4),t.duration=i.read(4)),i.skip(16),t.matrix=[];for(var a=0;a<36;a++)t.matrix.push(i.read(1));i.back(36);for(var o=[],u=0,l;u<3;u++)o.push(kt(i.readInt(2),i.readInt(2))),o.push(kt(i.readInt(2),i.readInt(2))),l=i.readInt(4),o.push(kt(l>>30,l&1073741823));t.rotation=tn(o),t.width=i.read(4),t.height=i.read(4)})}},{key:"mdia",value:function(e){return j(e,!1,function(t,r,i){t.mdhd=n.mdhd(n.findBox(r,["mdhd"],i)[0]),t.hdlr=n.hdlr(n.findBox(r,["hdlr"],i)[0]),t.minf=n.minf(n.findBox(r,["minf"],i)[0])})}},{key:"mdhd",value:function(e){return j(e,!0,function(t,r){var i=0;t.version===1?(t.timescale=C(r,16),t.duration=Ne(r,20),i+=28):(t.timescale=C(r,8),t.duration=C(r,12),i+=16);var a=ee(r,i);t.language=String.fromCharCode((a>>10&31)+96,(a>>5&31)+96,(a&31)+96)})}},{key:"hdlr",value:function(e){return j(e,!0,function(t,r){t.version===0&&(t.handlerType=String.fromCharCode.apply(null,r.subarray(4,8)))})}},{key:"minf",value:function(e){return j(e,!1,function(t,r,i){t.vmhd=n.vmhd(n.findBox(r,["vmhd"],i)[0]),t.smhd=n.smhd(n.findBox(r,["smhd"],i)[0]),t.stbl=n.stbl(n.findBox(r,["stbl"],i)[0])})}},{key:"vmhd",value:function(e){return j(e,!0,function(t,r){t.graphicsmode=ee(r),t.opcolor=[ee(r,2),ee(r,4),ee(r,6)]})}},{key:"smhd",value:function(e){return j(e,!0,function(t,r){t.balance=ee(r)})}},{key:"stbl",value:function(e){return j(e,!1,function(t,r,i){var a,o,u;t.stsd=n.stsd(n.findBox(r,["stsd"],i)[0]),t.stts=n.stts(n.findBox(r,["stts"],i)[0]),t.ctts=n.ctts(n.findBox(r,["ctts"],i)[0]),t.stsc=n.stsc(n.findBox(r,["stsc"],i)[0]),t.stsz=n.stsz(n.findBox(r,["stsz"],i)[0]),t.stco=n.stco(n.findBox(r,["stco"],i)[0]),t.stco||(t.co64=n.co64(n.findBox(r,["co64"],i)[0]),t.stco=t.co64);var l=(a=t.stsd.entries[0])===null||a===void 0||(o=a.sinf)===null||o===void 0||(u=o.schi)===null||u===void 0?void 0:u.tenc.default_IV_size;t.stss=n.stss(n.findBox(r,["stss"],i)[0]),t.senc=n.senc(n.findBox(r,["senc"],i)[0],l)})}},{key:"senc",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;return j(e,!0,function(r,i){var a=0,o=C(i,a);a+=4,r.samples=[];for(var u=0;u<o;u++){var l={};l.InitializationVector=[];for(var c=0;c<t;c++)l.InitializationVector[c]=i[a+c];if(a+=t,r.flags&2){l.subsamples=[];var h=ee(i,a);a+=2;for(var d=0;d<h;d++){var f={};f.BytesOfClearData=ee(i,a),a+=2,f.BytesOfProtectedData=C(i,a),a+=4,l.subsamples.push(f)}}r.samples.push(l)}})}},{key:"pssh",value:function(e){return j(e,!0,function(t,r){for(var i=[],a=[],o=0,u=0;u<16;u++)a.push(Pt(r[o+u]));if(o+=16,t.version>0){var l=C(r,o);o+=4;for(var c=0;c<(""+l).length;c++)for(var h=0;h<16;h++){var d=r[o];o+=1,i.push(Pt(d))}}var f=C(r,o);t.data_size=f,o+=4,t.kid=i,t.system_id=a,t.buffer=r})}},{key:"stsd",value:function(e){return j(e,!0,function(t,r,i){t.entryCount=C(r),t.entries=n.findBox(r.subarray(4),[],i+4).map(function(a){switch(a.type){case"av01":return n.av01(a);case"avc1":case"avc2":case"avc3":case"avc4":return n.avc1(a);case"hvc1":case"hev1":return n.hvc1(a);case"mp4a":return n.mp4a(a);case"alaw":case"ulaw":return n.alaw(a);case"enca":return j(a,!1,function(o,u,l){o.channelCount=ee(u,16),o.samplesize=ee(u,18),o.sampleRate=C(u,24)/65536,u=u.subarray(28),o.sinf=n.sinf(n.findBox(u,["sinf"],l)[0]),o.esds=n.esds(n.findBox(u,["esds"],l)[0])});case"encv":return j(a,!1,function(o,u,l){o.width=ee(u,24),o.height=ee(u,26),o.horizresolution=C(u,28),o.vertresolution=C(u,32),u=u.subarray(78),o.sinf=n.sinf(n.findBox(u,["sinf"],l)[0]),o.avcC=n.avcC(n.findBox(u,["avcC"],l)[0]),o.hvcC=n.hvcC(n.findBox(u,["hvcC"],l)[0]),o.pasp=n.pasp(n.findBox(u,["pasp"],l)[0])})}}).filter(Boolean)})}},{key:"tenc",value:function(e){return j(e,!1,function(t,r){var i=6;t.default_IsEncrypted=r[i],i+=1,t.default_IV_size=r[i],i+=1,t.default_KID=[];for(var a=0;a<16;a++)t.default_KID.push(Pt(r[i])),i+=1})}},{key:"schi",value:function(e){return j(e,!1,function(t,r,i){t.tenc=n.tenc(n.findBox(r,["tenc"],i)[0])})}},{key:"sinf",value:function(e){return j(e,!1,function(t,r,i){t.schi=n.schi(n.findBox(r,["schi"],i)[0]),t.frma=n.frma(n.findBox(r,["frma"],i)[0])})}},{key:"frma",value:function(e){return j(e,!1,function(t,r){t.data_format="";for(var i=0;i<4;i++)t.data_format+=String.fromCharCode(r[i])})}},{key:"colr",value:function(e){return j(e,!1,function(t,r){var i=Lt.fromUint8(r);t.data=e.data,t.colorType=i.readString(4),t.colorType==="nclx"?(t.colorPrimaries=i.read(2),t.transferCharacteristics=i.read(2),t.matrixCoefficients=i.read(2),t.fullRangeFlag=i.read(1)>>7):(t.colorType==="rICC"||t.colorType==="prof")&&(t.iccProfile=r.readToUint8())})}},{key:"av01",value:function(e){return j(e,!1,function(t,r,i){var a=Ot(t,r),o=r.subarray(a);i+=a,t.av1C=n.av1C(n.findBox(o,["av1C"],i)[0]),t.colr=n.colr(n.findBox(o,["colr"],i)[0])})}},{key:"av1C",value:function(e){return j(e,!1,function(t,r){t.data=e.data;var i=Lt.fromUint8(r),a=fn.fromByte(i,4);t.marker=a.read(1),t.version=a.read(7),t.seqProfile=a.read(3),t.seqLevelIdx0=a.read(5),t.seqTier0=a.read(1),t.highBitdepth=a.read(1),t.twelveBit=a.read(1),t.monochrome=a.read(1),t.chromaSubsamplingX=a.read(1),t.chromaSubsamplingY=a.read(1),t.chromaSamplePosition=a.read(2),t.reserved=a.read(3),t.initialPresentationDelayPresent=a.read(1),t.initialPresentationDelayPresent?t.initialPresentationDelayMinusOne=a.read(4):t.initialPresentationDelayMinusOne=0,t.configOBUs=i.readToUint8();var o;t.seqLevelIdx0===2&&t.highBitdepth===1?o=t.twelveBit===1?"12":"10":t.seqProfile<=2&&(o=t.highBitdepth===1?"10":"08"),t.codec=["av01",t.seqProfile,(t.seqLevelIdx0<10?"0"+t.seqLevelIdx0:t.seqLevelIdx0)+(t.seqTier0?"H":"M"),o].join(".")})}},{key:"avc1",value:function(e){return j(e,!1,function(t,r,i){var a=Ot(t,r),o=r.subarray(a);i+=a,t.avcC=n.avcC(n.findBox(o,["avcC"],i)[0]),t.pasp=n.pasp(n.findBox(o,["pasp"],i)[0])})}},{key:"avcC",value:function(e){return j(e,!1,function(t,r){t.data=e.data,t.configurationVersion=r[0],t.AVCProfileIndication=r[1],t.profileCompatibility=r[2],t.AVCLevelIndication=r[3],t.codec=Mr([r[1],r[2],r[3]]),t.lengthSizeMinusOne=r[4]&3,t.spsLength=r[5]&31,t.sps=[];for(var i=6,a=0;a<t.spsLength;a++){var o=ee(r,i);i+=2,t.sps.push(r.subarray(i,i+o)),i+=o}t.ppsLength=r[i],i+=1,t.pps=[];for(var u=0;u<t.ppsLength;u++){var l=ee(r,i);i+=2,t.pps.push(r.subarray(i,i+=l)),i+=l}})}},{key:"hvc1",value:function(e){return j(e,!1,function(t,r,i){var a=Ot(t,r),o=r.subarray(a);i+=a,t.hvcC=n.hvcC(n.findBox(o,["hvcC"],i)[0]),t.pasp=n.pasp(n.findBox(o,["pasp"],i)[0])})}},{key:"hvcC",value:function(e){return j(e,!1,function(t,r){t.data=e.data,t.codec="hev1.1.6.L93.B0",t.configurationVersion=r[0];var i=r[1];t.generalProfileSpace=i>>6,t.generalTierFlag=(i&32)>>5,t.generalProfileIdc=i&31,t.generalProfileCompatibility=C(r,2),t.generalConstraintIndicatorFlags=r.subarray(6,12),t.generalLevelIdc=r[12],t.avgFrameRate=ee(r,19),t.numOfArrays=r[22],t.vps=[],t.sps=[],t.pps=[];for(var a=23,o=0,u=0,l=0,c=0;c<t.numOfArrays;c++){o=r[a]&63,u=ee(r,a+1),a+=3;for(var h=[],d=0;d<u;d++)l=ee(r,a),a+=2,h.push(r.subarray(a,a+l)),a+=l;if(o===32){var f;(f=t.vps).push.apply(f,h)}else if(o===33){var v;(v=t.sps).push.apply(v,h)}else if(o===34){var b;(b=t.pps).push.apply(b,h)}}})}},{key:"pasp",value:function(e){return j(e,!1,function(t,r){t.hSpacing=C(r),t.vSpacing=C(r,4)})}},{key:"mp4a",value:function(e){return j(e,!1,function(t,r,i){var a=pr(t,r);t.esds=n.esds(n.findBox(r.subarray(a),["esds"],i+a)[0])})}},{key:"esds",value:function(e){return j(e,!0,function(t,r){t.codec="mp4a.";for(var i=0,a=0,o=0,u=0;r.length;){for(i=0,u=r[i],a=r[i+1],i+=2;a&128;)o=(a&127)<<7,a=r[i],i+=1;if(o+=a&127,u===3)r=r.subarray(i+3);else if(u===4)t.codec+=(r[i].toString(16)+".").padStart(3,"0"),r=r.subarray(i+13);else if(u===5){var l=t.config=r.subarray(i,i+o),c=(l[0]&248)>>3;c===31&&l.length>=2&&(c=32+((l[0]&7)<<3)+((l[1]&224)>>5)),t.objectType=c,t.codec+=c.toString(16),t.codec[t.codec.length-1]==="."&&(t.codec=t.codec.substring(0,t.codec.length-1));return}else{t.codec[t.codec.length-1]==="."&&(t.codec=t.codec.substring(0,t.codec.length-1));return}}})}},{key:"alaw",value:function(e){return j(e,!1,function(t,r){pr(t,r)})}},{key:"stts",value:function(e){return j(e,!0,function(t,r){for(var i=C(r),a=[],o=4,u=0;u<i;u++)a.push({count:C(r,o),delta:C(r,o+4)}),o+=8;t.entryCount=i,t.entries=a})}},{key:"ctts",value:function(e){return j(e,!0,function(t,r){var i=C(r),a=[],o=4;if(t.version===1)for(var u=0;u<i;u++)a.push({count:C(r,o),offset:C(r,o+4)}),o+=8;else for(var l=0;l<i;l++)a.push({count:C(r,o),offset:-(~C(r,o+4)+1)}),o+=8;t.entryCount=i,t.entries=a})}},{key:"stsc",value:function(e){return j(e,!0,function(t,r){for(var i=C(r),a=[],o=4,u=0;u<i;u++)a.push({firstChunk:C(r,o),samplesPerChunk:C(r,o+4),sampleDescriptionIndex:C(r,o+8)}),o+=12;t.entryCount=i,t.entries=a})}},{key:"stsz",value:function(e){return j(e,!0,function(t,r){var i=C(r),a=C(r,4),o=[];if(!i)for(var u=8,l=0;l<a;l++)o.push(C(r,u)),u+=4;t.sampleSize=i,t.sampleCount=a,t.entrySizes=o})}},{key:"stco",value:function(e){return j(e,!0,function(t,r){for(var i=C(r),a=[],o=4,u=0;u<i;u++)a.push(C(r,o)),o+=4;t.entryCount=i,t.entries=a})}},{key:"co64",value:function(e){return j(e,!0,function(t,r){for(var i=C(r),a=[],o=4,u=0;u<i;u++)a.push(Ne(r,o)),o+=8;t.entryCount=i,t.entries=a})}},{key:"stss",value:function(e){return j(e,!0,function(t,r){for(var i=C(r),a=[],o=4,u=0;u<i;u++)a.push(C(r,o)),o+=4;t.entryCount=i,t.entries=a})}},{key:"moof",value:function(e){return j(e,!1,function(t,r,i){t.mfhd=n.mfhd(n.findBox(r,["mfhd"],i)[0]),t.traf=n.findBox(r,["traf"],i).map(function(a){return n.traf(a)})})}},{key:"mfhd",value:function(e){return j(e,!0,function(t,r){t.sequenceNumber=C(r)})}},{key:"traf",value:function(e){return j(e,!1,function(t,r,i){t.tfhd=n.tfhd(n.findBox(r,["tfhd"],i)[0]),t.tfdt=n.tfdt(n.findBox(r,["tfdt"],i)[0]),t.trun=n.trun(n.findBox(r,["trun"],i)[0])})}},{key:"trun",value:function(e){return j(e,!0,function(t,r){var i=t.version,a=t.flags,o=r.length,u=t.sampleCount=C(r),l=4;if(o>l&&a&1&&(t.dataOffset=-(~C(r,l)+1),l+=4),o>l&&a&4&&(t.firstSampleFlags=C(r,l),l+=4),t.samples=[],o>l)for(var c,h=0;h<u;h++)c={},a&256&&(c.duration=C(r,l),l+=4),a&512&&(c.size=C(r,l),l+=4),a&1024&&(c.flags=C(r,l),l+=4),a&2048&&(i?c.cts=-(~C(r,l+4)+1):c.cts=C(r,l),l+=4),t.samples.push(c)})}},{key:"tfdt",value:function(e){return j(e,!0,function(t,r){t.version===1?t.baseMediaDecodeTime=Ne(r):t.baseMediaDecodeTime=C(r)})}},{key:"probe",value:function(e){return!!n.findBox(e,["ftyp"])}},{key:"parseSampleFlags",value:function(e){return{isLeading:(e[0]&12)>>>2,dependsOn:e[0]&3,isDependedOn:(e[1]&192)>>>6,hasRedundancy:(e[1]&48)>>>4,paddingValue:(e[1]&14)>>>1,isNonSyncSample:e[1]&1,degradationPriority:e[2]<<8|e[3]}}},{key:"moovToTrack",value:function(e,t,r){var i,a,o=e.trak;if(!(!o||!o.length)){var u=o.find(function(Et){var Be,xe;return((Be=Et.mdia)===null||Be===void 0||(xe=Be.hdlr)===null||xe===void 0?void 0:xe.handlerType)==="vide"}),l=o.find(function(Et){var Be,xe;return((Be=Et.mdia)===null||Be===void 0||(xe=Be.hdlr)===null||xe===void 0?void 0:xe.handlerType)==="soun"});if(u&&t){var c,h,d,f,v,b,m,y=t,A=(c=u.tkhd)===null||c===void 0?void 0:c.trackId;A!=null&&(y.id=u.tkhd.trackId),y.tkhdDuration=u.tkhd.duration,y.mvhdDurtion=e.mvhd.duration,y.mvhdTimecale=e.mvhd.timescale,y.timescale=y.formatTimescale=u.mdia.mdhd.timescale,y.duration=u.mdia.mdhd.duration||y.mvhdDurtion/y.mvhdTimecale*y.timescale,y.rotation=u.tkhd.rotation,y.matrix=u.tkhd.matrix;var k=u.mdia.minf.stbl.stsd.entries[0];if(y.width=k.width,y.height=k.height,k.pasp&&(y.sarRatio=[k.pasp.hSpacing,k.pasp.vSpacing]),k.av1C)y.codecType=Ce.AV1,y.codec=k.av1C.codec,y.av1C=k.av1C.data,k.colr&&(y.colr=k.colr.data);else if(k.hvcC)y.codecType=Ce.HEVC,y.codec=k.hvcC.codec,y.vps=k.hvcC.vps,y.sps=k.hvcC.sps,y.pps=k.hvcC.pps,y.hvcC=k.hvcC.data;else if(k.avcC)y.codec=k.avcC.codec,y.sps=k.avcC.sps,y.pps=k.avcC.pps;else throw new Error("unknown video stsd entry");if(y.present=!0,y.ext={},y.ext.stss=(h=u.mdia)===null||h===void 0||(d=h.minf)===null||d===void 0||(f=d.stbl)===null||f===void 0?void 0:f.stss,y.ext.ctts=(v=u.mdia)===null||v===void 0||(b=v.minf)===null||b===void 0||(m=b.stbl)===null||m===void 0?void 0:m.ctts,k&&k.type==="encv"){var w,E,B,R,U,N,G,z;y.isVideoEncryption=!0,k.default_KID=(w=k.sinf)===null||w===void 0||(E=w.schi)===null||E===void 0?void 0:E.tenc.default_KID,k.default_IsEncrypted=(B=k.sinf)===null||B===void 0||(R=B.schi)===null||R===void 0?void 0:R.tenc.default_IsEncrypted,k.default_IV_size=(U=k.sinf)===null||U===void 0||(N=U.schi)===null||N===void 0?void 0:N.tenc.default_IV_size,y.videoSenc=u.mdia.minf.stbl.senc&&u.mdia.minf.stbl.senc.samples,k.data_format=(G=k.sinf)===null||G===void 0||(z=G.frma)===null||z===void 0?void 0:z.data_format,y.useEME=e.useEME,y.kidValue=e.kidValue,y.pssh=e.pssh,y.encv=k}}if(l&&r){var p,g,_,D,T,P,x,H,W,I=r,oe=(p=l.tkhd)===null||p===void 0?void 0:p.trackId;oe!=null&&(I.id=l.tkhd.trackId),I.tkhdDuration=l.tkhd.duration,I.mvhdDurtion=e.mvhd.duration,I.mvhdTimecale=e.mvhd.timescale,I.timescale=I.formatTimescale=l.mdia.mdhd.timescale,I.duration=l.mdia.mdhd.duration||I.mvhdDurtion/I.mvhdTimecale*I.timescale;var $=l.mdia.minf.stbl.stsd.entries[0];switch(I.sampleSize=$.sampleSize,I.sampleRate=$.sampleRate,I.channelCount=$.channelCount,I.present=!0,$.type){case"alaw":I.codecType=I.codec=Se.G711PCMA,I.sampleRate=8e3;break;case"ulaw":I.codecType=I.codec=Se.G711PCMU,I.sampleRate=8e3;break;default:I.sampleDuration=Le.getFrameDuration(I.sampleRate,I.timescale),I.sampleRateIndex=Le.getRateIndexByRate(I.sampleRate),I.objectType=((i=$.esds)===null||i===void 0?void 0:i.objectType)||2,$.esds&&(I.config=Array.from($.esds.config)),I.codec=((a=$.esds)===null||a===void 0?void 0:a.codec)||"mp4a.40.2";break}if(I.sampleDuration=Le.getFrameDuration(I.sampleRate,I.timescale),I.objectType=((g=$.esds)===null||g===void 0?void 0:g.objectType)||2,$.esds&&($.esds.config?I.config=Array.from($.esds.config):console.warn("esds config is null")),I.codec=((_=$.esds)===null||_===void 0?void 0:_.codec)||"mp4a.40.2",I.sampleRateIndex=Le.getRateIndexByRate(I.sampleRate),I.ext={},I.ext.stss=(D=l.mdia)===null||D===void 0||(T=D.minf)===null||T===void 0||(P=T.stbl)===null||P===void 0?void 0:P.stss,I.ext.ctts=(x=l.mdia)===null||x===void 0||(H=x.minf)===null||H===void 0||(W=H.stbl)===null||W===void 0?void 0:W.ctts,I.present=!0,$&&$.type==="enca"){var le,Te,ce,Me,be,Ue,He,rt;I.isAudioEncryption=!0,$.data_format=(le=$.sinf)===null||le===void 0||(Te=le.frma)===null||Te===void 0?void 0:Te.data_format,$.default_KID=(ce=$.sinf)===null||ce===void 0||(Me=ce.schi)===null||Me===void 0?void 0:Me.tenc.default_KID,$.default_IsEncrypted=(be=$.sinf)===null||be===void 0||(Ue=be.schi)===null||Ue===void 0?void 0:Ue.tenc.default_IsEncrypted,$.default_IV_size=(He=$.sinf)===null||He===void 0||(rt=He.schi)===null||rt===void 0?void 0:rt.tenc.default_IV_size,I.audioSenc=l.mdia.minf.stbl.senc&&l.mdia.minf.stbl.senc.samples,I.useEME=e.useEME,I.kidValue=e.kidValue,I.enca=$}}if(r&&(r.isVideoEncryption=t?t.isVideoEncryption:!1),t&&(t.isAudioEncryption=r?r.isAudioEncryption:!1),t!=null&&t.encv||r!=null&&r.enca){var ne,bt,Yt=t==null||(ne=t.encv)===null||ne===void 0?void 0:ne.default_KID,Wt=r==null||(bt=r.enca)===null||bt===void 0?void 0:bt.default_KID,qt=Yt||Wt?(Yt||Wt).join(""):null;t&&(t.kid=qt),r&&(r.kid=qt)}return t&&(t.flags=3841),r&&(r.flags=1793),{videoTrack:t,audioTrack:r}}}},{key:"evaluateDefaultDuration",value:function(e,t,r){var i,a=t==null||(i=t.samples)===null||i===void 0?void 0:i.length;if(!a)return 1024;var o=1024*a/t.timescale;return o*e.timescale/r}},{key:"moofToSamples",value:function(e,t,r){var i={};return e.mfhd&&(t&&(t.sequenceNumber=e.mfhd.sequenceNumber),r&&(r.sequenceNumber=e.mfhd.sequenceNumber)),e.traf.forEach(function(a){var o=a.tfhd,u=a.tfdt,l=a.trun;if(!(!o||!l)){u&&(t&&t.id===o.trackId&&(t.baseMediaDecodeTime=u.baseMediaDecodeTime),r&&r.id===o.trackId&&(r.baseMediaDecodeTime=u.baseMediaDecodeTime));var c=o.defaultSampleSize||0,h=o.defaultSampleDuration||n.evaluateDefaultDuration(t,r,l.samples.length||l.sampleCount),d=l.dataOffset||0,f=0,v=-1;if(!l.samples.length&&l.sampleCount){i[o.trackId]=[];for(var b=0;b<l.sampleCount;b++)i[o.trackId].push({offset:d,dts:f,duration:h,size:c}),f+=h,d+=c}else i[o.trackId]=l.samples.map(function(m,y){return m={offset:d,dts:f,pts:f+(m.cts||0),duration:m.duration||h,size:m.size||c,gopId:v,keyframe:y===0||m.flags!==null&&m.flags!==void 0&&(m.flags&65536)>>>0!==65536},m.keyframe&&(v++,m.gopId=v),f+=m.duration,d+=m.size,m})}}),i}},{key:"moovToSamples",value:function(e){var t=e.trak;if(!(!t||!t.length)){var r=t.find(function(G){var z,p;return((z=G.mdia)===null||z===void 0||(p=z.hdlr)===null||p===void 0?void 0:p.handlerType)==="vide"}),i=t.find(function(G){var z,p;return((z=G.mdia)===null||z===void 0||(p=z.hdlr)===null||p===void 0?void 0:p.handlerType)==="soun"});if(!(!r&&!i)){var a,o;if(r){var u,l,c=(u=r.mdia)===null||u===void 0||(l=u.minf)===null||l===void 0?void 0:l.stbl;if(!c)return;var h=c.stts,d=c.stsc,f=c.stsz,v=c.stco,b=c.stss,m=c.ctts;if(!h||!d||!f||!v||!b)return;a=vr(h,d,f,v,m,b)}if(i){var y,A,k,w=(y=i.mdia)===null||y===void 0||(A=y.minf)===null||A===void 0?void 0:A.stbl;if(!w)return;var E=(k=i.mdia.mdhd)===null||k===void 0?void 0:k.timescale,B=w.stts,R=w.stsc,U=w.stsz,N=w.stco;if(!E||!B||!R||!U||!N)return;o=vr(B,R,U,N)}return{videoSamples:a,audioSamples:o}}}}}]),n}();function vr(n,s,e,t,r,i){var a=[],o=r==null?void 0:r.entries,u=s.entries,l=t.entries,c=e.entrySizes,h=i==null?void 0:i.entries,d;h&&(d={},h.forEach(function(R){d[R-1]=!0}));var f;o&&(f=[],o.forEach(function(R){for(var U=R.count,N=R.offset,G=0;G<U;G++)f.push(N)}));var v,b=-1,m=0,y=0,A=0,k=0,w=0,E=u[0].samplesPerChunk,B=u[1]?u[1].firstChunk-1:1/0;return n.entries.forEach(function(R){for(var U=R.count,N=R.delta,G=0;G<U;G++)v={dts:m,duration:N,size:c[y]||e.sampleSize,offset:l[A]+w,index:y},h&&(v.keyframe=d[y],v.keyframe&&b++,v.gopId=b),f&&y<f.length&&(v.pts=v.dts+f[y]),a.push(v),m+=N,y++,y<E?w+=v.size:(A++,w=0,A>=B&&(k++,B=u[k+1]?u[k+1].firstChunk-1:1/0),E+=u[k].samplesPerChunk)}),a}function Ot(n,s){return n.dataReferenceIndex=ee(s,6),n.width=ee(s,24),n.height=ee(s,26),n.horizresolution=C(s,28),n.vertresolution=C(s,32),n.frameCount=ee(s,40),n.depth=ee(s,74),78}function pr(n,s){return n.dataReferenceIndex=ee(s,6),n.channelCount=ee(s,16),n.sampleSize=ee(s,18),n.sampleRate=C(s,24)/65536,28}function j(n,s,e){if(n){if(n.size!==n.data.length)throw new Error("box ".concat(n.type," size !== data.length"));var t={start:n.start,size:n.size,headerSize:n.headerSize,type:n.type};return s&&(t.version=n.data[n.headerSize],t.flags=en(n.data,n.headerSize+1),t.headerSize+=4),e(t,n.data.subarray(t.headerSize),t.start+t.headerSize),t}}var dn=function(s,e,t){for(var r=String(t),i=e>>0,a=Math.ceil(i/r.length),o=[],u=String(s);a--;)o.push(r);return o.join("").substring(0,i-u.length)+u},Pt=function(){for(var s=[],e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.forEach(function(i){s.push(dn(Number(i).toString(16),2,0))}),s[0]},vn=function(){function n(s,e,t){re(this,n),O(this,"__loadedMoofWraps",[]),O(this,"__lastRemainData",null),O(this,"__lastRemainDataStart",0),O(this,"__nextMoofStart",-1),this.videoTrack=s||new Pr,this.audioTrack=e||new Rr,this.metadataTrack=t||new Ir}return ie(n,[{key:"demuxPart",value:function(e,t,r){var i=this,a=this.videoTrack,o=this.audioTrack,u=a.exist(),l=o.exist(),c=/av01/.test(a.codec);a.samples=[],o.samples=[];var h=e,d=t;if(this.__lastRemainData){var f=this.__lastRemainDataStart+this.__lastRemainData.byteLength,v=t<=f&&t>this.__lastRemainDataStart&&t+e.byteLength>f;if(v){var b=e.subarray(this.__lastRemainData.byteLength+this.__lastRemainDataStart-t);h=_e(this.__lastRemainData,b),d=this.__lastRemainDataStart,this.__lastRemainData=null}else this.__lastRemainData=null,this.__lastRemainDataStart=0,this.__nextMoofStart=-1}if(!r){var m=Z.findBox(h,["moov"])[0];if(!m)throw new Error("cannot found moov box");r=Z.moov(m)}if(h){var y=d+h.byteLength;!u&&!l&&Z.moovToTrack(r,a,o);var A=[];this.__nextMoofStart<0?Z.findBox(h,["moof"],d).forEach(function(R){return A.push(R)}):this.__nextMoofStart>=d&&this.__nextMoofStart<=y-8&&Z.findBox(h.subarray(this.__nextMoofStart-d),["moof"],this.__nextMoofStart).forEach(function(R){return A.push(R)}),A.filter(function(R){return R.size<=R.data.length}).forEach(function(R){var U=Z.moof(R);i.__nextMoofStart=U.start+Math.max.apply(Math,pe(U.traf.map(function(N){return N.trun.samples.reduce(function(G,z){return G+z.size},N.trun.dataOffset||0)}))),i.__loadedMoofWraps.push({start:U.start,nextMoofStart:i.__nextMoofStart,moof:U}),i.__loadedMoofWraps.sort(function(N,G){return N.start-G.start})});var k=Yi(this.__loadedMoofWraps),w;try{var E=function(){var U=w.value;if(U.start>y||U.nextMoofStart<d)return"continue";var N=U.start,G=Z.moofToSamples(U.moof,a,o),z=a.baseMediaDecodeTime,p=o.baseMediaDecodeTime,g;Object.keys(G).forEach(function(_){a.id==_?G[_].some(function(D){var T=D.offset+=N;if(!(T<d)){if(T+D.size>y)return!0;var P=new Ht((D.pts||D.dts)+z,D.dts+z);P.duration=D.duration,P.gopId=D.gopId,D.keyframe&&P.setToKeyframe();var x=h.subarray(T-d,T-d+D.size);if(P.data=x,!c)for(var H=0,W=x.length-1;H<W;)g=C(x,H),H+=4,P.units.push(x.subarray(H,H+g)),H+=g;i.__lastRemainDataStart=T+D.size,a.samples.push(P)}}):o.id==_&&G[_].some(function(D){var T=D.offset+N;if(!(T<d)){if(T+D.size>y)return!0;var P=h.subarray(T-d,T-d+D.size);o.samples.push(new qe(D.dts+p,P,D.duration)),i.__lastRemainDataStart=T+D.size}})})};for(k.s();!(w=k.n()).done;)var B=E()}catch(R){k.e(R)}finally{k.f()}}return this.__lastRemainDataStart>d&&this.__lastRemainDataStart<h.byteLength+d?this.__lastRemainData=h.subarray(this.__lastRemainDataStart-d):(this.__lastRemainData=h,this.__lastRemainDataStart=d),a.samples.length&&(a.baseMediaDecodeTime=a.samples[0].pts),o.samples.length&&(o.baseMediaDecodeTime=o.samples[0].pts),{videoTrack:a,audioTrack:o,metadataTrack:this.metadataTrack}}},{key:"demux",value:function(e,t){var r=this.videoTrack,i=this.audioTrack,a=r.exist(),o=i.exist();if(r.samples=[],i.samples=[],t){if(!o){var u=Z.findBox(t,["moov"])[0];if(!u)throw new Error("cannot found moov box");Z.moovToTrack(Z.moov(u),null,i)}var l=Z.findBox(t,["moof"])[0];if(l){var c=Z.moofToSamples(Z.moof(l),null,i)[i.id],h=i.baseMediaDecodeTime;if(c){var d=l.start;c.map(function(w){w.offset+=d;var E=t.subarray(w.offset,w.offset+w.size);i.samples.push(new qe(w.dts+h,E,w.duration))})}}}if(e){if(!a&&!o){var f=Z.findBox(e,["moov"])[0];if(!f)throw new Error("cannot found moov box");Z.moovToTrack(Z.moov(f),r,i)}var v=Z.findBox(e,["moof"])[0];if(v){var b=Z.moofToSamples(Z.moof(v),r,i),m=r.baseMediaDecodeTime,y=i.baseMediaDecodeTime,A=v.start,k;Object.keys(b).forEach(function(w){r.id==w?b[w].map(function(E){E.offset+=A;var B=new Ht((E.pts||E.dts)+m,E.dts+m);B.duration=E.duration,B.gopId=E.gopId,E.keyframe&&B.setToKeyframe();var R=e.subarray(E.offset,E.offset+E.size);B.data=R;for(var U=0,N=R.length-1;U<N;)k=C(R,U),U+=4,B.units.push(R.subarray(U,U+k)),U+=k;r.samples.push(B)}):i.id==w&&b[w].map(function(E){E.offset+=A;var B=e.subarray(E.offset,E.offset+E.size);i.samples.push(new qe(E.dts+y,B,E.duration))})})}}return{videoTrack:r,audioTrack:i,metadataTrack:this.metadataTrack}}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset(),this.metadataTrack.reset()}}],[{key:"probe",value:function(e){return Z.probe(e)}}]),n}();function pn(n){for(var s=0,e=arguments.length,t=new Array(e>1?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];t.forEach(function(o){s+=o.length});var i=new n(s),a=0;return t.forEach(function(o){i.set(o,a),a+=o.length}),i}var he=function(){function n(){re(this,n),this.buffer=new Uint8Array(0)}return ie(n,[{key:"write",value:function(){for(var e=this,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];r.forEach(function(a){a?e.buffer=pn(Uint8Array,e.buffer,a):window.console.warn(a)})}}],[{key:"writeUint16",value:function(e){return new Uint8Array([e>>8&255,e&255])}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,e&255])}}]),n}(),mr=Math.pow(2,32)-1,Y=function(){function n(){re(this,n)}return ie(n,null,[{key:"box",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];r=r.filter(Boolean);var a=8+r.reduce(function(l,c){return l+c.byteLength},0),o=new Uint8Array(a);o[0]=a>>24&255,o[1]=a>>16&255,o[2]=a>>8&255,o[3]=a&255,o.set(e,4);var u=8;return r.forEach(function(l){o.set(l,u),u+=l.byteLength}),o}},{key:"ftyp",value:function(e){var t=e.find(function(r){return r.type===Ie.VIDEO&&r.codecType===Ce.HEVC});return t?n.FTYPHEV1:n.FTYPAVC1}},{key:"initSegment",value:function(e){var t=n.ftyp(e),r=_e(t,n.moov(e));return r}},{key:"pssh",value:function(e){var t=new Uint8Array([1,0,0,0].concat([16,119,239,236,192,178,77,2,172,227,60,30,82,226,251,75],[0,0,0,1],cr(e.kid),[0,0,0,0]));return n.box(n.types.pssh,t)}},{key:"moov",value:function(e){if(e[0].useEME&&(e[0].encv||e[0].enca)){e[0].pssh||(e[0].pssh={kid:e[0].kid});var t=this.pssh(e[0].pssh);return n.box.apply(n,[n.types.moov,n.mvhd(e[0].mvhdDurtion||e[0].duration,e[0].mvhdTimecale||e[0].timescale),n.mvex(e)].concat(pe(e.map(function(r){return n.trak(r)})),[t]))}else return n.box.apply(n,[n.types.moov,n.mvhd(e[0].mvhdDurtion||e[0].duration,e[0].mvhdTimecale||e[0].timescale)].concat(pe(e.map(function(r){return n.trak(r)})),[n.mvex(e)]))}},{key:"mvhd",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4,r=n.box(n.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]));return r}},{key:"trak",value:function(e){var t=n.box(n.types.trak,n.tkhd(e.id,e.tkhdDuration||0,e.width,e.height),n.mdia(e));return t}},{key:"tkhd",value:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,a=n.box(n.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,e>>24&255,e>>16&255,e>>8&255,e&255,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,r&255,0,0,i>>8&255,i&255,0,0]));return a}},{key:"mdia",value:function(e){var t=n.box(n.types.mdia,n.mdhd(e.duration,e.timescale),n.hdlr(e.type),n.minf(e));return t}},{key:"mdhd",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4,r=n.box(n.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,85,196,0,0]));return r}},{key:"hdlr",value:function(e){var t=n.box(n.types.hdlr,n.HDLR_TYPES[e]);return t}},{key:"minf",value:function(e){var t=n.box(n.types.minf,e.type===Ie.VIDEO?n.VMHD:n.SMHD,n.DINF,n.stbl(e));return t}},{key:"stbl",value:function(e){var t=[];e&&e.ext&&e.ext.stss&&t.push(n.stss(e.ext.stss.entries));var r=n.box(n.types.stbl,n.stsd(e),n.STTS,t[0],n.STSC,n.STSZ,n.STCO);return r}},{key:"stsd",value:function(e){var t;e.type==="audio"?e.useEME&&e.enca?t=n.enca(e):e.codecType===Se.OPUS?t=n.opus(e):t=n.mp4a(e):e.useEME&&e.encv?t=n.encv(e):e.av1C?t=n.av01(e):t=n.avc1hev1(e);var r=n.box(n.types.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),t);return r}},{key:"enca",value:function(e){var t=e.enca.channelCount,r=e.enca.sampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,r>>8&255,r&255,0,0]),a=n.esds(e.config),o=n.sinf(e.enca);return n.box(n.types.enca,i,a,o)}},{key:"encv",value:function(e){var t,r,i=e.sps.length>0?e.sps[0]:[],a=e.pps.length>0?e.pps[0]:[],o=e.width,u=e.height,l=e.sarRatio[0],c=e.sarRatio[1],h=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,o&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),d=new Uint8Array((t=(r=[1,i[1],i[2],i[3],255,225,i.length>>>8&255,i.length&255]).concat.apply(r,pe(i)).concat([1,a.length>>>8&255,a.length&255])).concat.apply(t,pe(a))),f=new Uint8Array([0,0,88,57,0,15,200,192,0,4,86,72]),v=n.sinf(e.encv),b=new Uint8Array([l>>24,l>>16&255,l>>8&255,l&255,c>>24,c>>16&255,c>>8&255,c&255]);return n.box(n.types.encv,h,n.box(n.types.avcC,d),n.box(n.types.btrt,f),v,n.box(n.types.pasp,b))}},{key:"schi",value:function(e){var t=new Uint8Array([]),r=n.tenc(e);return n.box(n.types.schi,t,r)}},{key:"tenc",value:function(e){var t=new Uint8Array([0,0,0,0,0,0,e.default_IsEncrypted&255,e.default_IV_size&255].concat(cr(e.default_KID)));return n.box(n.types.tenc,t)}},{key:"sinf",value:function(e){var t=new Uint8Array([]),r=new Uint8Array([e.data_format.charCodeAt(0),e.data_format.charCodeAt(1),e.data_format.charCodeAt(2),e.data_format.charCodeAt(3)]),i=new Uint8Array([0,0,0,0,99,101,110,99,0,1,0,0]),a=n.schi(e);return n.box(n.types.sinf,t,n.box(n.types.frma,r),n.box(n.types.schm,i),a)}},{key:"av01",value:function(e){return n.box(n.types.av01,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e.width>>8&255,e.width&255,e.height>>8&255,e.height&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),e.av1C,e.colr)}},{key:"avc1hev1",value:function(e){var t=e.codecType===Ce.HEVC,r=t?n.types.hvc1:n.types.avc1,i=t?n.hvcC(e):n.avcC(e),a=[new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e.width>>8&255,e.width&255,e.height>>8&255,e.height&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),i];return t?a.push(n.box(n.types.fiel,new Uint8Array([1,0]))):e.sarRatio&&e.sarRatio.length>1&&a.push(n.pasp(e.sarRatio)),n.box.apply(n,[r].concat(a))}},{key:"avcC",value:function(e){var t,r,i=[],a=[],o;return e.sps.forEach(function(u){o=u.byteLength,i.push(o>>>8&255),i.push(o&255),i.push.apply(i,pe(u))}),e.pps.forEach(function(u){o=u.byteLength,a.push(o>>>8&255),a.push(o&255),a.push.apply(a,pe(u))}),n.box(n.types.avcC,new Uint8Array((t=(r=[1,i[3],i[4],i[5],255,224|e.sps.length]).concat.apply(r,i).concat([e.pps.length])).concat.apply(t,a)))}},{key:"hvcC",value:function(e){var t=e.hvcC;if(t instanceof ArrayBuffer||t instanceof Uint8Array)return t;var r=e.vps,i=e.sps,a=e.pps,o;if(t){var u=t.generalProfileCompatibilityFlags,l=t.generalConstraintIndicatorFlags,c=(r.length&&1)+(i.length&&1)+(a.length&&1);o=[1,t.generalProfileSpace<<6|t.generalTierFlag<<5|t.generalProfileIdc,u>>>24,u>>>16,u>>>8,u,l[0],l[1],l[2],l[3],l[4],l[5],t.generalLevelIdc,240,0,252,t.chromaFormatIdc|252,t.bitDepthLumaMinus8|248,t.bitDepthChromaMinus8|248,0,0,t.numTemporalLayers<<3|t.temporalIdNested<<2|3,c];var h=function(f){var v;o.push(f.length>>8,f.length),(v=o).push.apply(v,pe(f))};r.length&&(o.push(160,0,r.length),r.forEach(h)),i.length&&(o.push(161,0,i.length),i.forEach(h)),a.length&&(o.push(162,0,a.length),a.forEach(h))}else o=[1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64];return n.box(n.types.hvcC,new Uint8Array(o))}},{key:"pasp",value:function(e){var t=Gi(e,2),r=t[0],i=t[1];return n.box(n.types.pasp,new Uint8Array([r>>24,r>>16&255,r>>8&255,r&255,i>>24,i>>16&255,i>>8&255,i&255]))}},{key:"mp4a",value:function(e){return n.box(n.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,e.sampleRate>>8&255,e.sampleRate&255,0,0]),e.config.length?n.esds(e.config):void 0)}},{key:"esds",value:function(e){var t=e.length,r=n.box(n.types.esds,new Uint8Array([0,0,0,0,3,23+t,0,0,0,4,15+t,64,21,0,6,0,0,0,218,192,0,0,218,192,5].concat([t]).concat(e).concat([6,1,2])));return r}},{key:"opus",value:function(e){var t=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,e.sampleRate>>8&255,e.sampleRate&255,0,0]),r=e.config.length?n.dOps(e):[];return n.box(n.types.Opus,t,r)}},{key:"dOps",value:function(e){if(e.config)return e.config[4]=e.sampleRate>>>24&255,e.config[5]=e.sampleRate>>>16&255,e.config[6]=e.sampleRate>>>8&255,e.config[7]=e.sampleRate&255,n.box(n.types.dOps,e.config)}},{key:"mvex",value:function(e){var t=n.box.apply(n,[n.types.mvex].concat(pe(e.map(function(r){return n.trex(r.id)}))));return t}},{key:"trex",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]));return t}},{key:"trex1",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,2,0,0,0,0,0,0,1,0,0]));return t}},{key:"trex2",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,4,0,0,0,0,0,2,0,0,0]));return t}},{key:"moof",value:function(e){var t=n.box.apply(n,[n.types.moof,n.mfhd(e[0].samples?e[0].samples[0].gopId:0)].concat(pe(e.map(function(r){return n.traf(r)}))));return t}},{key:"mfhd",value:function(e){var t=n.box(n.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]));return t}},{key:"traf",value:function(e){var t=n.tfhd(e.id),r=n.tfdt(e,e.baseMediaDecodeTime),i=0,a;if(e.isVideo&&e.videoSenc&&(a=e.videoSenc,a.forEach(function(g){i=i+8,g.subsamples&&g.subsamples.length&&(i=i+2,i=i+g.subsamples.length*6)})),e.videoSencLength=i,!e.useEME||!e.isVideoEncryption&&!e.isAudioEncryption){var o=n.sdtp(e),u=16+20+8+16+8+8;return n.box(n.types.traf,t,r,o,n.trun(e.samples,o.byteLength+u))}else if(e.isVideoEncryption)if(e.isVideo){var l=n.saiz(e),c=n.saio(e),h=n.trun1(e),d=n.senc(e),f=n.box(n.types.traf,t,r,l,c,h,d);return f}else if(e.isAudioEncryption){var m=n.sbgp(),y=n.saiz(e),A=n.saio(e),k=n.senc(e),w=n.trun1(e),E=n.box(n.types.traf,t,r,m,y,A,k,w);return E}else{var v=n.sbgp(),b=n.trun1(e);return n.box(n.types.traf,t,r,v,b)}else if(e.isVideo){var B=n.trun1(e);return n.box(n.types.traf,t,r,B)}else{var R=n.sbgp(),U=n.saiz(e),N=n.saio(e),G=n.senc(e),z=n.trun1(e),p=n.box(n.types.traf,t,r,R,U,N,G,z);return p}}},{key:"sdtp",value:function(e){var t=new he;return e.samples.forEach(function(r){t.write(new Uint8Array(e.isVideo?[r.keyframe?32:16]:[16]))}),n.box(n.types.sdtp,this.extension(0,0),t.buffer)}},{key:"trun1",value:function(e){var t=new he,r=he.writeUint32(e.samples.length),i=null;if(e.isVideo){var a=e.videoSencLength;i=he.writeUint32(e.samples.length*16+a+149),!e.isVideoEncryption&&e.isAudioEncryption&&(i=he.writeUint32(e.samples.length*16+92))}else{var o=e.samples.length*12+124;e.isAudioEncryption&&(o=e.samples.length*12+8*e.audioSenc.length+177),i=he.writeUint32(o)}return e.samples.forEach(function(u){t.write(he.writeUint32(u.duration)),t.write(he.writeUint32(u.size)),t.write(he.writeUint32(u.keyframe?33554432:65536)),e.isVideo&&t.write(he.writeUint32(u.cts?u.cts:0))}),n.box(n.types.trun,this.extension(0,e.flags),r,i,t.buffer)}},{key:"senc",value:function(e){var t=new he,r=e.samples.length,i=e.isVideo?16:8,a=e.isVideo?2:0,o=[],u=0;return e.isVideo?(o=e.videoSenc,u=e.videoSencLength):o=e.audioSenc,u=u||i*r,t.write(he.writeUint32(16+u),n.types.senc,this.extension(0,a)),t.write(he.writeUint32(r)),o.forEach(function(l){for(var c=0;c<l.InitializationVector.length;c++)t.write(new Uint8Array([l.InitializationVector[c]]));l.subsamples&&l.subsamples.length&&(t.write(he.writeUint16(l.subsamples.length)),l.subsamples.forEach(function(h){t.write(he.writeUint16(h.BytesOfClearData)),t.write(he.writeUint32(h.BytesOfProtectedData))}))}),t.buffer}},{key:"saio",value:function(e){var t=e.samples.length*12+141;!e.isVideo&&e.isAudioEncryption&&(t=149);var r=new Uint8Array([1,0,0,0,0,0,0,1,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255]);return n.box(n.types.saio,r)}},{key:"saiz",value:function(e){var t=e.samples.length,r=new Uint8Array([0,0,0,0,16,t>>24&255,t>>16&255,t>>8&255,t&255]);return n.box(n.types.saiz,r)}},{key:"sbgp",value:function(){var e=new Uint8Array([114,111,108,108,0,0,0,1,0,0,1,25,0,0,0,1]);return n.box(n.types.sbgp,this.extension(0,0),e)}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,t&255])}},{key:"tfhd",value:function(e){return n.box(n.types.tfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}},{key:"tfdt",value:function(e,t){var r=Math.floor(t/(mr+1)),i=Math.floor(t%(mr+1));return e.useEME&&(e.isVideoEncryption||e.isAudioEncryption)?n.box(n.types.tfdt,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])):n.box(n.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,i>>24,i>>16&255,i>>8&255,i&255]))}},{key:"trun",value:function(e,t){var r=e.length,i=12+16*r;t+=8+i;var a=new Uint8Array(i);a.set([0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,r&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0);for(var o=0;o<r;o++){var u=e[o],l=u.duration,c=u.size,h=u.flag,d=h===void 0?{}:h,f=u.cts,v=f===void 0?0:f;a.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,c>>>24&255,c>>>16&255,c>>>8&255,c&255,d.isLeading<<2|(d.dependsOn===null||d.dependsOn===void 0?1:d.dependsOn),d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|(d.isNonSyncSample===null||d.isNonSyncSample===void 0?1:d.isNonSyncSample),d.degradationPriority&61440,d.degradationPriority&15,v>>>24&255,v>>>16&255,v>>>8&255,v&255],12+16*o)}return n.box(n.types.trun,a)}},{key:"moovMP4",value:function(e){return n.box.apply(n,[n.types.moov,n.mvhd(e[0].duration,e[0].timescale)].concat(pe(e.map(function(t){return n.trackMP4(t)}))))}},{key:"trackMP4",value:function(e){return n.box(n.types.trak,n.tkhd(e.id,e.duration,e.width,e.height),n.mdiaMP4(e))}},{key:"mdiaMP4",value:function(e){return n.box(n.types.mdia,n.mdhd(e.duration,e.timescale),n.hdlr(e.type),n.minfMP4(e))}},{key:"minfMP4",value:function(e){return n.box(n.types.minf,e.type===Ie.VIDEO?n.VMHD:n.SMHD,n.DINF,n.stblMP4(e))}},{key:"stblMP4",value:function(e){var t=e.ext,r=[n.stsd(e),n.stts(t.stts),n.stsc(t.stsc),n.stsz(t.stsz),n.stco(t.stco)];return t.stss.length&&r.push(n.stss(t.stss)),t.ctts.length&&r.push(n.ctts(t.ctts)),n.box.apply(n,[n.types.stbl].concat(r))}},{key:"stts",value:function(e){var t=e.length,r=new Uint8Array(8*t),i=0;return e.forEach(function(a){var o=a.value,u=a.count;r.set([u>>24,u>>16&255,u>>8&255,u&255,o>>24,o>>16&255,o>>8&255,o&255],i),i+=8}),n.box(n.types.stts,_e(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stsc",value:function(e){var t=e.length,r=new Uint8Array(12*t),i=0;return e.forEach(function(a){var o=a.firstChunk,u=a.samplesPerChunk,l=a.sampleDescIndex;r.set([o>>24,o>>16&255,o>>8&255,o&255,u>>24,u>>16&255,u>>8&255,u&255,l>>24,l>>16&255,l>>8&255,l&255],i),i+=12}),n.box(n.types.stsc,_e(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stsz",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(a){r.set([a>>24,a>>16&255,a>>8&255,a&255],i),i+=4}),n.box(n.types.stsz,_e(new Uint8Array([0,0,0,0,0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stco",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(a){r.set([a>>24,a>>16&255,a>>8&255,a&255],i),i+=4}),n.box(n.types.stco,_e(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stss",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(a){r.set([a>>24,a>>16&255,a>>8&255,a&255],i),i+=4}),n.box(n.types.stss,_e(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"ctts",value:function(e){var t=e.length,r=new Uint8Array(8*t),i=0;return e.forEach(function(a){var o=a.value,u=a.count;r.set([u>>24,u>>16&255,u>>8&255,u&255,o>>24,o>>16&255,o>>8&255,o&255],i),i+=8}),n.box(n.types.ctts,_e(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"styp",value:function(){return n.box(n.types.styp,new Uint8Array([109,115,100,104,0,0,0,0,109,115,100,104,109,115,105,120]))}},{key:"sidx",value:function(e){var t=e.timescale,r=e.samples[0].duration,i=r*e.samples.length,a=e.samples[0].sampleOffset*r,o=8;e.samples.forEach(function(d){o+=d.size});var u=0;if(e.isVideo){var l=0,c;e.videoSenc&&(c=e.videoSenc),e.isVideo&&c.forEach(function(d){l=l+8,d.subsamples&&d.subsamples.length&&(l=l+2,l=l+d.subsamples.length*6)}),e.videoSencLength=l,u=o+141+e.samples.length*16+l,e.useEME&&e.isAudioEncryption&&!e.isVideoEncryption&&(u=o+e.samples.length*16+84)}else u=o+116+e.samples.length*12,e.useEME&&e.isAudioEncryption&&(u=o+169+e.samples.length*12+8*e.audioSenc.length);var h=new Uint8Array([0,0,0,0,0,0,0,e.id&255,t>>24&255,t>>16&255,t>>8&255,t&255,a>>24&255,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,1,0,u>>16&255,u>>8&255,u&255,i>>24&255,i>>16&255,i>>8&255,i&255,144,0,0,0]);return n.box(n.types.sidx,h)}},{key:"mdat",value:function(e){var t=n.box(n.types.mdat,e);return t}}]),n}();O(Y,"types",["Opus","dOps","av01","av1C","avc1","avcC","hvc1","hvcC","dinf","dref","esds","ftyp","hdlr","mdat","mdhd","mdia","mfhd","minf","moof","moov","mp4a","mvex","mvhd","pasp","stbl","stco","stsc","stsd","stsz","stts","tfdt","tfhd","traf","trak","trex","tkhd","vmhd","smhd","ctts","stss","styp","pssh","sidx","sbgp","saiz","saio","senc","trun","encv","enca","sinf","btrt","frma","tenc","schm","schi","mehd","fiel","sdtp"].reduce(function(n,s){return n[s]=[s.charCodeAt(0),s.charCodeAt(1),s.charCodeAt(2),s.charCodeAt(3)],n},Object.create(null)));O(Y,"HDLR_TYPES",{video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])});O(Y,"FTYPAVC1",Y.box(Y.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49])));O(Y,"FTYPHEV1",Y.box(Y.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,104,101,118,49])));O(Y,"DINF",Y.box(Y.types.dinf,Y.box(Y.types.dref,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]))));O(Y,"VMHD",Y.box(Y.types.vmhd,new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])));O(Y,"SMHD",Y.box(Y.types.smhd,new Uint8Array([0,0,0,0,0,0,0,0])));O(Y,"StblTable",new Uint8Array([0,0,0,0,0,0,0,0]));O(Y,"STTS",Y.box(Y.types.stts,Y.StblTable));O(Y,"STSC",Y.box(Y.types.stsc,Y.StblTable));O(Y,"STSZ",Y.box(Y.types.stsz,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0])));O(Y,"STCO",Y.box(Y.types.stco,Y.StblTable));var Br=function(){function n(s,e){re(this,n),this.name=s||"",this._prefix="[".concat(this.name,"]"),n.disabled=e}return ie(n,[{key:"debug",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).debug.apply(e,[this._prefix].concat(r))}}},{key:"log",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).log.apply(e,[this._prefix].concat(r))}}},{key:"warn",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).warn.apply(e,[this._prefix].concat(r))}}},{key:"error",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).error.apply(e,[this._prefix].concat(r))}}},{key:"table",value:function(){var e;n.disabled||(console.group(this._prefix),(e=console).table.apply(e,arguments),console.groupEnd())}}],[{key:"enable",value:function(){n.disabled=!1}},{key:"disable",value:function(){n.disabled=!0}}]),n}();O(Br,"disabled",!0);var mn=function(){function n(s,e,t){re(this,n),this.videoTrack=s,this.audioTrack=e;var r=/Chrome\/([^.]+)/.exec(navigator.userAgent);this.forceFirstIDR=r&&Number(r[1])<50,this.log=new Br("FMP4Remuxer",t&&t.openLog?!t.openLog:!0)}return ie(n,[{key:"remux",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=this.videoTrack,i=this.audioTrack,a=r.exist(),o=i.exist(),u,l,c,h=[];e&&(t&&t.initMerge?(a&&h.push(this.videoTrack),o&&h.push(this.audioTrack),c=Y.initSegment(h)):(a&&(u=Y.initSegment([this.videoTrack])),o&&(l=Y.initSegment([this.audioTrack]))));var d,f;return a&&r.hasSample()&&(d=this._remuxVideo()),o&&i.hasSample()&&(f=this._remuxAudio()),r.samples=[],i.samples=[],{initSegment:c,videoInitSegment:u,audioInitSegment:l,videoSegment:d,audioSegment:f}}},{key:"_remuxVideo",value:function(){var e=this.videoTrack;this.forceFirstIDR&&(e.samples[0].flag={dependsOn:2,isNonSyncSample:0});var t=e.samples,r=/av01/.test(e.codec),i=0;r?t.forEach(function(k){i+=k.data.byteLength}):t.forEach(function(k){i+=k.units.reduce(function(w,E){return w+E.byteLength},0),i+=k.units.length*4});var a=new Uint8Array(i);if(r)for(var o=0,u=t.length,l=0,c;o<u;o++)c=t[o],a.set(c.data,l),c.size=c.data.byteLength,l+=c.size;else for(var h=new DataView(a.buffer),d=function(w,E){E=t[f];var B=0;E.units.forEach(function(R){h.setUint32(w,R.byteLength),w+=4,a.set(R,w),w+=R.byteLength,B+=4+R.byteLength}),E.size=B,b=w,m=E},f=0,v=t.length,b=0,m;f<v;f++)d(b,m);var y=Y.mdat(a),A=Y.moof([e]);return _e(A,y)}},{key:"_remuxAudio",value:function(){var e=this.audioTrack,t=new Uint8Array(e.samples.reduce(function(a,o){return a+o.size},0));e.samples.reduce(function(a,o){return t.set(o.data,a),a+o.size},0);var r=Y.mdat(t),i=Y.moof([e]);return _e(i,r)}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset()}}]),n}(),gn=function(){function n(){ae(this,n);var s=window.crypto||window.msCrypto;this.subtle=s&&(s.subtle||s.webkitSubtle),this.externalDecryptor=null}return se(n,[{key:"destroy",value:function(){var e;(e=this.externalDecryptor)!==null&&e!==void 0&&e.destroy&&this.externalDecryptor.destroy()}},{key:"decrypt",value:function(e,t){if(!(!e&&!t)){var r=[];return e&&(r[0]=this._decryptSegment(e)),t&&(r[1]=this._decryptSegment(t)),Promise.all(r)}}},{key:"_decryptSegment",value:function(){var s=Q(M().mark(function t(r){var i;return M().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(i=r.data,!r.key){o.next=5;break}return o.next=4,this._decryptData(r.data,r.key,r.keyIv);case 4:i=o.sent;case 5:if(r.map){o.next=7;break}return o.abrupt("return",i);case 7:return o.abrupt("return",ft(r.map,i));case 8:case"end":return o.stop()}},t,this)}));function e(t){return s.apply(this,arguments)}return e}()},{key:"_decryptData",value:function(){var s=Q(M().mark(function t(r,i,a){var o;return M().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(!this.externalDecryptor){l.next=6;break}return l.next=3,this.externalDecryptor.decrypt(r,i,a);case 3:return l.abrupt("return",l.sent);case 6:if(this.subtle){l.next=8;break}throw new Error("crypto is not defined");case 8:return l.next=10,this.subtle.importKey("raw",i,{name:"AES-CBC"},!1,["encrypt","decrypt"]);case 10:return o=l.sent,l.t0=Uint8Array,l.next=14,this.subtle.decrypt({name:"AES-CBC",iv:a},o,r);case 14:return l.t1=l.sent,l.abrupt("return",new l.t0(l.t1));case 16:case"end":return l.stop()}},t,this)}));function e(t,r,i){return s.apply(this,arguments)}return e}()}]),n}(),X=J(J({},V),{},{STREAM_PARSED:"core.streamparsed",NO_AUDIO_TRACK:"core.noaudiotrack",SUBTITLE_SEGMENTS:"core.subtitlesegments",SUBTITLE_PLAYLIST:"core.subtitleplaylist",SEI_PAYLOAD_TIME:"core.seipayloadtime",APPEND_COST:"core.appendcost"}),Rt=new De("Transmuxer"),gr=function(){function n(s,e,t,r){ae(this,n),S(this,"_initSegmentId",""),this.hls=s,this._demuxer=e?new vn:new Ur(null,null,null,r),this._isMP4=e,t&&(this._remuxer=new mn(this._demuxer.videoTrack,this._demuxer.audioTrack))}return se(n,[{key:"transmux",value:function(e,t,r,i,a,o){var u=this._demuxer;try{this._isMP4?u.demux(e,t):u.demuxAndFix(ft(e,t),r,i,a)}catch(B){throw new te(q.DEMUX,q.SUB_TYPES.HLS,B)}var l=u.videoTrack,c=u.audioTrack,h=u.metadataTrack,d={codec:l.codec,timescale:l.timescale,firstDts:l.firstDts/l.timescale,firstPts:l.firstPts/l.timescale,duration:l.samplesDuration/l.timescale},f={codec:c.codec,timescale:c.timescale,firstDts:c.firstDts/l.timescale,firstPts:c.firstPts/l.timescale,duration:c.samplesDuration/l.timescale,container:c.container},v="".concat(l.codec,"/").concat(l.width,"/").concat(l.height,"/").concat(c.codec,"/").concat(c.config);if(v!==this._initSegmentId&&(this._initSegmentId=v,o=!0),this._fireEvents(l,c,h,r||o),this.hls.emit(X.DEMUXED_TRACK,{videoTrack:l,audioTrack:c}),this._remuxer){o&&this.hls.isLive&&!this.hls.config.mseLowLatency&&(l.duration=this.hls.totalDuration*l.timescale,c.duration=this.hls.totalDuration*c.timescale);try{var b=this._remuxer.remux(o),m=b.videoInitSegment,y=b.videoSegment,A=b.audioInitSegment,k=b.audioSegment,w=ft(m,y),E=ft(A,k);return[w?J(J({},d),{},{data:w}):void 0,E?J(J({},f),{},{data:E}):void 0]}catch(B){throw new te(q.REMUX,q.SUB_TYPES.FMP4,B)}}else return[l,c]}},{key:"_fireEvents",value:function(e,t,r,i){var a=this,o=[e,t],u="discontinuity: ".concat(i);o.forEach(function(l){var c;(c=l.samples)!==null&&c!==void 0&&c.length&&(u+="; ".concat(l.samples.length," ").concat(l.type===Ie.VIDEO?"video":"audio"," samples, firstDts/firstPts/duration: ").concat((l.firstDts/l.timescale).toFixed(3),"/").concat((l.firstPts/l.timescale).toFixed(3),"/").concat((l.samplesDuration/l.timescale).toFixed(3))),i&&l.exist()&&a.hls.emit(X.METADATA_PARSED,{type:l.type,track:l,meta:J({codec:l.codec,timescale:l.timescale,baseDts:l.baseDts},l.type===Ie.VIDEO?{width:l.width,height:l.height,sarRatio:l.sarRatio}:{codec:l.codec,channelCount:l.channelCount,sampleRate:l.sampleRate})})}),Rt.debug(u),e.warnings.forEach(function(l){var c;switch(l.type){case we.LARGE_AV_SHIFT:c=X.LARGE_AV_FIRST_FRAME_GAP_DETECT;break;case we.LARGE_VIDEO_GAP:c=X.LARGE_VIDEO_DTS_GAP_DETECT;break;case we.LARGE_VIDEO_GAP_BETWEEN_CHUNK:c=X.MAX_DTS_DELTA_WITH_NEXT_SEGMENT_DETECT;break}c&&a.hls.emit(X.STREAM_EXCEPTION,J(J({},l),{},{type:c})),Rt.warn("video exception",l)}),t.warnings.forEach(function(l){var c;switch(l.type){case we.LARGE_AUDIO_GAP:c=X.LARGE_AUDIO_DTS_GAP_DETECT;break;case we.AUDIO_FILLED:c=X.AUDIO_GAP_DETECT;break;case we.AUDIO_DROPPED:c=X.AUDIO_OVERLAP_DETECT;break}c&&a.hls.emit(X.STREAM_EXCEPTION,J(J({},l),{},{type:c})),Rt.warn("audio exception",l)}),e.samples.forEach(function(l){l.keyframe&&a.hls.emit(X.KEYFRAME,{pts:l.pts})}),r.seiSamples.forEach(function(l){a.hls.emit(X.SEI,J(J({},l),{},{originPts:l.originPts/90,sei:{code:l.data.type,content:l.data.payload,dts:l.pts}}))})}}]),n}(),yn=["data"],_n=["data"],yr=new De("BufferService"),Sn=function(){function n(s){var e=this;ae(this,n),S(this,"_decryptor",new gn),S(this,"_transmuxer",null),S(this,"_mse",null),S(this,"_softVideo",null),S(this,"_sourceCreated",!1),S(this,"_needInitSegment",!0),S(this,"_directAppend",!1),this.hls=s,s.config.softDecode?this._softVideo=s.media:(this._mse=new de(null,{preferMMS:s.config.preferMMS}),s.config.url&&this._mse.bindMedia(s.media).then(function(t){e.hls.emit(V.MEDIASOURCE_OPENED,t)})),s.config.decryptor&&(this._decryptor.externalDecryptor=s.config.decryptor)}return se(n,[{key:"baseDts",get:function(){var e,t,r;return(e=this._transmuxer)===null||e===void 0||(t=e._demuxer)===null||t===void 0||(r=t._fixer)===null||r===void 0?void 0:r._baseDts}},{key:"nbSb",get:function(){var e;return(e=this._mse)!==null&&e!==void 0&&e._sourceBuffer?Object.keys(this._mse._sourceBuffer).length:0}},{key:"msIsOpened",get:function(){var e;return(e=this._mse)===null||e===void 0?void 0:e.isOpened}},{key:"msHasOpTasks",get:function(){var e;return(e=this._mse)===null||e===void 0?void 0:e.hasOpTasks}},{key:"msStreaming",get:function(){var e;return(e=this._mse)===null||e===void 0?void 0:e.streaming}},{key:"updateDuration",value:function(){var s=Q(M().mark(function t(r){return M().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(yr.debug("update duration",r),!this._mse){a.next=9;break}if(this._mse.isOpened){a.next=5;break}return a.next=5,this._mse.open();case 5:return a.next=7,this._mse.updateDuration(r);case 7:a.next=10;break;case 9:this._softVideo&&(this._softVideo.duration=r);case 10:case"end":return a.stop()}},t,this)}));function e(t){return s.apply(this,arguments)}return e}()},{key:"createSource",value:function(e,t,r,i){if(!this._sourceCreated){var a=e||t;if(a){if(Ur.probe(a))this._transmuxer||(this._transmuxer=new gr(this.hls,!1,!this._softVideo,this.hls.config.fixerConfig));else if(Z.probe(a))if(this._softVideo)this._transmuxer||(this._transmuxer=new gr(this.hls,!0,null,this.hls.config.fixerConfig));else{this._directAppend=!0;var o=!1;e&&!r&&Z.findBox(e,["moov","trak"]).forEach(function(u){var l=Z.findBox(u.data,["trak","mdia","minf","stbl","stsd"])[0];if(l){var c=Z.stsd(l).entries[0];if(c){if(c.hvcC)r=c.hvcC.codec||"hev1.1.6.L93.B0";else if(c.avcC)r=c.avcC.codec;else if(c.sampleRate||c.esds){var h;i=((h=c.esds)===null||h===void 0?void 0:h.codec)||"mp4a.40.2",o=!0}}}}),t&&!i&&Z.findBox(t,["moov","trak","mdia","minf","stbl","stsd"]).forEach(function(u){var l=Z.stsd(u).entries[0];l&&l.esds&&(i=l.esds.codec)}),e&&!r&&(r="avc1.42e01e"),t&&!i&&(i="mp4a.40.2"),o&&(r+=", ".concat(i),i=""),this._createMseSource(r,i)}else throw new te(q.OTHER,null,null,null,"unsupported stream");this._softVideo&&(this._sourceCreated=!0)}}}},{key:"appendBuffer",value:function(){var s=Q(M().mark(function t(r,i,a,o,u,l,c){var h=this,d,f,v,b,m,y,A,k,w,E,B,R,U,N,G;return M().wrap(function(p){for(;;)switch(p.prev=p.next){case 0:if(!(!(a!=null&&a.length)&&!(o!=null&&o.length))){p.next=2;break}return p.abrupt("return");case 2:if(d=function(){var _;if((_=h.hls)!==null&&_!==void 0&&_.emit){var D;(D=h.hls)===null||D===void 0||D.emit(V.APPEND_BUFFER,{start:r.start,end:r.end})}},!this._directAppend){p.next=8;break}return f=[],a&&f.push(this._mse.append(de.VIDEO,a)),o&&f.push(this._mse.append(de.AUDIO,o)),p.abrupt("return",Promise.all(f).then(d));case 8:if(v=this._needInitSegment||u,b=this._transmuxer.transmux(a,o,v,l,c,this._needInitSegment||u),m=Pe(b,2),y=m[0],A=m[1],o&&i&&(i==null||i.setTrackExist(!1,!0)),o&&r&&(r==null||r.setTrackExist(!0,!1)),i||r==null||r.setTrackExist(!!y,!!A),y&&!A&&this.hls.emit(X.NO_AUDIO_TRACK),!this._softVideo){p.next=20;break}this._softVideo.appendBuffer(y,A),this._needInitSegment=!1,d(),p.next=32;break;case 20:if(!this._mse){p.next=32;break}return k=!this._sourceCreated,k&&this._createMseSource(y==null?void 0:y.codec,A==null?void 0:A.codec,A==null?void 0:A.container),this._needInitSegment=!1,w=this._mse,E=[],v&&!k&&this._handleCodecChange(y,A).forEach(function(g){return E.push(g)}),y&&(B=y.data,R=Ut(y,yn),E.push(w.append(de.VIDEO,B,R))),A&&(U=A.data,N=Ut(A,_n),E.push(w.append(de.AUDIO,U,N))),G=Promise.all(E),G.then(d),p.abrupt("return",G);case 32:case"end":return p.stop()}},t,this)}));function e(t,r,i,a,o,u,l){return s.apply(this,arguments)}return e}()},{key:"removeBuffer",value:function(){var s=Q(M().mark(function t(){var r=this,i,a,o,u=arguments;return M().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(i=u.length>0&&u[0]!==void 0?u[0]:0,a=u.length>1&&u[1]!==void 0?u[1]:1/0,o=this.hls.media,!(!this._mse||!o||i<0||a<i||i>=this._mse.duration)){c.next=5;break}return c.abrupt("return");case 5:return c.abrupt("return",this._mse.clearBuffer(i,a).then(function(){return r.hls.emit(V.REMOVE_BUFFER,{start:i,end:a,removeEnd:a})}));case 6:case"end":return c.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()},{key:"evictBuffer",value:function(){var s=Q(M().mark(function t(r){var i,a,o,u;return M().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(i=this.hls.media,!(!this._mse||!i||!r||r<0)){c.next=3;break}return c.abrupt("return");case 3:if(a=i.currentTime,o=a-r,!(o<=0)){c.next=7;break}return c.abrupt("return");case 7:if(u=me.start(me.get(i)),!(u+1>=o)){c.next=10;break}return c.abrupt("return");case 10:return c.abrupt("return",this.removeBuffer(0,o));case 11:case"end":return c.stop()}},t,this)}));function e(t){return s.apply(this,arguments)}return e}()},{key:"clearAllBuffer",value:function(){var s=Q(M().mark(function t(){return M().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=2;break}return i.abrupt("return",this._mse.clearAllBuffer());case 2:case"end":return i.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()},{key:"decryptBuffer",value:function(e,t){return this._decryptor.decrypt(e,t)}},{key:"reset",value:function(){var s=Q(M().mark(function t(){var r,i=arguments;return M().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(r=i.length>0&&i[0]!==void 0?i[0]:!1,!(this._mse&&!r)){o.next=8;break}return this._transmuxer=null,this._sourceCreated=!1,o.next=6,this._mse.unbindMedia();case 6:return o.next=8,this._mse.bindMedia(this.hls.media);case 8:this._needInitSegment=!0,this._directAppend=!1;case 10:case"end":return o.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()},{key:"endOfStream",value:function(){var s=Q(M().mark(function t(){return M().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=5;break}if(!this._sourceCreated){i.next=5;break}return i.next=4,this._mse.endOfStream();case 4:this.hls.emit(V.BUFFEREOS);case 5:this._softVideo&&this._softVideo.endOfStream();case 6:case"end":return i.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()},{key:"setLiveSeekableRange",value:function(){var s=Q(M().mark(function t(r,i){return M().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:this._mse&&this._mse.setLiveSeekableRange(r,i);case 1:case"end":return o.stop()}},t,this)}));function e(t,r){return s.apply(this,arguments)}return e}()},{key:"detachMedia",value:function(){var s=Q(M().mark(function t(){return M().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=3;break}return i.next=3,this._mse.unbindMedia();case 3:case"end":return i.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()},{key:"destroy",value:function(){var s=Q(M().mark(function t(){var r;return M().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return(r=this._decryptor)===null||r===void 0||r.destroy(),a.next=3,this.detachMedia();case 3:this._decryptor=null,this._mse=null,this._softVideo=null;case 6:case"end":return a.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()},{key:"_createMseSource",value:function(e,t,r){yr.debug("create mse source, videoCodec=".concat(e,", audioCodec=").concat(t));var i=this._mse;i&&(e&&(i.createSource(de.VIDEO,"video/mp4;codecs=".concat(e)),this._sourceCreated=!0),t?(i.createSource(de.AUDIO,"audio/mp4;codecs=".concat(t)),this._sourceCreated=!0):r&&(i.createSource(de.AUDIO,"".concat(r,';codecs=""')),this._sourceCreated=!0),this.hls.emit(V.SOURCEBUFFER_CREATED))}},{key:"_handleCodecChange",value:function(e,t){var r=[],i=this._mse,a=[{type:de.VIDEO,codecs:e==null?void 0:e.codec},{type:de.AUDIO,codecs:t==null?void 0:t.codec}];return a.filter(function(o){return!!o.codecs}).forEach(function(o){var u=o.type,l=o.codecs,c=i.getSourceBuffer(u);if(c){var h=l.split(",")[0];new RegExp(h,"ig").test(c.mimeType)||r.push(i.changeType(u,"".concat(u,"/mp4;codecs=").concat(l)))}}),r}},{key:"seamlessSwitch",value:function(){this._needInitSegment=!0}},{key:"isFull",value:function(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:de.VIDEO;return(e=this._mse)===null||e===void 0?void 0:e.isFull(t)}}]),n}();function bn(n){var s=(n==null?void 0:n.media)||document.createElement("video");return J(J({maxPlaylistSize:50,retryCount:3,retryDelay:1e3,pollRetryCount:2,loadTimeout:1e4,manifestLoadTimeout:1e4,preloadTime:30,softDecode:!1,bufferBehind:10,maxJumpDistance:3,startTime:0,useLowLatency:!0,targetLatency:10,maxLatency:20,allowedStreamTrackChange:!0,seiInTime:!1,manifestList:[],minSegmentsStartPlay:3,preferMMS:!1,preferMMSStreaming:!1,mseLowLatency:!0,fixerConfig:{forceFixLargeGap:!1,largeGapThreshold:5}},n),{},{media:s})}var En=se(function n(){ae(this,n),S(this,"version",0),S(this,"streams",[]),S(this,"isMaster",!0)}),xr={Audio:"AUDIO",Video:"VIDEO",SubTitle:"SUBTITLE",ClosedCaptions:"CLOSED-CAPTIONS"},ot={CLEAR_KEY:"org.w3.clearkey",FAIRPLAY:["urn:uuid:94ce86fb-07ff-4f43-adb8-93d2fa968ca2","com.apple.streamingkeydelivery"],WIDEVINE:["urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine.alpha","com.widevine"],PLAYREADY:["urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95","com.microsoft.playready"]};function Nr(n){for(var s=[],e=0;e<n.length;e++)Array.isArray(n[e])?s=s.concat(Nr(n[e])):s.push(n[e]);return s}var Kt=se(function n(){ae(this,n),S(this,"id",0),S(this,"url",""),S(this,"default",!1),S(this,"autoSelect",!1),S(this,"forced",!1),S(this,"group",""),S(this,"name",""),S(this,"lang",""),S(this,"segments",[]),S(this,"endSN",0)}),wn=function(n){yt(e,n);var s=_t(e);function e(){var t;ae(this,e);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return t=s.call.apply(s,[this].concat(i)),S(K(t),"mediaType",xr.Audio),S(K(t),"channels",0),t}return se(e)}(Kt),Tn=function(n){yt(e,n);var s=_t(e);function e(){var t;ae(this,e);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return t=s.call.apply(s,[this].concat(i)),S(K(t),"mediaType",xr.SubTitle),t}return se(e)}(Kt),kn=se(function n(){ae(this,n),S(this,"id",0),S(this,"bitrate",0),S(this,"width",0),S(this,"height",0),S(this,"name",""),S(this,"url",""),S(this,"audioCodec",""),S(this,"videoCodec",""),S(this,"textCodec",""),S(this,"audioGroup",""),S(this,"audioStreams",[]),S(this,"subtitleStreams",[]),S(this,"closedCaptionsStream",[])}),An=se(function n(){ae(this,n),S(this,"version",0),S(this,"url",""),S(this,"type",""),S(this,"startCC",0),S(this,"endCC",0),S(this,"startSN",0),S(this,"endSN",0),S(this,"totalDuration",0),S(this,"targetDuration",0),S(this,"partTargetDuration",0),S(this,"canSkipUntil",0),S(this,"canSkipDateRanges",!1),S(this,"skippedSegments",0),S(this,"canBlockReload",!1),S(this,"partHoldBack",0),S(this,"live",!0),S(this,"lowLatency",!1),S(this,"endPartIndex",0),S(this,"segments",[]),S(this,"dateRanges",{}),S(this,"skippedSegments",0)}),ut=function(){function n(s){ae(this,n),S(this,"sn",0),S(this,"cc",0),S(this,"url",""),S(this,"parentUrl",""),S(this,"title",""),S(this,"start",0),S(this,"duration",0),S(this,"dataTime",""),S(this,"key",null),S(this,"byteRange",null),S(this,"isInitSegment",!1),S(this,"initSegment",null),S(this,"isLast",!1),S(this,"hasAudio",!1),S(this,"hasVideo",!1),S(this,"independent",!1),S(this,"partIndex",0),this.parentUrl=s}return se(n,[{key:"end",get:function(){return this.start+this.duration}},{key:"setTrackExist",value:function(e,t){this.hasVideo=e,this.hasAudio=t}},{key:"setByteRange",value:function(e,t){this.byteRange=[0];var r=e.split("@");r.length===1&&t&&t.byteRange?(this.byteRange[0]=t.byteRange[1]||0,this.byteRange[0]&&(this.byteRange[0]+=1)):this.byteRange[0]=parseInt(r[1]),this.byteRange[1]=this.byteRange[0]+parseInt(r[0])-1}}]),n}(),Dn=function(){function n(s){ae(this,n),S(this,"method",""),S(this,"url",""),S(this,"iv",null),S(this,"keyFormat",""),S(this,"keyFormatVersions",""),s instanceof n&&(this.method=s.method,this.url=s.url,this.keyFormat=s.keyFormat,this.keyFormatVersions=s.keyFormatVersions,s.iv&&(this.iv=new Uint8Array(s.iv)))}return se(n,[{key:"clone",value:function(e){var t=new n(this);return e!=null&&t.setIVFromSN(e),t}},{key:"setIVFromSN",value:function(e){if(!this.iv&&this.method==="AES-128"&&typeof e=="number"&&this.url){this.iv=new Uint8Array(16);for(var t=12;t<16;t++)this.iv[t]=e>>8*(15-t)&255}}},{key:"isSegmentEncrypted",value:function(){var e=this.method;return e==="AES-128"}},{key:"isValidKeySystem",value:function(){var e=Nr([ot.CLEAR_KEY,ot.FAIRPLAY,ot.WIDEVINE,ot.PLAYREADY]).indexOf(this.keyFormat)>-1;if(!e)return!1;var t=["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)>-1;return!!t}},{key:"isSupported",value:function(){return this.method?this.isSegmentEncrypted()?!0:!!this.isValidKeySystem():!1}}]),n}(),Ln=function(){function n(s,e,t){ae(this,n),this.msn=s,this.part=e,this.skip=t}return se(n,[{key:"addDirectives",value:function(e){var t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}]),n}(),On=/^#(EXT[^:]*)(?::(.*))?$/,_r=/([^=]+)=(?:"([^"]*)"|([^",]*))(?:,|$)/g,Pn=/^(?:[a-zA-Z0-9+\-.]+:)?\/\//,Rn=/^((?:[a-zA-Z0-9+\-.]+:)?\/\/[^/?#]*)?([^?#]*\/)?/;function In(n){return n.split(/[\r\n]/).map(function(s){return s.trim()}).filter(Boolean)}function Fr(n){var s=n.match(On);if(!(!s||!s[1]))return[s[1].replace("EXT-X-",""),s[2]]}function ke(n){for(var s={},e=_r.exec(n);e;)s[e[1]]=e[2]||e[3],e=_r.exec(n);return s}function $e(n,s){if(!s||!n||Pn.test(n))return n;var e=Rn.exec(s);return e?n[0]==="/"?e[1]+n:e[1]+e[2]+n:n}var Cn={audio:[/^mp4a/,/^vorbis$/,/^opus$/,/^flac$/,/^[ae]c-3$/],video:[/^avc/,/^hev/,/^hvc/,/^vp0?[89]/,/^av1$/],text:[/^vtt$/,/^wvtt/,/^stpp/]};function It(n,s){var e=Cn[n];if(!(!e||!s||!s.length)){for(var t=0;t<e.length;t++)for(var r=0;r<s.length;r++)if(e[t].test(s[r]))return s[r]}}function Mn(n,s){var e;if(s){for(var t in s)if(Object.prototype.hasOwnProperty.call(s,t)&&n[t]!==s[t]){e=t;break}}var r=null;n.DURATION&&(r=parseFloat(n.DURATION),Number.isFinite(r)?n._endDate&&(r=(n._endDate.getTime()-n._startDate.getTime())/1e3):r=null);var i=Un(n.CUE||n["X-CUE"],{pre:!1,post:!1,once:!1});return!!n.ID&&!e&&Number.isFinite(n._startDate.getTime())&&(r===null||r>=0)&&(n.END_ON_NEXT!=="YES"||!!n.CLASS)&&(!n.CUE||!i.pre&&!i.post||i.pre!==i.post)&&(n.CLASS!=="com.apple.hls.interstitial"||"X-ASSET-URI"in n||"X-ASSET-LIST"in n)}function Un(n,s){return(n?n.split(/[ ,]+/):[]).reduce(function(e,t){return e[t.toLowerCase()]=!0,e},s)}function Bn(n,s){for(var e=new En,t=0,r,i=[],a=[];r=n[t++];){var o=Fr(r);if(o){var u=Pe(o,2),l=u[0],c=u[1];if(l==="VERSION")e.version=parseInt(c);else if(l==="MEDIA"&&c){var h=ke(c),d=void 0;switch(h.TYPE){case"AUDIO":d=new wn;break;case"SUBTITLES":d=new Tn;break;default:d=new Kt}d.url=$e(h.URI,s),d.default=h.DEFAULT==="YES",d.autoSelect=h.AUTOSELECT==="YES",d.group=h["GROUP-ID"],d.name=h.NAME,d.lang=h.LANGUAGE,h.CHANNELS&&(d.channels=Number(h.CHANNELS.split("/")[0]),Number.isNaN(d.channels)&&(d.channels=0)),h.TYPE==="AUDIO"&&h.URI&&i.push(d),h.TYPE==="SUBTITLES"&&a.push(d)}else if(l==="STREAM-INF"&&c){var f=new kn,v=ke(c);if(f.bitrate=parseInt(v["AVERAGE-BANDWIDTH"]||v.BANDWIDTH),f.name=v.NAME,f.url=$e(n[t++],s),v.RESOLUTION){var b=v.RESOLUTION.split("x"),m=Pe(b,2),y=m[0],A=m[1];f.width=parseInt(y),f.height=parseInt(A)}if(v.CODECS){var k=v.CODECS.split(/[ ,]+/).filter(Boolean);f.videoCodec=It("video",k),f.audioCodec=It("audio",k),f.textCodec=It("text",k)}f.audioGroup=v.AUDIO,f.subtitleGroup=v.SUBTITLES,e.streams.push(f)}}}return e.streams.forEach(function(w,E){w.id=E}),i.length&&(i.forEach(function(w,E){w.id=E}),e.streams.forEach(function(w){w.audioGroup&&(w.audioStreams=i.filter(function(E){return E.group===w.audioGroup}))})),a.length&&(a.forEach(function(w,E){w.id=E}),e.streams.forEach(function(w){w.subtitleGroup&&(w.subtitleStreams=a.filter(function(E){return E.group===w.subtitleGroup}))})),e}function xn(n,s,e){var t=new An;t.url=s;for(var r=new ut(s),i=null,a=null,o=0,u=0,l=0,c=0,h,d=!1,f=0;h=n[c++];){if(h[0]!=="#"){if(t.lowLatency){u++;continue}r.sn=u,r.cc=l,r.url=$e(h,s),a&&(r.key=a.clone(u)),i&&(r.initSegment=i),t.segments.push(r),r=new ut(s),u++;continue}var v=Fr(h);if(v){var b=Pe(v,2),m=b[0],y=b[1];switch(m){case"VERSION":t.version=parseInt(y);break;case"PLAYLIST-TYPE":t.type=y==null?void 0:y.toUpperCase();break;case"TARGETDURATION":t.targetDuration=parseFloat(y);break;case"PART-INF":{e&&(t.lowLatency=!0);var A=ke(y);A["PART-TARGET"]&&(t.partTargetDuration=parseFloat(A["PART-TARGET"]))}break;case"SERVER-CONTROL":{var k=ke(y);t.canBlockReload=k["CAN-BLOCK-RELOAD"]==="YES",t.partHoldBack=parseFloat(k["PART-HOLD-BACK"]||0),t.canSkipUntil=parseFloat(k["CAN-SKIP-UNTIL"]||0),t.canSkipDateRanges=t.canSkipUntil>0&&k["CAN-SKIP-DATERANGES"]==="YES"}break;case"ENDLIST":d=!0;break;case"MEDIA-SEQUENCE":u=t.startSN=parseInt(y);break;case"DISCONTINUITY-SEQUENCE":l=t.startCC=parseInt(y);break;case"DISCONTINUITY":l++;break;case"BYTERANGE":r.setByteRange(y,t.segments[t.segments.length-1]);break;case"PART":{if(!t.lowLatency)break;var w=ke(y);r.duration=parseFloat(w.DURATION),r.independent=w.INDEPENDENT==="YES",r.sn=u,r.cc=l,r.partIndex=f,r.start=o,r.duration=parseFloat(w.DURATION),o+=r.duration,r.url=$e(w.URI,s),a&&(r.key=a.clone(u)),i&&(r.initSegment=i),t.segments.push(r),r=new ut(s),f++}break;case"PRELOAD-HINT":{var E=ke(y);if(t.preloadHint=E,E.TYPE==="PART"&&E.URI){var B=E.URI.split(".ts")[0].split("-");t.nextSN=B[3],t.nextIndex=B[B.length-1]}}break;case"PROGRAM-DATE-TIME":r.dataTime=y;break;case"EXTINF":{if(t.lowLatency){f=0;break}var R=y.split(","),U=Pe(R,2),N=U[0],G=U[1];r.start=o,r.duration=parseFloat(N),o+=r.duration,r.title=G}break;case"KEY":{var z=ke(y);if(z.METHOD==="NONE"){a=null;break}if(a=new Dn,a.method=z.METHOD,a.url=/^blob:/.test(z.URI)?z.URI:$e(z.URI,s),a.keyFormat=z.KEYFORMAT||"identity",a.keyFormatVersions=z.KEYFORMATVERSIONS,!a.isSupported())throw new Error("encrypt ".concat(z.METHOD,"/").concat(z.KEYFORMAT," is not supported"));if(z.IV){var p=z.IV.slice(2);p=(p.length&1?"0":"")+p,a.iv=new Uint8Array(p.length/2);for(var g=0,_=p.length/2;g<_;g++)a.iv[g]=parseInt(p.slice(g*2,g*2+2),16)}}break;case"MAP":{var D=ke(y);r.url=$e(D.URI,s),D.BYTERANGE&&r.setByteRange(D.BYTERANGE),r.isInitSegment=!0,r.sn=0,a&&(r.key=a.clone(0)),i=r,r=new ut(s)}break;case"SKIP":{var T=ke(y),P=parseInt(T["SKIPPED-SEGMENTS"],10);P<=Number.MAX_SAFE_INTEGER&&(t.skippedSegments+=P,u+=P)}break;case"DATERANGE":{var x=ke(y),H=t.dateRanges[x.ID];x._startDate=H?H._startDate:new Date(x["START-DATE"]);var W=(H==null?void 0:H._endDate)||new Date(x.END_DATE);Number.isFinite(W)&&(x._endDate=W),(Mn(x,H)||t.skippedSegments)&&(t.dateRanges[x.ID]=x)}break}}}t.segments=t.segments.filter(function(oe){return oe.duration!==0});var I=t.segments[t.segments.length-1];return I&&(d&&(I.isLast=!0),t.endSN=I.sn,t.endPartIndex=I.partIndex),d&&(t.live=!1),t.totalDuration=o,t.endCC=l,t}var lt=function(){function n(){ae(this,n)}return se(n,null,[{key:"parse",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;if(!e.includes("#EXTM3U"))throw new Error("Invalid m3u8 file");var i=In(e);return n.isMediaPlaylist(e)?xn(i,t,r):Bn(i,t)}},{key:"isMediaPlaylist",value:function(e){return e.includes("#EXTINF:")||e.includes("#EXT-X-TARGETDURATION:")}}]),n}(),Nn=function(){function n(s){var e=this;ae(this,n),S(this,"_emitOnLoaded",function(u,l){var c=u.response,h=u.options,d=h||{},f=d.firstByteTime,v=d.startTime,b=d.endTime,m=d.contentLength,y=b-v;e.hls.emit(V.SPEED,{time:y,byteLength:m,url:l}),e.hls.emit(V.LOAD_COMPLETE,{url:l,elapsed:y||0}),e.hls.emit(V.TTFB,{url:l,responseUrl:c.url,elapsed:f-v}),e.hls.emit(V.LOAD_RESPONSE_HEADERS,{headers:c.headers,url:l})}),S(this,"_onLoaderRetry",function(u,l){e.hls.emit(X.LOAD_RETRY,{error:te.network(u),retryTime:l})}),this.hls=s,this._timer=null,this._useLowLatency=s.config.useLowLatency;var t=this.hls.config,r=t.retryCount,i=t.retryDelay,a=t.manifestLoadTimeout,o=t.fetchOptions;this._loader=new Ke(J(J({},o),{},{responseType:"text",retry:r,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry})),this._audioLoader=new Ke(J(J({},o),{},{responseType:"text",retry:r,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry})),this._subtitleLoader=new Ke(J(J({},o),{},{responseType:"text",retry:r,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry}))}return se(n,[{key:"load",value:function(){var s=Q(M().mark(function t(r,i,a){var o,u,l,c,h,d,f,v,b,m,y,A,k,w,E,B,R,U,N,G;return M().wrap(function(p){for(;;)switch(p.prev=p.next){case 0:return o=[this._loader.load(r)],i&&o.push(this._audioLoader.load(i)),a&&o.push(this._subtitleLoader.load(a)),p.prev=3,p.next=6,Promise.all(o);case 6:if(v=p.sent,b=Pe(v,3),m=b[0],y=b[1],A=b[2],m){p.next=13;break}return p.abrupt("return",[]);case 13:this._emitOnLoaded(m,r),u=m.data,h=m.response.url||r,i?(l=y==null?void 0:y.data,c=A==null?void 0:A.data,d=(y==null||(k=y.response)===null||k===void 0?void 0:k.url)||i,f=(A==null||(w=A.response)===null||w===void 0?void 0:w.url)||a,l&&this._emitOnLoaded(y,i),c&&this._emitOnLoaded(A,a)):(c=y==null?void 0:y.data,f=(y==null||(E=y.response)===null||E===void 0?void 0:E.url)||a,c&&this._emitOnLoaded(y,a)),p.next=22;break;case 19:throw p.prev=19,p.t0=p.catch(3),te.network(p.t0);case 22:if(B=this.hls.config.onPreM3U8Parse,p.prev=23,B&&(u=B(u)||u,l&&(l=B(l,!0)||l),c&&(c=B(c,!0)||c)),R=lt.parse(u,h,this._useLowLatency),!(((G=R)===null||G===void 0?void 0:G.live)===!1&&R.segments&&!R.segments.length)){p.next=28;break}throw new Error("empty segments list");case 28:l&&(U=lt.parse(l,d,this._useLowLatency)),c&&(N=lt.parse(c,f,this._useLowLatency)),p.next=35;break;case 32:throw p.prev=32,p.t1=p.catch(23),new te(q.MANIFEST,q.SUB_TYPES.HLS,p.t1);case 35:return R&&(R.isMaster?this.hls.emit(X.HLS_MANIFEST_LOADED,{playlist:R}):(this._useLowLatency&&(R.canBlockReload?this.deliveryDirectives=new Ln(R.nextSN,R.nextIndex,""):this.deliveryDirectives=null),this.hls.emit(X.HLS_LEVEL_LOADED,{playlist:R}))),p.abrupt("return",[R,U,N]);case 37:case"end":return p.stop()}},t,this,[[3,19],[23,32]])}));function e(t,r,i){return s.apply(this,arguments)}return e}()},{key:"parseText",value:function(e,t){var r=this.hls.config.onPreM3U8Parse,i;try{var a;if(r&&(e=r(e)||e),i=lt.parse(e,t,this._useLowLatency),((a=i)===null||a===void 0?void 0:a.live)===!1&&i.segments&&!i.segments.length)throw new Error("empty segments list")}catch(o){throw new te(q.MANIFEST,q.SUB_TYPES.HLS,o)}return i&&(i.isMaster?this.hls.emit(X.HLS_MANIFEST_LOADED,{playlist:i}):this.hls.emit(X.HLS_LEVEL_LOADED,{playlist:i})),[i]}},{key:"poll",value:function(e,t,r,i,a,o){var u=this;clearTimeout(this._timer),o=o||3e3;var l=this.hls.config.pollRetryCount,c=function(){var h=Q(M().mark(function d(){var f,v;return M().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return clearTimeout(u._timer),f=e,m.prev=2,u.deliveryDirectives&&(f=u.deliveryDirectives.addDirectives(e)),m.next=6,u.load(f,t,r);case 6:if(v=m.sent,v[0]){m.next=9;break}return m.abrupt("return");case 9:l=u.hls.config.pollRetryCount,i(v[0],v[1],v[2]),m.next=17;break;case 13:m.prev=13,m.t0=m.catch(2),l--,l<=0&&a(m.t0);case 17:u._timer=setTimeout(c,o);case 18:case"end":return m.stop()}},d,null,[[2,13]])}));return function(){return h.apply(this,arguments)}}();this._timer=setTimeout(c,o)}},{key:"stopPoll",value:function(){return clearTimeout(this._timer),this.cancel()}},{key:"cancel",value:function(){return Promise.all([this._loader.cancel(),this._audioLoader.cancel()])}}]),n}();function Vr(n,s,e){return s>e&&(e=s),Math.min(Math.max(n,s),e)}var Ct=new De("playlist"),Sr=function(){function n(s,e,t){ae(this,n),S(this,"live",void 0),S(this,"id",0),S(this,"bitrate",0),S(this,"width",0),S(this,"height",0),S(this,"name",""),S(this,"url",""),S(this,"audioCodec",""),S(this,"videoCodec",""),S(this,"textCodec",""),S(this,"startCC",0),S(this,"endCC",0),S(this,"startSN",0),S(this,"endSN",-1),S(this,"totalDuration",0),S(this,"targetDuration",0),S(this,"partTargetDuration",0),S(this,"canSkipUntil",0),S(this,"canSkipDateRanges",!1),S(this,"skippedSegments",0),S(this,"canBlockReload",!1),S(this,"partHoldBack",0),S(this,"lowLatency",!1),S(this,"endPartIndex",0),S(this,"snDiff",null),S(this,"segments",[]),S(this,"audioStreams",[]),S(this,"subtitleStreams",[]),S(this,"closedCaptions",[]),S(this,"currentAudioStream",null),S(this,"currentSubtitleStream",null),this.update(this._setLLPlaybackPoint(s),e,t)}return se(n,[{key:"lastSegment",get:function(){return this.segments.length?this.segments[this.segments.length-1]:null}},{key:"segmentDuration",get:function(){var e;return this.targetDuration||((e=this.segments[0])===null||e===void 0?void 0:e.duration)||0}},{key:"liveEdge",get:function(){return this.endTime},set:function(e){this.endTime=e}},{key:"endTime",get:function(){var e;return((e=this.lastSegment)===null||e===void 0?void 0:e.end)||0},set:function(e){var t=this.lastSegment;t&&(t.duration=e-t.start)}},{key:"currentSubtitleEndSn",get:function(){var e;return((e=this.currentSubtitleStream)===null||e===void 0?void 0:e.endSN)||0}},{key:"clearOldSegment",value:function(e,t){return this.currentAudioStream&&this._clearSegments(e,t),this._clearSegments(e,t)}},{key:"getAudioSegment",value:function(e){if(!(!e||!this.currentAudioStream)){var t=e.sn-this.snDiff;return this.currentAudioStream.segments.find(function(r){return r.sn===t})}}},{key:"update",value:function(e,t){this.url=e.url,Array.isArray(e.segments)?((this.live===null||this.live===void 0)&&(this.live=e.live),this._updateSegments(e,this),this.startCC=e.startCC,this.endCC=e.endCC,this.startSN=e.startSN,this.endSN=e.endSN||-1,this.totalDuration=e.totalDuration,this.targetDuration=e.targetDuration,this.live=e.live,this.lowLatency=e.lowLatency,this.canBlockReload=e.canBlockReload,this.canSkipDateRanges=e.canSkipDateRanges,this.canSkipUntil=e.canSkipUntil,this.partHoldBack=e.partHoldBack,this.partTargetDuration=e.partTargetDuration,this.skippedSegments=e.skippedSegments,this.endPartIndex=e.endPartIndex,t&&this.currentAudioStream&&Array.isArray(t.segments)&&(this._updateSegments(t,this.currentAudioStream),(this.snDiff===null||this.snDiff===void 0)&&e.segments.length&&t.segments.length&&(this.snDiff=e.segments[0].sn-t.segments[0].sn))):(this.id=e.id,this.bitrate=e.bitrate,this.width=e.width,this.height=e.height,this.name=e.name,this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.textCodec=e.textCodec,this.audioStreams=e.audioStreams,this.subtitleStreams=e.subtitleStreams,!this.currentAudioStream&&this.audioStreams.length&&(this.currentAudioStream=this.audioStreams.find(function(r){return r.default})||this.audioStreams[0]),!this.currentSubtitleStream&&this.subtitleStreams.length&&(this.currentSubtitleStream=this.subtitleStreams.find(function(r){return r.default})||this.subtitleStreams[0]))}},{key:"updateSubtitle",value:function(e){var t=this;if(e&&this.currentSubtitleStream&&Array.isArray(e.segments)){var r=this._updateSegments(e,this.currentSubtitleStream),i=this.currentSubtitleStream.segments;if(i.length>100&&(this.currentSubtitleStream.segments=i.slice(100)),!!r)return r.map(function(a){return{sn:a.sn,url:a.url,duration:a.duration,start:a.start,end:a.end,lang:t.currentSubtitleStream.lang}})}}},{key:"switchSubtitle",value:function(e){var t=this.subtitleStreams.find(function(i){return i.lang===e}),r=this.currentSubtitleStream;t&&(this.currentSubtitleStream=t,r.segments=[])}},{key:"_setLLPlaybackPoint",value:function(e){if(!e.lowLatency||!e.segments.length)return e;for(var t=e.totalDuration-e.partHoldBack,r=e.segments,i=0,a=0,o=r.length;a<o;a++)r[a].start<=t&&r[a].independent&&(i=a);var u=r.slice(i),l=0;return u.forEach(function(c){c.start=l,l=c.end}),e.segments=u,e.totalDuration=l,e.startSN=u[0].sn,e.startCC=u[0].cc,Ct.log("set ll-hls playback point: SN=".concat(e.startSN," partIndex=").concat(u[0].partIndex,", duration=").concat(l)),e}},{key:"_clearSegments",value:function(e,t){for(var r=0,i=this.segments,a=0,o=i.length;a<o;a++)if(i[a].end>=e){r=a;break}return r>t&&(r=t),r&&(this.segments=this.segments.slice(r),this.currentAudioStream&&(this.currentAudioStream.segments=this.currentAudioStream.segments.slice(r))),t-r}},{key:"_updateSegments",value:function(e,t){var r=t.segments;if(this.live){var i,a=e.lowLatency,o=r[r.length-1],u=(i=o==null?void 0:o.sn)!==null&&i!==void 0?i:-1,l=(o==null?void 0:o.partIndex)||0,c=u<e.endSN&&e.segments.length;if(a&&(c=c||l<e.endPartIndex),c){Ct.log("update segments: endSN:".concat(u,", partIndex:").concat(l," --> endSN:").concat(e.endSN,", partIndex:").concat(e.endPartIndex));var h=e.segments.findIndex(function(m){return m.sn===u&&m.partIndex===l}),d=h<0?e.segments:e.segments.slice(h+1);if(r.length&&d.length){var f=o.end,v=f;d.forEach(function(m){m.start=f,f=m.end}),Ct.log("liveEdge: ".concat(v," -> ").concat(f));var b=(o==null?void 0:o.cc)||-1;b>d[0].cc&&d.forEach(function(m){return m.cc+=b})}return t.endSN=e.endSN,t.segments=r.concat(d),d}}else t.segments=e.segments}}]),n}(),Fn=function(){function n(s){ae(this,n),S(this,"streams",[]),S(this,"currentStream",null),S(this,"dvrWindow",0),S(this,"_segmentPointer",-1),this.hls=s}return se(n,[{key:"lowLatency",get:function(){var e;return(e=this.currentStream)===null||e===void 0?void 0:e.lowLatency}},{key:"lastSegment",get:function(){var e;return(e=this.currentStream)===null||e===void 0?void 0:e.lastSegment}},{key:"currentSegment",get:function(){var e;return(e=this.currentSegments)===null||e===void 0?void 0:e[this._segmentPointer]}},{key:"nextSegment",get:function(){var e;return(e=this.currentSegments)===null||e===void 0?void 0:e[this._segmentPointer+1]}},{key:"currentSegments",get:function(){var e;return(e=this.currentStream)===null||e===void 0?void 0:e.segments}},{key:"currentSubtitleEndSn",get:function(){var e;return(e=this.currentStream)===null||e===void 0?void 0:e.currentSubtitleEndSn}},{key:"liveEdge",get:function(){var e;return(e=this.currentStream)===null||e===void 0?void 0:e.liveEdge},set:function(e){this.currentStream&&(this.currentStream.liveEdge=e)}},{key:"totalDuration",get:function(){var e;return((e=this.currentStream)===null||e===void 0?void 0:e.totalDuration)||0}},{key:"seekRange",get:function(){var e=this.currentSegments;if(!(!e||!e.length))return[e[0].start,e[e.length-1].end]}},{key:"nbSegments",get:function(){var e;return((e=this.currentSegments)===null||e===void 0?void 0:e.length)||0}},{key:"isEmpty",get:function(){var e;return!((e=this.currentSegments)!==null&&e!==void 0&&e.length)}},{key:"isLive",get:function(){var e;return(e=this.currentStream)===null||e===void 0?void 0:e.live}},{key:"hadSegmentLoaded",get:function(){return this._segmentPointer!==-1}},{key:"hasSubtitle",get:function(){var e;return!!((e=this.currentStream)!==null&&e!==void 0&&e.currentSubtitleStream)}},{key:"getAudioSegment",value:function(e){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.getAudioSegment(e)}},{key:"moveSegmentPointer",value:function(e){var t;e==null&&(e=this._segmentPointer+1),this._segmentPointer=Vr(e,-1,(t=this.currentSegments)===null||t===void 0?void 0:t.length)}},{key:"reset",value:function(){this.streams=[],this.currentStream=null,this.dvrWindow=0,this._segmentPointer=-1}},{key:"getSegmentByIndex",value:function(e){var t;return(t=this.currentSegments)===null||t===void 0?void 0:t[e]}},{key:"setNextSegmentByIndex",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;this._segmentPointer=e-1}},{key:"setNextSegmentBySN",value:function(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,r=(e=this.currentSegments)===null||e===void 0?void 0:e.findIndex(function(i){return i.sn===t});return r!==-1&&this.setNextSegmentByIndex(r+1),r}},{key:"findSegmentIndexByTime",value:function(e){var t=this.currentSegments;if(t){for(var r=0,i=t.length,a;r<i;r++)if(a=t[r],e>=a.start&&e<a.end)return r;var o=t[t.length-1];if(Math.abs(e-(o==null?void 0:o.end))<.2)return t.length-1}}},{key:"upsertPlaylist",value:function(e,t,r){var i=this;if(e){if(e.isMaster)this.streams.length=e.streams.length,e.streams.filter(function(l){return l.url}).forEach(function(l,c){i.streams[c]?i.streams[c].update(l):i.streams[c]=new Sr(l)}),this.currentStream=this.streams[0];else if(Array.isArray(e.segments)){var a=this.currentStream;if(a){a.update(e,t,r);var o=a.updateSubtitle(r);o&&this.hls.emit(X.SUBTITLE_SEGMENTS,{list:o})}else this.reset(),this.currentStream=this.streams[0]=new Sr(e,t,r)}var u=this.currentStream;u&&this.hls.isLive&&!this.dvrWindow&&(this.dvrWindow=this.currentSegments.reduce(function(l,c){return l+=c.duration,l},0))}}},{key:"updateSegmentsRanges",value:function(e,t){var r,i=(r=this.currentSegments)===null||r===void 0?void 0:r.filter(function(a){return a.sn>=e});i.forEach(function(a){a.start=t,t=a.end})}},{key:"switchSubtitle",value:function(e){var t;(t=this.currentStream)===null||t===void 0||t.switchSubtitle(e)}},{key:"clearOldSegment",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.hls.config.maxPlaylistSize||50,t=this.currentStream;if(!(!this.dvrWindow||!t)){var r=t.endTime-this.dvrWindow;if(!(r<=0)){var i=t.segments;i.length<=e||(this._segmentPointer=t.clearOldSegment(r,this._segmentPointer))}}}},{key:"checkSegmentTrackChange",value:function(e,t){var r=this.findSegmentIndexByTime(e),i=this.getSegmentByIndex(r);if(i&&!(!i.hasAudio&&!i.hasVideo)){if(t!==2&&i.hasAudio&&i.hasVideo)return i;if(!(i.end-e>.3)){var a=this.getSegmentByIndex(r+1);if(a&&!(!a.hasAudio&&!a.hasVideo)&&(a.hasAudio!==i.hasAudio||a.hasVideo!==i.hasVideo))return a}}}},{key:"feedbackLiveEdge",value:function(e,t){var r,i=this.currentSegments;if(i){var a=((r=this.lastSegment)===null||r===void 0?void 0:r.sn)===e.sn;if(a){this.liveEdge=t;return}this.updateSegmentsRanges(e.sn+1,t)}}}]),n}(),Vn=function(){function n(s){var e=this;ae(this,n),S(this,"error",null),S(this,"_emitOnLoaded",function(u,l){var c=u.data,h=u.response,d=u.options,f=d||{},v=f.firstByteTime,b=f.startTime,m=f.endTime,y=f.contentLength,A=m-b;e._bandwidthService.addRecord(y||c.byteLength,A),e.hls.emit(V.SPEED,{time:A,byteLength:y,url:l}),e.hls.emit(V.LOAD_COMPLETE,{url:l,elapsed:A||0}),e.hls.emit(V.TTFB,{url:l,responseUrl:h.url,elapsed:v-b}),e.hls.emit(V.LOAD_RESPONSE_HEADERS,{headers:h.headers,url:l})}),S(this,"_onLoaderRetry",function(u,l){e.hls.emit(V.LOAD_RETRY,{error:te.network(u),retryTime:l})}),this.hls=s,this._bandwidthService=new Ci,this._mapCache={},this._keyCache={};var t=this.hls.config,r=t.retryCount,i=t.retryDelay,a=t.loadTimeout,o=t.fetchOptions;this._segmentLoader=new Ke(J(J({},o),{},{responseType:"arraybuffer",retry:r,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry})),this._audioSegmentLoader=new Ke(J(J({},o),{},{responseType:"arraybuffer",retry:r,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry})),this._keyLoader=new Ke(J(J({},o),{},{responseType:"arraybuffer",retry:r,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry}))}return se(n,[{key:"speedInfo",value:function(){return{speed:this._bandwidthService.getLatestSpeed(),avgSpeed:this._bandwidthService.getAvgSpeed()}}},{key:"load",value:function(e,t,r){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:r,a=[];return e&&(a[0]=this.loadVideoSegment(e,r)),t&&(a[1]=this.loadAudioSegment(t,i)),Promise.all(a)}},{key:"loadVideoSegment",value:function(e,t){return this._loadSegment(this._segmentLoader,e,t)}},{key:"loadAudioSegment",value:function(e,t){return this._loadSegment(this._audioSegmentLoader,e,t)}},{key:"_loadSegment",value:function(){var s=Q(M().mark(function t(r,i,a){var o=this,u,l,c,h,d,f,v,b,m,y,A,k,w,E,B;return M().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:return v=[],this.hls.emit(V.LOAD_START,{url:i.url}),v[0]=r.load(i.url),a&&i.initSegment&&(m=i.initSegment.url,l=this._mapCache[m],l||(this.hls.emit(V.LOAD_START,{url:m}),v[1]=r.load(m).then(function(N){if(N){var G=Object.keys(o._mapCache);G>30&&(o._mapCache={}),l=o._mapCache[m]=N.data,o._emitOnLoaded(N,m)}})),y=(b=i.initSegment.key)===null||b===void 0?void 0:b.url,y&&(f=i.initSegment.key.iv,d=this._keyCache[y],d||(this.hls.emit(V.LOAD_START,{url:y}),v[2]=this._keyLoader.load(y).then(function(N){N&&(d=o._keyCache[y]=N.data,o._emitOnLoaded(N,y))})))),A=(u=i.key)===null||u===void 0?void 0:u.url,A&&i.key.isSegmentEncrypted()&&(h=i.key.iv,c=this._keyCache[A],c||(this.hls.emit(V.LOAD_START,{url:A}),v[3]=this._keyLoader.load(A).then(function(N){N&&(c=o._keyCache[A]=N.data,o._emitOnLoaded(N,A))}))),U.next=8,Promise.all(v);case 8:if(k=U.sent,w=Pe(k,1),E=w[0],E){U.next=13;break}return U.abrupt("return");case 13:return B=E.data,this._emitOnLoaded(E,i.url),U.abrupt("return",{data:B,map:l,key:c,mapKey:d,keyIv:h,mapKeyIv:f});case 16:case"end":return U.stop()}},t,this)}));function e(t,r,i){return s.apply(this,arguments)}return e}()},{key:"reset",value:function(){this.error=null,this._mapCache={},this._keyCache={},this._bandwidthService.reset()}},{key:"cancel",value:function(){var s=Q(M().mark(function t(){return M().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,Promise.all([this._keyLoader.cancel(),this._segmentLoader.cancel(),this._audioSegmentLoader.cancel()]);case 2:case"end":return i.stop()}},t,this)}));function e(){return s.apply(this,arguments)}return e}()}]),n}(),fe=new De("hls"),Ye=function(n){yt(e,n);var s=_t(e);function e(t){var r;return ae(this,e),r=s.call(this),S(K(r),"version",e.version),S(K(r),"media",null),S(K(r),"config",null),S(K(r),"_manifestLoader",null),S(K(r),"_segmentLoader",null),S(K(r),"_playlist",null),S(K(r),"_bufferService",null),S(K(r),"_gapService",null),S(K(r),"_seiService",null),S(K(r),"_stats",null),S(K(r),"_prevSegSn",null),S(K(r),"_prevSegCc",null),S(K(r),"_tickTimer",null),S(K(r),"_tickInterval",500),S(K(r),"_segmentProcessing",!1),S(K(r),"_reloadOnPlay",!1),S(K(r),"_switchUrlOpts",null),S(K(r),"_isProcessQuotaExceeded",!1),S(K(r),"_loadSegment",Q(M().mark(function i(){var a,o,u,l,c,h,d,f,v;return M().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:if(!(r._segmentProcessing||!r.media)){m.next=2;break}return m.abrupt("return");case 2:if(a=r._playlist,o=a.nextSegment,u=a.lastSegment,l=K(r),c=l.config,h=.016,d=Math.min(Math.max((u==null?void 0:u.duration)-h/2||0,h),.1),o){m.next=8;break}return m.abrupt("return");case 8:if(r.isLive){m.next=18;break}if(f=r.bufferInfo(),r.media.paused&&!r.media.currentTime&&(f=r.bufferInfo(f.nextStart||.5)),v=Math.abs(f.end-r.media.duration)<d,!(f.remaining>=c.preloadTime||v)){m.next=15;break}return r._tryEos(),m.abrupt("return");case 15:if(!(c.preferMMSStreaming&&!r._bufferService.msStreaming)){m.next=17;break}return m.abrupt("return");case 17:!r._urlSwitching&&r._prevSegSn!==o.sn-1&&f.end&&Math.abs(o.start-f.end)>1&&r._playlist.setNextSegmentByIndex(r._playlist.findSegmentIndexByTime(f.end+.1));case 18:return m.abrupt("return",r._loadSegmentDirect());case 19:case"end":return m.stop()}},i)}))),S(K(r),"_onLoadeddata",function(){r.isLive&&!r.config.mseLowLatency&&r.media.duration!==1/0&&r._bufferService.updateDuration(1/0).catch(function(i){})}),S(K(r),"_onPlay",Q(M().mark(function i(){return M().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!(r.media.seeking&&r.media.currentTime===0)){o.next=3;break}return fe.debug("replay currentTime 0, return"),o.abrupt("return");case 3:if(clearTimeout(r._disconnectTimer),!r._reloadOnPlay){o.next=9;break}r._reloadOnPlay=!1,r.replay(!0),o.next=12;break;case 9:return o.next=11,r._loadSegment();case 11:r._startTick();case 12:case"end":return o.stop()}},i)}))),S(K(r),"_onPause",function(){if(r.isLive){if(!r._reloadOnPlay){var i=r.config.disconnectTime;if(i==null&&(i=r._playlist.dvrWindow),!Number.isFinite(i))return;clearTimeout(r._disconnectTimer),r._disconnectTimer=setTimeout(function(){r._reloadOnPlay=!0,r._clear()},i||0)}}else r._stopTick()}),S(K(r),"_onSeeking",Q(M().mark(function i(){var a,o,u,l,c,h,d;return M().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if(r.media){v.next=2;break}return v.abrupt("return");case 2:if(r._onCheckQuotaExceeded(),a=r.media.currentTime,o=r._playlist.seekRange,!o){v.next=10;break}if(u=Vr(a,o[0],r.isLive?o[1]:r.media.duration),!(u>=0&&Math.abs(a-u)>=.1)){v.next=10;break}return r.media.currentTime=u,v.abrupt("return");case 10:if(l=r._playlist.currentSegment,c=me.info(me.get(r.media),a,.1),!l){v.next=17;break}if(!(c.end&&Math.abs(c.end-l.end)<.2)){v.next=15;break}return v.abrupt("return");case 15:if(!(r.isLive&&c.end)){v.next=17;break}return v.abrupt("return");case 17:if(h=r._playlist.findSegmentIndexByTime(a),d=r._playlist.getSegmentByIndex(h),!(h==null||!d||r._segmentProcessing&&d===r._playlist.nextSegment)){v.next=21;break}return v.abrupt("return");case 21:return fe.debug("seek to",a,d),r._playlist.setNextSegmentByIndex(h),r._stopTick(),v.next=26,r._segmentLoader.cancel();case 26:if(r._segmentProcessing=!1,!(!c.end||r.isLive)){v.next=30;break}return v.next=30,r._loadSegmentDirect(!0);case 30:r._startTick();case 31:case"end":return v.stop()}},i)}))),S(K(r),"_onTimeupdate",function(){if(r.media){var i=r.config;if(i.isLive&&i.maxLatency&&i.targetLatency){var a=r._playlist.liveEdge;if(!a)return;var o=a-r.media.currentTime;o>=i.maxLatency&&(fe.debug("latency jump, currentTime:".concat(r.media.currentTime,", liveEdge:").concat(a,",  latency=").concat(o)),r.media.currentTime=a-i.targetLatency)}if(i.seiInTime){var u;(u=r._seiService)===null||u===void 0||u.throw(r.media.currentTime)}i.allowedStreamTrackChange&&!i.softDecode&&r.media.readyState&&r._checkStreamTrackChange(r.media.currentTime)}}),S(K(r),"_tick",function(){if(r.media){r._startTick();var i=r.media,a=r._segmentLoader.error;if(r._onCheckQuotaExceeded(),r._isProcessQuotaExceeded&&(r._bufferService.isFull()||(r._isProcessQuotaExceeded=!1,r._segmentProcessing=!1)),a){var o=.5;(!i.readyState||r.bufferInfo(o).remaining<1)&&(a.fatal=!0,r._emitError(te.network(a)));return}i.readyState&&(Ti(i)?(r._loadSegment(),r._gapService&&r._gapService.do(i,r.config.maxJumpDistance,r.isLive)):i.readyState<2&&r._gapService&&r._gapService.do(i,r.config.maxJumpDistance,i.currentTime?r.isLive:!0)),r.isLive||r._tryEos()}}),r.config=t=bn(t),r.media=r.config.media,r._manifestLoader=new Nn(K(r)),r._segmentLoader=new Vn(K(r)),r._playlist=new Fn(K(r)),r._bufferService=new Sn(K(r)),t.seiInTime&&(r._seiService=new Li(K(r))),t.softDecode||(r._gapService=new Di),r._stats=new Mi(K(r),9e4),r.media.addEventListener("loadeddata",r._onLoadeddata),r.media.addEventListener("play",r._onPlay),r.media.addEventListener("pause",r._onPause),r.media.addEventListener("seeking",r._onSeeking),r.media.addEventListener("timeupdate",r._onTimeupdate),r}return se(e,[{key:"isLive",get:function(){return this._playlist.isLive}},{key:"streams",get:function(){return this._playlist.streams}},{key:"currentStream",get:function(){return this._playlist.currentStream}},{key:"hasSubtitle",get:function(){return this._playlist.hasSubtitle}},{key:"totalDuration",get:function(){return this._playlist.totalDuration}},{key:"baseDts",get:function(){var r;return(r=this._bufferService)===null||r===void 0?void 0:r.baseDts}},{key:"abrSwitchPoint",get:function(){var r=this._urlSwitching?this._playlist.currentSegment:this._playlist.nextSegment;return r?r.start+r.duration/2:null}},{key:"speedInfo",value:function(){return this._segmentLoader.speedInfo()}},{key:"bufferInfo",value:function(){var r,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:.1;return me.info(me.get(this.media),(r=this.media)===null||r===void 0?void 0:r.currentTime,i)}},{key:"getStats",value:function(){return this._stats.getStats()}},{key:"playbackQuality",value:function(){return ki(this.media)}},{key:"load",value:function(){var t=Q(M().mark(function i(){var a,o,u,l=arguments;return M().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return a=l.length>0&&l[0]!==void 0?l[0]:"",o=l.length>1&&l[1]!==void 0?l[1]:{},u=typeof o=="boolean"?o:!!(o!=null&&o.reuseMse),Xe(o)==="object"&&o!==null&&o!==void 0&&o.clearSwitchStatus&&(this._urlSwitching=!1,this._switchUrlOpts=null,this.config.startTime=void 0),a&&(this.config.url=a),a=this.config.url,h.next=8,this._reset(u);case 8:return h.next=10,this._loadData(a);case 10:this._startTick();case 11:case"end":return h.stop()}},i,this)}));function r(){return t.apply(this,arguments)}return r}()},{key:"_loadData",value:function(){var t=Q(M().mark(function i(a){var o,u,l,c,h,d,f,v,b,m,y,A,k;return M().wrap(function(E){for(;;)switch(E.prev=E.next){case 0:try{a&&(a=a.trim())}catch{}if(a){E.next=3;break}throw this._emitError(new te(q.OTHER,q.SUB_TYPES.OPTION,null,null,"m3u8 url is missing"));case 3:return E.next=5,this._loadM3U8(a);case 5:if(o=E.sent,u=this._playlist.currentStream,!this._urlSwitching){E.next=23;break}if(!this.isLive){E.next=14;break}l=this._playlist.setNextSegmentBySN(this._prevSegSn),fe.log("segment nb=".concat(this._prevSegSn," index of ").concat(l," in the new playlist")),l===-1&&(this._prevSegCc=null,this._prevSegSn=null),E.next=23;break;case 14:if(u.bitrate===0&&(c=this._switchUrlOpts)!==null&&c!==void 0&&c.bitrate&&(u.bitrate=(f=this._switchUrlOpts)===null||f===void 0?void 0:f.bitrate),v=typeof((h=this._switchUrlOpts)===null||h===void 0?void 0:h.startTime)=="number"?(d=this._switchUrlOpts)===null||d===void 0?void 0:d.startTime:this._getSeamlessSwitchPoint(),this.config.startTime=v,b=this._playlist.findSegmentIndexByTime(v),m=this._playlist.getSegmentByIndex(b+1),!m){E.next=23;break}return y=m.start,E.next=23,this._bufferService.removeBuffer(y);case 23:if(o){E.next=25;break}return E.abrupt("return");case 25:if(!this.isLive){E.next=36;break}if(this._bufferService.setLiveSeekableRange(0,4294967295),fe.log("totalDuration first time got:",this._playlist.totalDuration),fe.log("nb segments got:",this._playlist.nbSegments),this.config.targetLatency<this._playlist.totalDuration&&(this.config.targetLatency=this._playlist.totalDuration,this.config.maxLatency=1.5*this.config.targetLatency),o.isMaster||this._pollM3U8(a),!(this._playlist.nbSegments<this.config.minSegmentsStartPlay)){E.next=33;break}return E.abrupt("return");case 33:return E.next=35,this._loadSegment();case 35:return E.abrupt("return");case 36:return E.next=38,this._bufferService.updateDuration(u.totalDuration);case 38:return A=this.config.startTime,A&&((k=this._switchUrlOpts)!==null&&k!==void 0&&k.seamless||(this.media.currentTime=A),this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(A)||0)),E.next=42,this._loadSegment();case 42:case"end":return E.stop()}},i,this)}));function r(i){return t.apply(this,arguments)}return r}()},{key:"replay",value:function(){var t=Q(M().mark(function i(a){return M().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return this.config.startTime=0,this._urlSwitching=!1,this._switchUrlOpts=null,u.next=5,this.load();case 5:return this._reloadOnPlay=!1,u.abrupt("return",this.media.play(!a));case 7:case"end":return u.stop()}},i,this)}));function r(i){return t.apply(this,arguments)}return r}()},{key:"switchURL",value:function(){var t=Q(M().mark(function i(a){var o,u,l,c,h,d,f,v=arguments;return M().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:o=v.length>1&&v[1]!==void 0?v[1]:{},u={seamless:!1,startTime:0,bitrate:0},m.t0=Xe(o),m.next=m.t0==="number"?5:m.t0==="boolean"?7:m.t0==="object"?9:11;break;case 5:return o={startTime:o},m.abrupt("break",12);case 7:return o={seamless:o},m.abrupt("break",12);case 9:for(l in o)(o[l]===void 0||o[l]===null)&&delete o[l];return m.abrupt("break",12);case 11:throw"unsupported switchURL args: ".concat(o);case 12:if(o=Object.assign({},u,o),c=o,h=c.seamless,d=c.startTime,this.config.url=a,this.config.startTime=d,this._switchUrlOpts=o,h){m.next=38;break}if(m.prev=18,!this.config.softDecode){m.next=23;break}m.t1=this.load(a),m.next=26;break;case 23:return m.next=25,this.load(a);case 25:m.t1=m.sent;case 26:f=m.t1,m.next=33;break;case 29:throw m.prev=29,m.t2=m.catch(18),this.emit(X.SWITCH_URL_FAILED,m.t2),m.t2;case 33:return this._reloadOnPlay=!1,f&&this.emit(X.SWITCH_URL_SUCCESS,{url:a}),m.abrupt("return",this.media.play(!0));case 38:return this._urlSwitching=!0,this.isLive||(this._prevSegSn=null,this._prevSegCc=null),this._playlist.reset(),this._bufferService.seamlessSwitch(),m.next=44,this._clear();case 44:return m.next=46,this._loadData(a);case 46:this._startTick();case 47:this._switchUrlOpts=null;case 48:case"end":return m.stop()}},i,this,[[18,29]])}));function r(i){return t.apply(this,arguments)}return r}()},{key:"switchStream",value:function(){var t=Q(M().mark(function i(a){var o,u,l,c,h,d=arguments;return M().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if(o=d.length>1&&d[1]!==void 0?d[1]:!0,u=this.currentStream,l=this.streams,!(!u||u.id===a||!l||l.length<2)){v.next=5;break}return v.abrupt("return");case 5:if(c=l.find(function(b){return b.id===a}),c){v.next=8;break}return v.abrupt("return");case 8:return v.prev=8,v.next=11,this._clear();case 11:if(!o){v.next=14;break}return v.next=14,this._bufferService.clearAllBuffer();case 14:v.next=19;break;case 16:throw v.prev=16,v.t0=v.catch(8),this._emitError(te.create(v.t0));case 19:if(u.currentAudioStream&&c.audioStreams.length>2&&(h=u.currentAudioStream.id,c.currentAudioStream=c.audioStreams.find(function(b){return b.id===h})||c.currentAudioStream),this._playlist.currentStream=c,v.prev=21,!(this.isLive||!c.segments.length)){v.next=25;break}return v.next=25,this._refreshM3U8();case 25:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,v.next=29,this._loadSegmentDirect();case 29:v.next=35;break;case 31:throw v.prev=31,v.t1=v.catch(21),this._playlist.currentStream=u,v.t1;case 35:return this._startTick(),v.abrupt("return",c);case 37:case"end":return v.stop()}},i,this,[[8,16],[21,31]])}));function r(i){return t.apply(this,arguments)}return r}()},{key:"switchAudioStream",value:function(){var t=Q(M().mark(function i(a){var o,u,l,c,h=arguments;return M().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(o=h.length>1&&h[1]!==void 0?h[1]:!0,u=this.currentStream,u){f.next=4;break}return f.abrupt("return");case 4:if(l=u.currentAudioStream,!(!l||l.id===a||u.audioStreams.length<2)){f.next=7;break}return f.abrupt("return");case 7:if(c=u.audioStreams.find(function(v){return v.id===a}),c){f.next=10;break}return f.abrupt("return");case 10:return f.prev=10,f.next=13,this._clear();case 13:if(!o){f.next=16;break}return f.next=16,this._bufferService.clearAllBuffer();case 16:f.next=21;break;case 18:throw f.prev=18,f.t0=f.catch(10),this._emitError(te.create(f.t0));case 21:if(u.currentAudioStream=c,f.prev=22,!(this.isLive||!c.segments.length)){f.next=26;break}return f.next=26,this._refreshM3U8();case 26:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,f.next=30,this._loadSegmentDirect();case 30:f.next=36;break;case 32:throw f.prev=32,f.t1=f.catch(22),u.currentAudioStream=l,f.t1;case 36:return this._startTick(),f.abrupt("return",c);case 38:case"end":return f.stop()}},i,this,[[10,18],[22,32]])}));function r(i){return t.apply(this,arguments)}return r}()},{key:"switchSubtitleStream",value:function(){var t=Q(M().mark(function i(a){return M().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return this._playlist.switchSubtitle(a),u.next=3,this._manifestLoader.stopPoll();case 3:return u.next=5,this._refreshM3U8();case 5:case"end":return u.stop()}},i,this)}));function r(i){return t.apply(this,arguments)}return r}()},{key:"detachMedia",value:function(){var t=Q(M().mark(function i(){return M().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!this._bufferService){o.next=3;break}return o.next=3,this._bufferService.detachMedia();case 3:case"end":return o.stop()}},i,this)}));function r(){return t.apply(this,arguments)}return r}()},{key:"destroy",value:function(){var t=Q(M().mark(function i(){var a;return M().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(this.media){u.next=2;break}return u.abrupt("return");case 2:return this.removeAllListeners(),this._playlist.reset(),this._segmentLoader.reset(),(a=this._seiService)===null||a===void 0||a.reset(),this.media.removeEventListener("loadeddata",this._onLoadeddata),this.media.removeEventListener("play",this._onPlay),this.media.removeEventListener("pause",this._onPause),this.media.removeEventListener("seeking",this._onSeeking),this.media.removeEventListener("timeupdate",this._onTimeupdate),u.next=13,Promise.all([this._clear(),this._bufferService.destroy()]);case 13:this.media=null;case 14:case"end":return u.stop()}},i,this)}));function r(){return t.apply(this,arguments)}return r}()},{key:"_loadM3U8",value:function(){var t=Q(M().mark(function i(a){var o,u,l,c,h,d,f;return M().wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(b.prev=0,c=(u=this.config.manifestList)===null||u===void 0||(l=u.filter(function(m){return m.url===a})[0])===null||l===void 0?void 0:l.manifest,!c){b.next=6;break}b.t0=this._manifestLoader.parseText(c,a),b.next=9;break;case 6:return b.next=8,this._manifestLoader.load(a);case 8:b.t0=b.sent;case 9:h=b.t0,d=Pe(h,1),o=d[0],b.next=17;break;case 14:throw b.prev=14,b.t1=b.catch(0),this._emitError(te.create(b.t1));case 17:if(o){b.next=19;break}return b.abrupt("return");case 19:if(this._playlist.upsertPlaylist(o),!o.isMaster){b.next=24;break}return(f=this._playlist.currentStream.subtitleStreams)!==null&&f!==void 0&&f.length&&this.emit(X.SUBTITLE_PLAYLIST,{list:this._playlist.currentStream.subtitleStreams}),b.next=24,this._refreshM3U8();case 24:return this.emit(X.STREAM_PARSED),b.abrupt("return",o);case 26:case"end":return b.stop()}},i,this,[[0,14]])}));function r(i){return t.apply(this,arguments)}return r}()},{key:"_refreshM3U8",value:function(){var r,i,a=this,o=this._playlist.currentStream;if(!o||!o.url)throw this._emitError(te.create(null,null,new Error("m3u8 url is not defined")));var u=o.url,l=(r=o.currentAudioStream)===null||r===void 0?void 0:r.url,c=(i=o.currentSubtitleStream)===null||i===void 0?void 0:i.url;return this._manifestLoader.load(u,l,c).then(function(h){var d=Pe(h,3),f=d[0],v=d[1],b=d[2];f&&(a._playlist.upsertPlaylist(f,v,b),a.isLive&&a._pollM3U8(u,l,c))}).catch(function(h){throw a._emitError(te.create(h))})}},{key:"_pollM3U8",value:function(r,i,a){var o=this,u=this._playlist.isEmpty,l;if(this._playlist.lowLatency)l=(this._playlist.currentStream.partTargetDuration||0)*1e3;else{var c;l=(((c=this._playlist.lastSegment)===null||c===void 0?void 0:c.duration)||0)*1e3}this._manifestLoader.poll(r,i,a,function(h,d,f){o._playlist.upsertPlaylist(h,d,f),o._playlist.clearOldSegment();var v=h&&u&&!o._playlist.isEmpty;(v||!o._playlist.hadSegmentLoaded&&o._playlist.nbSegments>=o.config.minSegmentsStartPlay)&&o._loadSegment(),u&&(u=o._playlist.isEmpty)},function(h){o._emitError(te.create(h))},l)}},{key:"_loadSegmentDirect",value:function(){var t=Q(M().mark(function i(a){var o,u,l,c,h,d;return M().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if(o=this._playlist.nextSegment,o){v.next=3;break}return v.abrupt("return");case 3:return u=!1,l=null,v.prev=5,this._segmentProcessing=!0,fe.log("load segment, sn:".concat(o.sn,", [").concat(o.start,", ").concat(o.end,"], partIndex:").concat(o.partIndex)),v.next=10,this._reqAndBufferSegment(o,this._playlist.getAudioSegment(o));case 10:u=v.sent,v.next=16;break;case 13:v.prev=13,v.t0=v.catch(5),l=v.t0;case 16:return v.prev=16,this._segmentProcessing=!1,v.finish(16);case 19:if(!l){v.next=26;break}if(!this._bufferService.isFull()){v.next=25;break}return fe.log("load segment, sn:".concat(o.sn,", partIndex:").concat(o.partIndex)),this._segmentProcessing=!0,this._isProcessQuotaExceeded=!0,v.abrupt("return",!1);case 25:return v.abrupt("return",this._emitError(te.create(l)));case 26:return u&&(h=this.bufferInfo().end,this.isLive&&!this.media.seeking&&h&&Math.abs(o.end-h)>1&&(fe.warn("segment: ".concat(o.sn," expected end=").concat(o.end,", real end=").concat(h)),this._playlist.feedbackLiveEdge(o,h)),d=((c=this._playlist.currentStream)===null||c===void 0?void 0:c.url)===o.parentUrl,this._urlSwitching&&!d&&(fe.warn("pre playlist segment appended!"),this._bufferService.seamlessSwitch()),this.isLive&&this._urlSwitching&&d&&(this._urlSwitching=!1,this.emit(X.SWITCH_URL_SUCCESS,{url:this.config.url})),this._playlist.moveSegmentPointer(),o.isLast?this._end():a||this._loadSegment()),v.abrupt("return",u);case 28:case"end":return v.stop()}},i,this,[[5,13,16,19]])}));function r(i){return t.apply(this,arguments)}return r}()},{key:"_reqAndBufferSegment",value:function(){var t=Q(M().mark(function i(a,o){var u,l,c,h,d,f,v,b,m,y,A;return M().wrap(function(w){for(;;)switch(w.prev=w.next){case 0:return l=a?a.cc:o.cc,c=this._prevSegCc!==l,h=[],w.prev=3,w.next=6,this._segmentLoader.load(a,o,c);case 6:h=w.sent,w.next=14;break;case 9:throw w.prev=9,w.t0=w.catch(3),w.t0.fatal=!1,this._segmentLoader.error=w.t0,w.t0;case 14:if(h[0]){w.next=16;break}return w.abrupt("return");case 16:return w.next=18,(u=this._bufferService).decryptBuffer.apply(u,Qr(h));case 18:if(d=w.sent,d){w.next=21;break}return w.abrupt("return");case 21:return f=a?a.sn:o.sn,v=a?a.start:o.start,b=this._playlist.currentStream,this._bufferService.createSource(d[0],d[1],b==null?void 0:b.videoCodec,b==null?void 0:b.audioCodec),m=Date.now(),y=this._prevSegSn===f-1,this.isLive&&this._urlSwitching&&(A=this.bufferInfo().end,this._playlist.updateSegmentsRanges(f,A),fe.warn("update the new playlist liveEdge, segment id=".concat(f,", buffer start=").concat(A,", liveEdge=").concat(this._playlist.liveEdge)),v=A),w.next=30,this._bufferService.appendBuffer(a,o,d[0],d[1],c,y,v);case 30:return this.emit(X.APPEND_COST,{elapsed:Date.now()-m,url:a.url}),w.next=33,this._bufferService.evictBuffer(this.config.bufferBehind);case 33:return this._prevSegCc=l,this._prevSegSn=f,w.abrupt("return",!0);case 36:case"end":return w.stop()}},i,this,[[3,9]])}));function r(i,a){return t.apply(this,arguments)}return r}()},{key:"_onCheckQuotaExceeded",value:function(){var t=Q(M().mark(function i(){var a,o,u,l,c,h;return M().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:a=this.media.currentTime,o=this.media.buffered,u=!1,l=0;case 4:if(!(l<o.length)){f.next=11;break}if(!(o.start(0)>=a&&a<o.end(l))){f.next=8;break}return u=!0,f.abrupt("break",11);case 8:l++,f.next=4;break;case 11:if(!this._bufferService.isFull()){f.next=17;break}if(c=u?this.config.bufferBehind:5,h=this.media.currentTime,!(h-c>0)){f.next=17;break}return f.next=17,this._bufferService.removeBuffer(0,h-c);case 17:case"end":return f.stop()}},i,this)}));function r(){return t.apply(this,arguments)}return r}()},{key:"_checkStreamTrackChange",value:function(r){var i=this._playlist.checkSegmentTrackChange(r,this._bufferService.nbSb);i&&this.switchURL(this.config.url,i.start+.2)}},{key:"_clear",value:function(){var t=Q(M().mark(function i(){return M().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return clearTimeout(this._disconnectTimer),this._stopTick(),o.next=4,Promise.all([this._segmentLoader.cancel(),this._manifestLoader.stopPoll()]);case 4:this._segmentProcessing=!1;case 5:case"end":return o.stop()}},i,this)}));function r(){return t.apply(this,arguments)}return r}()},{key:"_reset",value:function(){var t=Q(M().mark(function i(){var a,o,u=arguments;return M().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return o=u.length>0&&u[0]!==void 0?u[0]:!1,this._reloadOnPlay=!1,this._prevSegSn=null,this._prevSegCc=null,this._switchUrlOpts=null,this._playlist.reset(),this._segmentLoader.reset(),(a=this._seiService)===null||a===void 0||a.reset(),this._stats.reset(),c.next=11,this._clear();case 11:return c.abrupt("return",this._bufferService.reset(o));case 12:case"end":return c.stop()}},i,this)}));function r(){return t.apply(this,arguments)}return r}()},{key:"_end",value:function(){this._clear(),this._bufferService.endOfStream(),(this.media.readyState<=2||this.media.buffered.length>1)&&this._startTick()}},{key:"_stopTick",value:function(){this._tickTimer&&clearTimeout(this._tickTimer),this._tickTimer=null}},{key:"_startTick",value:function(){this._stopTick(),this._tickTimer=setTimeout(this._tick,this._tickInterval)}},{key:"_emitError",value:function(r){var i,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(((i=r.originError)===null||i===void 0?void 0:i.fatal)===!1)fe.warn(r);else{var o,u,l;fe.table(r),fe.error(r),fe.error((o=this.media)===null||o===void 0?void 0:o.error),(u=this.media)!==null&&u!==void 0&&u.readyState&&this.media.pause(),this._stopTick(),this._urlSwitching&&(this._urlSwitching=!1,this.emit(X.SWITCH_URL_FAILED,r)),this.emit(X.ERROR,r),a&&this._end(),(l=this._seiService)===null||l===void 0||l.reset()}return r}},{key:"_getSeamlessSwitchPoint",value:function(){var r=this.media,i=r.currentTime;if(!r.paused){var a,o=this._playlist.findSegmentIndexByTime(r.currentTime),u=this._playlist.getSegmentByIndex(o),l=(a=this._stats)===null||a===void 0?void 0:a.getStats().downloadSpeed;if(l&&u){var c=u.duration*this._playlist.currentStream.bitrate/l+1;i+=c}else i+=5}return i}},{key:"_tryEos",value:function(){var r,i,a=this.media,o=this._playlist,u=o.nextSegment,l=o.lastSegment,c=(!u||l&&me.isBuffered(a,l.start+l.duration/2))&&a.readyState&&a.duration>0&&((r=this._bufferService)===null||r===void 0?void 0:r.msIsOpened)&&!((i=this._bufferService)!==null&&i!==void 0&&i.msHasOpTasks);if(c){var h=this.bufferInfo();a.paused&&!a.currentTime&&(h=this.bufferInfo(h.nextStart||.5));var d=Math.abs(h.end-a.duration)<.1||!this.isLive&&l&&h.end>=l.start+l.duration;d&&this._bufferService.endOfStream()}}}],[{key:"isSupported",value:function(r){return!r||r==="video"||r==="audio"?de.isSupported():typeof WebAssembly<"u"}},{key:"enableLogger",value:function(){De.enable(),mt.enable()}},{key:"disableLogger",value:function(){De.disable(),mt.disable()}}]),e}(gt);S(Ye,"version","3.0.23");try{localStorage.getItem("xgd")?Ye.enableLogger():Ye.disableLogger()}catch{}var Gn=function(){function n(s,e){var t=this;ae(this,n),S(this,"_opts",null),S(this,"_plugin",null),S(this,"_onLowDecode",function(){var r,i,a,o,u=t._opts,l=u.media,c=u.innerDegrade;(r=t._plugin)===null||r===void 0||(i=r.player)===null||i===void 0||i.emit("lowdecode",l.degradeInfo),(a=t._plugin)===null||a===void 0||(o=a.player)===null||o===void 0||o.emit("core_event",J(J({},l.degradeInfo),{},{eventName:X.LOWDECODE})),c===1&&t._degrade(l.src)}),S(this,"_degrade",function(r){var i=t._plugin.player,a=i.video;if(!(a&&a.TAG!=="MVideo")){var o=i.video.degradeVideo;i.video=o,a.degrade(r),r&&(i.config.url=r);var u=i.root.firstChild;u.TAG==="MVideo"&&i.root.replaceChild(o,u);var l=t._plugin.constructor.pluginName.toLowerCase();i.unRegisterPlugin(l),i.once("canplay",function(){i.play()})}}),S(this,"forceDegradeToVideo",function(r){var i=t._opts.innerDegrade;i===1&&t._degrade(r)}),this._opts=s,this._plugin=e,this._init()}return se(n,[{key:"_init",value:function(){var e=this._opts,t=e.media,r=e.preloadTime,i=e.innerDegrade,a=e.isLive;if(t){if(!a&&t.setPlayMode){t.setPlayMode("VOD");return}i&&t.setAttribute("innerdegrade",i),r&&t.setAttribute("preloadtime",r),this._bindEvents()}}},{key:"_bindEvents",value:function(){var e=this._opts.media;e.addEventListener("lowdecode",this._onLowDecode)}},{key:"destroy",value:function(){var e,t;(e=this._opts)===null||e===void 0||(t=e.media)===null||t===void 0||t.removeEventListener("lowdecode",this._onLowDecode),this._plugin=null}}]),n}(),Hn=["currentTime"];function jn(n,s){var e=s.player,t=e.currentTime,r={startTime:t};switch(Xe(n)){case"boolean":r.seamless=n;break;case"object":{var i=n.currentTime,a=Ut(n,Hn);Object.assign(r,a),typeof i=="number"&&(r.startTime=i);break}}return r}var Gr=function(n){yt(e,n);var s=_t(e);function e(){var t;ae(this,e);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return t=s.call.apply(s,[this].concat(i)),S(K(t),"logger",fe),S(K(t),"hls",null),S(K(t),"pluginExtension",null),S(K(t),"getStats",function(){var o;return(o=t.hls)===null||o===void 0?void 0:o.getStats()}),S(K(t),"_onSwitchSubtitle",function(o){var u,l=o.lang;(u=t.hls)===null||u===void 0||u.switchSubtitleStream(l)}),S(K(t),"_keepPauseStatus",function(){var o=t.player.paused;o&&t.player.once("canplay",function(){t.player.pause()})}),t}return se(e,[{key:"core",get:function(){return this.hls}},{key:"version",get:function(){var r;return(r=this.hls)===null||r===void 0?void 0:r.version}},{key:"softDecode",get:function(){var r,i,a=(r=this.player)===null||r===void 0||(i=r.config)===null||i===void 0?void 0:i.mediaType;return!!a&&a!=="video"&&a!=="audio"&&a!=="offscreen-video"}},{key:"beforePlayerInit",value:function(){var r=this,i=this.player.config,a=this.player.media||this.player.video,o=i.hls||{};if(!(!i.url&&!i.__allowHlsEmptyUrl__||!this.softDecode&&!o.preferMMS&&de.isMMSOnly())){this.hls&&this.hls.destroy();var u=Object.getOwnPropertyDescriptor(this.player,"switchURL");(!u||u.writable)&&(this.player.switchURL=function(h,d){return new Promise(function(f,v){var b=r.player,m=r.hls;if(m){var y,A,k=jn(d,r);b.config.url=h,m.switchURL(h,k).then(function(){return f(!0)}).catch(v),!k.seamless&&(y=r.player.config)!==null&&y!==void 0&&(A=y.hls)!==null&&A!==void 0&&A.keepStatusAfterSwitch&&r._keepPauseStatus()}else v()})});var l=this.player.switchURL;if(this.player.handleSource=!1,o.innerDegrade=o.innerDegrade||i.innerDegrade,(o.disconnectTime===null||o.disconnectTime===void 0)&&(o.disconnectTime=0),this.hls=new Ye(J({softDecode:this.softDecode,isLive:i.isLive,media:a,startTime:i.startTime,url:i.url},o)),this.softDecode||Xt.defineGetterOrSetter(this.player,{url:{get:function(){var d,f;return(d=r.hls)===null||d===void 0||(f=d.media)===null||f===void 0?void 0:f.src},configurable:!0}}),this.softDecode&&(this.pluginExtension=new Gn(J({isLive:i.isLive,media:a},o),this),this.player.forceDegradeToVideo=function(){for(var h,d=arguments.length,f=new Array(d),v=0;v<d;v++)f[v]=arguments[v];return(h=r.pluginExtension)===null||h===void 0?void 0:h.forceDegradeToVideo.apply(h,f)}),i.isLive){var c;(c=this.player)===null||c===void 0||c.useHooks("replay",function(){var h;return(h=r.hls)===null||h===void 0?void 0:h.replay()})}this.on(Hr,l),this.on(jr,this._onSwitchSubtitle),this.on(zr,this.destroy.bind(this)),this._transError(),this._transCoreEvent(V.TTFB),this._transCoreEvent(V.LOAD_START),this._transCoreEvent(V.LOAD_RESPONSE_HEADERS),this._transCoreEvent(V.LOAD_COMPLETE),this._transCoreEvent(V.LOAD_RETRY),this._transCoreEvent(V.SOURCEBUFFER_CREATED),this._transCoreEvent(V.MEDIASOURCE_OPENED),this._transCoreEvent(V.APPEND_BUFFER),this._transCoreEvent(V.REMOVE_BUFFER),this._transCoreEvent(V.BUFFEREOS),this._transCoreEvent(V.KEYFRAME),this._transCoreEvent(V.METADATA_PARSED),this._transCoreEvent(V.DEMUXED_TRACK),this._transCoreEvent(V.SEI),this._transCoreEvent(V.SEI_IN_TIME),this._transCoreEvent(V.SPEED),this._transCoreEvent(V.HLS_MANIFEST_LOADED),this._transCoreEvent(V.HLS_LEVEL_LOADED),this._transCoreEvent(V.STREAM_EXCEPTION),this._transCoreEvent(V.SWITCH_URL_SUCCESS),this._transCoreEvent(V.SWITCH_URL_FAILED),this._transCoreEvent(X.NO_AUDIO_TRACK),this._transCoreEvent(X.STREAM_PARSED),this._transCoreEvent(X.SUBTITLE_SEGMENTS),this._transCoreEvent(X.SUBTITLE_PLAYLIST),this._transCoreEvent(X.APPEND_COST),i.url&&this.hls.load(i.url,{reuseMse:!0}).catch(function(h){})}}},{key:"destroy",value:function(){var r;this.hls&&(this.hls.destroy(),this.hls=null),(r=this.pluginExtension)===null||r===void 0||r.destroy(),this.pluginExtension=null}},{key:"_transError",value:function(){var r=this;this.hls.on(X.ERROR,function(i){r.player&&r.player.emit($r,new Kr(r.player,i))})}},{key:"_transCoreEvent",value:function(r){var i=this;this.hls.on(r,function(a){i.player&&(i.player.emit("core_event",J(J({},a),{},{eventName:r})),r===V.SEI_IN_TIME&&i.hls.hasSubtitle&&i._emitSeiPaylodTime(a))})}},{key:"_emitSeiPaylodTime",value:function(r){try{var i=JSON.parse(Array.from(r.data.payload).map(function(a){return String.fromCharCode(a)}).join("").slice(0,-1));if(!i.rtmp_dts)return;this.player.emit("core_event",{eventName:X.SEI_PAYLOAD_TIME,time:i.rtmp_dts})}catch{}}}],[{key:"pluginName",get:function(){return"hls"}},{key:"isSupported",value:function(r,i){return Ye.isSupported(r,i)}}]),e}(Xt);S(Gr,"Hls",Ye);S(Gr,"EVENT",X);export{q as ERR,wt as ERR_CODE,X as EVENT,Ye as Hls,Gr as HlsPlugin,Nn as ManifestLoader,Fn as Playlist,Vn as SegmentLoader,te as StreamingError,Gr as default,bn as getConfig,fe as logger,jn as parseSwitchUrlArgs};
